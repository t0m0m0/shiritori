<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Åó„Çä„Å®„Çä - „Éû„É´„ÉÅ„Éó„É¨„Ç§„É§„Éº</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Antique&family=Shippori+Mincho:wght@400;700&family=Zen+Maru+Gothic:wght@400;500;700&family=DotGothic16&family=RocknRoll+One&family=Kosugi+Maru&family=Shippori+Mincho+B1:wght@400;700&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link id="themeCSS" rel="stylesheet" href="" />
    <script>
      (function () {
        var t = localStorage.getItem("shiritori-theme") || "default";
        document.documentElement.setAttribute("data-theme", t);
        if (t !== "default") {
          document.getElementById("themeCSS").href =
            "/static/themes/" + t + ".css";
        }
      })();
    </script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --primary: #c23a22;
        --primary-light: #d4604c;
        --primary-dark: #a12e18;
        --accent: #3d6b5e;
        --accent-light: #5a8f7e;
        --danger: #b83a2a;
        --success: #3d6b5e;
        --bg: #f5f0e8;
        --surface: #faf7f0;
        --surface2: #ede8dc;
        --text: #2c2420;
        --text2: #8a7e72;
        --text3: #c4b8a8;
        --radius: 4px;
        --shadow: 0 1px 4px rgba(44, 36, 32, 0.08);
        --border: #d8d0c4;
        --font-body: "Zen Maru Gothic", "Hiragino Maru Gothic Pro", sans-serif;
        --font-head: "Shippori Mincho", serif;
        --font-display: "Zen Antique", serif;
      }
      html {
        font-size: 16px;
      }
      body {
        font-family: var(--font-body);
        background: var(--bg);
        background-image:
          radial-gradient(
            ellipse at 20% 50%,
            rgba(194, 58, 34, 0.018) 0%,
            transparent 70%
          ),
          radial-gradient(
            ellipse at 80% 20%,
            rgba(61, 107, 94, 0.018) 0%,
            transparent 70%
          );
        color: var(--text);
        min-height: 100dvh;
        line-height: 1.7;
        position: relative;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.025'/%3E%3C/svg%3E");
      }
      body::after {
        content: "\8A00  \8449  \7E4B  \98A8  \82B1  \6708  \96EA  \9CE5  \5922  \9053  \5FC3  \5149";
        position: fixed;
        bottom: -20%;
        left: 8%;
        pointer-events: none;
        z-index: 0;
        font-family: "Shippori Mincho", serif;
        font-size: 2.2rem;
        letter-spacing: 1.8rem;
        white-space: nowrap;
        color: var(--text);
        opacity: 0;
        animation: driftKanji 60s linear infinite;
      }
      button {
        font-family: inherit;
        cursor: pointer;
        border: none;
        font-size: 0.95rem;
      }
      input,
      select {
        font-family: inherit;
        font-size: 1rem;
      }

      /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes popIn {
        0% {
          transform: scale(0.92);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.03);
        }
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        20%,
        60% {
          transform: translateX(-4px);
        }
        40%,
        80% {
          transform: translateX(4px);
        }
      }
      @keyframes ripple {
        to {
          transform: scale(2.5);
          opacity: 0;
        }
      }
      @keyframes floatUp {
        0% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-50px);
        }
      }
      @keyframes timerPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(184, 58, 42, 0.3);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(184, 58, 42, 0);
        }
      }
      @keyframes wordAppear {
        0% {
          opacity: 0;
          transform: scale(0.88);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes bgShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      @keyframes driftKanji {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 0.04;
        }
        90% {
          opacity: 0.04;
        }
        100% {
          transform: translateY(-100vh) rotate(15deg);
          opacity: 0;
        }
      }

      .fade-in {
        animation: fadeIn 0.4s ease both;
      }
      .slide-up {
        animation: slideUp 0.45s ease both;
      }
      .pop-in {
        animation: popIn 0.35s ease both;
      }

      /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
      .container {
        max-width: 860px;
        margin: 0 auto;
        padding: 1rem;
        position: relative;
        z-index: 1;
      }
      .hidden {
        display: none !important;
      }

      /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
      .header {
        text-align: center;
        padding: 2.5rem 1rem 2rem;
        background: var(--bg);
        color: var(--text);
        position: relative;
        overflow: visible;
        border-bottom: 1px solid var(--border);
      }
      .header::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 5%;
        right: 5%;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(44, 36, 32, 0.12) 4%,
          rgba(44, 36, 32, 0.25) 12%,
          rgba(44, 36, 32, 0.3) 20%,
          rgba(44, 36, 32, 0.15) 32%,
          rgba(44, 36, 32, 0.3) 38%,
          rgba(44, 36, 32, 0.28) 55%,
          transparent 57%,
          rgba(44, 36, 32, 0.3) 60%,
          rgba(44, 36, 32, 0.25) 78%,
          rgba(44, 36, 32, 0.1) 92%,
          transparent 100%
        );
        border-radius: 2px;
      }
      .header h1 {
        font-family: var(--font-head);
        font-size: 2.8rem;
        font-weight: 700;
        letter-spacing: 0.15em;
        color: var(--text);
      }
      .header a {
        color: inherit;
        text-decoration: none;
      }
      .header a:hover {
        opacity: 0.8;
      }
      .header p {
        font-size: 0.85rem;
        color: var(--text2);
        margin-top: 0.4rem;
        letter-spacing: 0.08em;
      }

      /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 1rem;
      }
      .card h2 {
        font-family: var(--font-head);
        font-size: 1.05rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.6rem;
        border-bottom: 1px solid var(--border);
      }
      .card h2::before {
        content: "";
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text2);
        margin-bottom: 0.35rem;
        letter-spacing: 0.03em;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.6rem 0.2rem;
        border: none;
        border-bottom: 1.5px solid var(--border);
        border-radius: 0;
        background: transparent;
        color: var(--text);
        transition: border-color 0.25s;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-bottom-color: var(--primary);
      }
      .form-group select {
        padding: 0.6rem 0;
        cursor: pointer;
        -webkit-appearance: auto;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.6rem 1.4rem;
        border-radius: var(--radius);
        font-weight: 600;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
        letter-spacing: 0.03em;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }
      .btn-accent {
        background: var(--accent);
        color: #fff;
      }
      .btn-accent:hover {
        background: #2f5548;
      }
      .btn-outline {
        background: transparent;
        color: var(--primary);
        border: 1.5px solid var(--primary);
      }
      .btn-outline:hover {
        background: var(--primary);
        color: #fff;
      }
      .btn-danger {
        background: var(--danger);
        color: #fff;
      }
      .btn-danger:hover {
        background: #9a2e1e;
      }
      .btn-lg {
        padding: 0.8rem 2rem;
        font-size: 1.05rem;
      }
      .btn-block {
        width: 100%;
      }
      .btn:active {
        transform: scale(0.98);
      }

      /* ‚îÄ‚îÄ Lobby ‚îÄ‚îÄ */
      #lobby .player-name-section {
        text-align: center;
        padding: 1.5rem 0;
      }
      #lobby .player-name-section input {
        font-family: var(--font-head);
        font-size: 1.4rem;
        text-align: center;
        padding: 0.7rem 0;
        border: none;
        border-bottom: 2px solid var(--border);
        border-radius: 0;
        background: transparent;
        max-width: 320px;
        width: 100%;
        color: var(--text);
        letter-spacing: 0.08em;
      }
      #lobby .player-name-section input::placeholder {
        color: var(--text3);
      }
      #lobby .player-name-section input:focus {
        border-bottom-color: var(--primary);
        outline: none;
        box-shadow: none;
        -webkit-appearance: none;
      }
      /* Extra elements for typo theme ‚Äî hide in default */
      .player-name-desc {
        display: none;
      }
      .player-name-label {
        display: none;
      }
      .player-name-field {
        display: contents;
      }
      .rules-panel {
        display: none;
      }
      .create-room-layout {
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 2.5rem;
      }
      .rules-panel {
        display: block;
        padding-top: 0.5rem;
      }
      .rules-table {
        width: 100%;
        border-collapse: collapse;
        font-family: var(--font-body);
        font-size: 0.85rem;
        font-weight: 400;
      }
      .rules-table td {
        padding: 0.6rem 0;
        border-bottom: 1px solid var(--border);
        color: var(--text2);
      }
      .rules-table .rules-val {
        text-align: right;
        font-weight: 500;
        color: var(--text);
      }
      .rules-table .rules-danger {
        color: var(--danger);
      }
      .rules-desc {
        font-family: var(--font-body);
        font-size: 0.82rem;
        font-weight: 400;
        color: var(--text3);
        line-height: 1.8;
        margin-top: 1.2rem;
      }
      @media (max-width: 700px) {
        .create-room-layout {
          grid-template-columns: 1fr;
        }
      }
      .invite-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        flex-wrap: wrap;
        background: var(--surface);
        border-left: 3px solid var(--primary);
      }
      .invite-card .invite-info {
        font-weight: 600;
        color: var(--text);
      }
      .invite-card .invite-id {
        font-size: 0.9rem;
        color: var(--text2);
      }
      .invite-card .invite-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .invite-card .invite-room-title {
        font-family: var(--font-head);
        font-weight: 700;
        font-size: 1.05rem;
        margin-bottom: 0.35rem;
        color: var(--text);
      }
      .room-list {
        list-style: none;
      }
      .room-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.9rem;
        border-bottom: 1px dotted var(--border);
        margin-bottom: 0;
        transition: all 0.2s;
      }
      .room-item:last-child {
        border-bottom: none;
      }
      .room-item:hover {
        background: var(--surface2);
      }
      .room-info {
        flex: 1;
      }
      .room-name {
        font-family: var(--font-head);
        font-weight: 700;
        font-size: 1rem;
        color: var(--text);
        text-decoration: none;
      }
      .room-name:hover {
        color: var(--primary);
      }
      .room-meta {
        font-size: 0.78rem;
        color: var(--text2);
        margin-top: 0.2rem;
      }
      .room-meta span {
        margin-right: 0.75rem;
      }
      .room-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .no-rooms {
        text-align: center;
        color: var(--text2);
        padding: 2rem;
        font-size: 0.9rem;
      }
      .invite-room-title {
        font-family: var(--font-head);
        font-weight: 700;
        font-size: 1.05rem;
        margin-bottom: 0.4rem;
        color: var(--text);
      }
      .invite-room-rules {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
        margin-bottom: 0.5rem;
      }
      .invite-room-host {
        font-size: 0.85rem;
        color: var(--text2);
        margin-bottom: 0.5rem;
      }

      /* ‚îÄ‚îÄ Game Room ‚îÄ‚îÄ */
      #game {
        position: relative;
      }
      .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
        gap: 0.5rem;
        border-bottom: 1px solid var(--border);
      }
      .room-title {
        font-family: var(--font-head);
        font-weight: 700;
        font-size: 1rem;
        color: var(--text);
      }
      .game-header-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .game-rules {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .rule-badge {
        font-size: 0.72rem;
        padding: 0.2rem 0.55rem;
        border-radius: var(--radius);
        background: var(--surface2);
        color: var(--text2);
        font-weight: 500;
        border: 1px solid var(--border);
      }
      /* Invite view overrides */
      .invite-view #preGame {
        padding: 1.5rem;
      }
      .invite-view #preGame .waiting-text {
        display: none;
      }
      .invite-view #preGame .waiting-players {
        margin-top: 0;
      }
      .invite-view #preGame #startBtn,
      .invite-view #preGame #waitOwnerText {
        display: none !important;
      }
      .invite-view #activeGame {
        display: none !important;
      }
      .invite-view .game-header-actions {
        display: none !important;
      }
      .invite-view .game-body,
      .invite-view .answer-area,
      .invite-view .current-word-area,
      .invite-view .my-lives-display,
      .invite-view #turnIndicator,
      .invite-view #timerSection {
        display: none !important;
      }
      .invite-view .waiting-player-list {
        min-height: 2.5rem;
      }
      .invite-view .waiting-empty {
        color: var(--text2);
        font-size: 0.85rem;
      }
      .invite-lobby #lobbyCreateCard,
      .invite-lobby #lobbyRoomsCard {
        display: none !important;
      }

      /* ‚îÄ‚îÄ Current word area ‚îÄ‚îÄ */
      .current-word-area {
        text-align: center;
        padding: 2.5rem 1rem;
        background: repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2.4rem,
          var(--border) 2.4rem,
          var(--border) calc(2.4rem + 1px)
        );
        background-color: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 1rem;
        position: relative;
      }
      .current-word-label {
        font-size: 0.8rem;
        color: var(--text2);
        margin-bottom: 0.5rem;
        letter-spacing: 0.1em;
      }
      .current-word {
        font-family: var(--font-display);
        font-size: 4rem;
        font-weight: 400;
        color: var(--text);
        animation: wordAppear 0.4s ease both;
        letter-spacing: 0.15em;
        line-height: 1.3;
      }

      /* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
      .timer-bar {
        height: 3px;
        background: var(--surface2);
        border-radius: 1px;
        margin-bottom: 0.75rem;
        overflow: hidden;
      }
      .timer-bar-inner {
        height: 100%;
        background: var(--primary);
        border-radius: 1px;
        transition: width 0.3s linear;
      }
      .timer-bar-inner.warning {
        background: var(--accent);
      }
      .timer-bar-inner.danger {
        background: var(--danger);
        animation: timerPulse 1s infinite;
      }
      .timer-text {
        text-align: center;
        font-family: var(--font-head);
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
        color: var(--text);
      }
      .timer-text.warning {
        color: var(--accent);
      }
      .timer-text.danger {
        color: var(--danger);
      }

      /* ‚îÄ‚îÄ Answer input ‚îÄ‚îÄ */
      .answer-area {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      .answer-area input {
        flex: 1;
        padding: 0.7rem 0.5rem;
        border: none;
        border-bottom: 2px solid var(--border);
        border-radius: 0;
        font-family: var(--font-display);
        font-size: 1.3rem;
        background: transparent;
        color: var(--text);
        transition: all 0.25s;
      }
      .answer-area input::placeholder {
        color: var(--text3);
      }
      .answer-area input:focus {
        border-bottom-color: var(--primary);
        outline: none;
      }
      .answer-area .btn {
        padding: 0.7rem 1.3rem;
        font-size: 1rem;
        min-width: 72px;
      }
      #challengeBtn {
        white-space: nowrap;
      }

      /* ‚îÄ‚îÄ Game layout ‚îÄ‚îÄ */
      .game-body {
        display: grid;
        grid-template-columns: 1fr 240px;
        gap: 1rem;
      }
      @media (max-width: 700px) {
        .game-body {
          grid-template-columns: 1fr;
        }
      }

      /* ‚îÄ‚îÄ History ‚îÄ‚îÄ */
      .history-panel {
      }
      .history-list {
        max-height: 300px;
        overflow-y: auto;
        list-style: none;
      }
      .history-list::-webkit-scrollbar {
        width: 3px;
      }
      .history-list::-webkit-scrollbar-thumb {
        background: var(--text3);
        border-radius: 1px;
      }
      .history-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.55rem 0.5rem;
        border-bottom: 1px dotted var(--border);
        animation: slideUp 0.3s ease both;
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .history-word {
        font-family: var(--font-head);
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text);
      }
      .history-player {
        font-size: 0.78rem;
        color: var(--text2);
      }
      .history-connector {
        font-size: 0.7rem;
        color: var(--text3);
        width: 20px;
        text-align: center;
        flex-shrink: 0;
      }

      /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
      .sidebar {
      }
      .player-list {
        list-style: none;
      }
      .player-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.6rem;
        margin-bottom: 0.2rem;
        transition: background 0.2s;
        border-radius: var(--radius);
      }
      .player-item.current-turn {
        background: var(--surface2);
      }
      .player-item.current-turn .player-name-display::before {
        content: "\25CF ";
        color: var(--primary);
        font-size: 0.6em;
      }
      .player-name-display {
        font-weight: 500;
        font-size: 0.88rem;
      }
      .player-score {
        font-family: var(--font-head);
        font-weight: 700;
        color: var(--primary);
        background: var(--surface2);
        padding: 0.1rem 0.45rem;
        border-radius: var(--radius);
        font-size: 0.82rem;
      }
      .player-lives {
        font-size: 0.72rem;
        margin: 0 0.25rem;
      }

      /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
      .messages {
        max-height: 150px;
        overflow-y: auto;
        list-style: none;
        margin-top: 0.5rem;
      }
      .messages::-webkit-scrollbar {
        width: 3px;
      }
      .messages::-webkit-scrollbar-thumb {
        background: var(--text3);
        border-radius: 1px;
      }
      .msg-item {
        font-size: 0.78rem;
        color: var(--text2);
        padding: 0.25rem 0;
        border-bottom: 1px dotted var(--border);
      }
      .msg-item:last-child {
        border-bottom: none;
      }
      .msg-item.msg-success {
        color: var(--success);
      }
      .msg-item.msg-error {
        color: var(--danger);
      }
      .msg-item.msg-info {
        color: var(--primary);
      }

      /* ‚îÄ‚îÄ Game Over ‚îÄ‚îÄ */
      .game-over-overlay {
        position: fixed;
        inset: 0;
        background: rgba(245, 240, 232, 0.8);
        backdrop-filter: blur(6px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        animation: fadeIn 0.3s ease;
      }
      .game-over-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2.5rem;
        text-align: center;
        max-width: 480px;
        width: 90%;
        animation: popIn 0.4s ease both;
        box-shadow: 0 8px 40px rgba(44, 36, 32, 0.1);
        max-height: 90vh;
        overflow-y: auto;
      }
      .game-over-card h2 {
        font-family: var(--font-head);
        font-size: 1.6rem;
        margin-bottom: 0.5rem;
        color: var(--text);
        border-bottom: none;
        justify-content: center;
      }
      .game-over-card h2::before {
        display: none;
      }
      .game-over-reason {
        color: var(--text2);
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
      }
      .final-scores {
        list-style: none;
        margin-bottom: 1.5rem;
      }
      .final-score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.55rem 0.9rem;
        border-bottom: 1px dotted var(--border);
        margin-bottom: 0;
      }
      .final-score-item:first-child {
        background: linear-gradient(
          90deg,
          rgba(194, 58, 34, 0.06),
          transparent
        );
        border-left: 3px solid var(--primary);
      }
      .final-score-item:last-child {
        border-bottom: none;
      }
      .final-rank {
        width: 2rem;
        text-align: center;
        font-weight: 700;
        color: var(--primary);
      }
      .final-name {
        flex: 1;
        text-align: left;
        margin-left: 0.5rem;
        font-family: var(--font-head);
      }
      .final-pts {
        font-weight: 700;
        color: var(--primary);
        font-family: var(--font-head);
      }

      /* ‚îÄ‚îÄ Game Over History ‚îÄ‚îÄ */
      .game-over-history {
        text-align: left;
        margin-bottom: 1.5rem;
      }
      .game-over-history-toggle {
        background: none;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 0.5rem 1rem;
        cursor: pointer;
        width: 100%;
        text-align: left;
        font-size: 0.88rem;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s;
      }
      .game-over-history-toggle:hover {
        background: var(--surface2);
      }
      .game-over-history-toggle .toggle-arrow {
        transition: transform 0.3s;
      }
      .game-over-history-toggle.open .toggle-arrow {
        transform: rotate(180deg);
      }
      .game-over-history-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .game-over-history-body.open {
        max-height: 300px;
        overflow-y: auto;
      }
      .game-over-history-body::-webkit-scrollbar {
        width: 3px;
      }
      .game-over-history-body::-webkit-scrollbar-thumb {
        background: var(--text3);
        border-radius: 1px;
      }
      .game-over-history-list {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0 0;
      }
      .game-over-history-list li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.3rem 0.5rem;
        border-bottom: 1px dotted var(--border);
        font-size: 0.82rem;
      }
      .game-over-history-list li:last-child {
        border-bottom: none;
      }
      .game-over-history-num {
        color: var(--text2);
        min-width: 1.5rem;
        text-align: right;
        font-size: 0.72rem;
      }
      .game-over-history-word {
        font-family: var(--font-head);
        font-weight: 600;
        color: var(--text);
      }
      .game-over-history-player {
        color: var(--text2);
        font-size: 0.72rem;
        margin-left: auto;
      }
      .game-over-history-chain {
        font-size: 0.78rem;
        color: var(--text2);
        margin-top: 0.75rem;
        padding: 0.4rem 0.5rem;
        background: var(--surface2);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      /* ‚îÄ‚îÄ Game Over Settings Panel ‚îÄ‚îÄ */
      .game-over-settings {
        text-align: left;
        margin-bottom: 1.5rem;
      }
      .game-over-settings-toggle {
        background: none;
        border: 1px solid var(--accent);
        border-radius: var(--radius);
        padding: 0.5rem 1rem;
        cursor: pointer;
        width: 100%;
        text-align: left;
        font-size: 0.88rem;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s;
      }
      .game-over-settings-toggle:hover {
        background: rgba(61, 107, 94, 0.06);
      }
      .game-over-settings-toggle .toggle-arrow {
        transition: transform 0.3s;
      }
      .game-over-settings-toggle.open .toggle-arrow {
        transform: rotate(180deg);
      }
      .game-over-settings-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
      }
      .game-over-settings-body.open {
        max-height: 600px;
        overflow-y: auto;
      }
      .game-over-settings-body .form-group {
        margin-top: 0.75rem;
      }
      .game-over-settings-body .form-row {
        display: flex;
        gap: 0.75rem;
      }
      .game-over-settings-body .form-row .form-group {
        flex: 1;
      }
      .game-over-settings-body label {
        display: block;
        font-size: 0.8rem;
        color: var(--text2);
        margin-bottom: 0.2rem;
      }
      .game-over-settings-body input,
      .game-over-settings-body select {
        width: 100%;
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 0.88rem;
        background: var(--surface);
      }
      .game-over-settings-body .kana-row-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        margin-top: 0.3rem;
      }
      .game-over-settings-changed {
        display: inline-block;
        font-size: 0.72rem;
        color: var(--accent);
        margin-left: 0.5rem;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .game-over-settings-changed.visible {
        opacity: 1;
      }

      /* ‚îÄ‚îÄ Share Buttons ‚îÄ‚îÄ */
      .share-section {
        margin-bottom: 1.2rem;
      }
      .share-section p {
        font-size: 0.8rem;
        color: var(--text2);
        margin-bottom: 0.5rem;
      }
      .share-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
      }
      .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.4rem 0.9rem;
        border-radius: var(--radius);
        font-size: 0.82rem;
        font-weight: 600;
        color: #fff;
        transition:
          opacity 0.2s,
          transform 0.1s;
      }
      .share-btn:hover {
        opacity: 0.85;
        transform: scale(1.02);
      }
      .share-btn:active {
        transform: scale(0.97);
      }
      .share-btn-x {
        background: #2c2420;
      }
      .share-btn-line {
        background: #06c755;
      }
      .share-btn-copy {
        background: var(--primary);
      }
      .share-btn-copy.copied {
        background: var(--success);
      }
      .share-btn .share-icon {
        font-size: 1rem;
      }

      /* ‚îÄ‚îÄ My lives display ‚îÄ‚îÄ */
      .my-lives-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem 0.8rem;
        margin-bottom: 0.75rem;
        border-radius: var(--radius);
        background: var(--surface);
        border: 1px solid var(--border);
      }
      .my-lives-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text2);
      }
      .my-lives-hearts {
        display: flex;
        gap: 0.2rem;
        font-size: 1.3rem;
        transition: all 0.3s;
      }
      .my-lives-hearts .heart {
        display: inline-block;
        transition: all 0.3s;
      }
      .my-lives-hearts .heart.lost {
        filter: grayscale(1);
        opacity: 0.25;
        transform: scale(0.8);
      }
      .my-lives-hearts .heart.shake {
        animation: shake 0.4s ease;
      }
      @keyframes heartBreak {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        30% {
          transform: scale(1.2);
        }
        60% {
          transform: scale(0.5);
          opacity: 0.4;
        }
        100% {
          transform: scale(0.8);
          opacity: 0.25;
          filter: grayscale(1);
        }
      }
      .my-lives-hearts .heart.breaking {
        animation: heartBreak 0.5s ease forwards;
      }

      /* ‚îÄ‚îÄ Start button area ‚îÄ‚îÄ */
      .start-area {
        text-align: center;
        padding: 2rem;
      }
      .waiting-text {
        color: var(--text2);
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }

      /* ‚îÄ‚îÄ Floating score popup ‚îÄ‚îÄ */
      .score-popup {
        position: fixed;
        pointer-events: none;
        font-family: var(--font-head);
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--success);
        animation: floatUp 1s ease both;
        z-index: 50;
      }

      /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
      @media (max-width: 500px) {
        .header h1 {
          font-size: 2rem;
        }
        .current-word {
          font-size: 2.5rem;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .card {
          padding: 1rem;
        }
      }

      /* ‚îÄ‚îÄ Turn indicator ‚îÄ‚îÄ */
      .turn-indicator {
        text-align: center;
        padding: 0.55rem 0.8rem;
        margin-bottom: 0.5rem;
        border-radius: var(--radius);
        font-size: 1rem;
        font-weight: 700;
        animation: pulse 2s infinite;
      }
      .turn-indicator.my-turn {
        background: rgba(194, 58, 34, 0.07);
        color: var(--primary);
        border: 1.5px solid var(--primary);
      }
      .turn-indicator.other-turn {
        background: var(--surface2);
        color: var(--text2);
        border: 1.5px solid var(--border);
        animation: none;
      }
      .turn-order-list {
        display: flex;
        justify-content: center;
        gap: 0.4rem;
        margin-top: 0.3rem;
        font-size: 0.78rem;
        font-weight: 400;
      }
      .turn-order-item {
        padding: 0.12rem 0.45rem;
        border-radius: var(--radius);
        background: var(--surface2);
        color: var(--text2);
        border: 1px solid var(--border);
      }
      .turn-order-item.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      /* ‚îÄ‚îÄ Waiting players ‚îÄ‚îÄ */
      .waiting-players {
        margin-bottom: 1.2rem;
      }
      .waiting-players h3 {
        font-family: var(--font-head);
        font-size: 0.9rem;
        color: var(--text);
        margin-bottom: 0.5rem;
      }
      .waiting-player-list {
        list-style: none;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        justify-content: center;
      }
      .waiting-player-list li {
        background: var(--surface2);
        color: var(--text);
        padding: 0.25rem 0.7rem;
        border-radius: var(--radius);
        font-size: 0.88rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        border: 1px solid var(--border);
      }
      .waiting-player-list li .owner-badge {
        font-size: 0.68rem;
        background: var(--primary);
        color: #fff;
        padding: 0.08rem 0.35rem;
        border-radius: var(--radius);
      }
      .answer-area.disabled input {
        opacity: 0.4;
        pointer-events: none;
      }
      .answer-area.disabled button {
        opacity: 0.4;
        pointer-events: none;
      }

      /* ‚îÄ‚îÄ Vote UI ‚îÄ‚îÄ */
      .vote-overlay {
        position: fixed;
        inset: 0;
        background: rgba(245, 240, 232, 0.75);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 90;
        animation: fadeIn 0.3s ease;
      }
      .vote-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        animation: popIn 0.35s ease both;
        box-shadow: 0 8px 40px rgba(44, 36, 32, 0.1);
      }
      .vote-card h3 {
        font-family: var(--font-head);
        font-size: 1.15rem;
        color: var(--text);
        margin-bottom: 0.5rem;
      }
      .vote-card h3::before {
        display: none;
      }
      .vote-word {
        font-family: var(--font-display);
        font-size: 2.2rem;
        font-weight: 400;
        color: var(--text);
        margin: 0.75rem 0;
        letter-spacing: 0.08em;
      }
      .vote-question {
        color: var(--text2);
        font-size: 0.88rem;
        margin-bottom: 0.8rem;
      }
      .vote-buttons {
        display: flex;
        gap: 0.6rem;
        justify-content: center;
        margin-bottom: 1rem;
      }
      .vote-buttons .btn {
        min-width: 110px;
        font-size: 1rem;
        padding: 0.65rem 1.2rem;
      }
      .btn-accept {
        background: var(--success);
        color: #fff;
      }
      .btn-accept:hover {
        background: #2f5548;
      }
      .btn-reject {
        background: var(--danger);
        color: #fff;
      }
      .btn-reject:hover {
        background: #9a2e1e;
      }
      .vote-progress {
        font-size: 0.82rem;
        color: var(--text2);
      }
      .vote-progress-bar {
        height: 3px;
        background: var(--surface2);
        border-radius: 1px;
        margin-top: 0.5rem;
        overflow: hidden;
      }
      .vote-progress-bar-inner {
        height: 100%;
        background: var(--primary);
        border-radius: 1px;
        transition: width 0.3s;
      }
      .vote-timer {
        font-size: 0.78rem;
        color: var(--text2);
        margin-top: 0.5rem;
      }

      /* ‚îÄ‚îÄ Kana Row Checkboxes ‚îÄ‚îÄ */
      .kana-row-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.3rem;
      }
      .kana-row-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.6rem;
        border-radius: var(--radius);
        background: var(--surface);
        border: 1.5px solid var(--border);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.88rem;
        user-select: none;
        font-weight: 500;
      }
      .kana-row-chip:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .kana-row-chip.selected {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary-dark);
      }
      .kana-row-chip input {
        display: none;
      }
      .kana-row-select-all {
        font-size: 0.78rem;
        color: var(--primary);
        cursor: pointer;
        text-decoration: underline;
        margin-left: 0.5rem;
      }

      /* ‚îÄ‚îÄ Vote waiting & rebuttal ‚îÄ‚îÄ */
      .vote-waiting {
        color: var(--text2);
        font-size: 0.9rem;
        padding: 0.5rem 0;
      }
      .rebuttal-area {
        margin-bottom: 1rem;
      }
      .rebuttal-label {
        font-size: 0.9rem;
        color: var(--primary);
        font-weight: 600;
        margin-bottom: 0.4rem;
      }
      .rebuttal-input-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .rebuttal-input {
        flex: 1;
        padding: 0.5rem 0.5rem;
        border-radius: var(--radius);
        border: 1.5px solid var(--border);
        font-size: 1rem;
        background: var(--surface);
        color: var(--text);
      }
      .rebuttal-input:focus {
        border-color: var(--primary);
        outline: none;
      }
      .rebuttal-hint {
        font-size: 0.78rem;
        color: var(--text2);
        margin-top: 0.3rem;
      }
      .rebuttal-display {
        background: var(--surface);
        border-left: 3px solid var(--primary);
        padding: 0.5rem 0.7rem;
        margin: 0.6rem 0;
        border-radius: var(--radius);
        font-size: 0.9rem;
        color: var(--text);
        text-align: left;
      }
      .rebuttal-display .rebuttal-sender {
        font-weight: 700;
        color: var(--primary);
        margin-right: 0.3rem;
      }

      /* ‚îÄ‚îÄ Withdraw ‚îÄ‚îÄ */
      .withdraw-area {
        margin-top: 0.8rem;
        text-align: center;
      }
      .withdraw-area .btn {
        font-size: 0.9rem;
      }

      /* ‚îÄ‚îÄ Lobby button tooltip ‚îÄ‚îÄ */
      .lobby-btn-wrap {
        position: relative;
        display: inline-block;
      }
      .lobby-btn-wrap .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .lobby-btn-tooltip {
        display: none;
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--text);
        color: var(--bg);
        font-size: 0.72rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius);
        white-space: nowrap;
        pointer-events: none;
        z-index: 10;
      }
      .lobby-btn-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: var(--text);
      }
      .lobby-btn-wrap:hover .lobby-btn-tooltip {
        display: block;
      }
      .lobby-btn-wrap:not(:has(.btn:disabled)) .lobby-btn-tooltip {
        display: none !important;
      }

      /* ‚îÄ‚îÄ Theme Switcher ‚îÄ‚îÄ */
      .theme-switcher {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 200;
      }
      .theme-toggle {
        height: 30px;
        border-radius: var(--radius);
        border: 1.5px solid var(--border);
        background: var(--surface);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 10px;
        line-height: 1;
        color: var(--text2);
        white-space: nowrap;
      }
      .theme-toggle:hover {
        border-color: var(--primary);
        color: var(--primary);
        transform: scale(1.05);
      }
      .theme-panel {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        transform: scale(0.95);
        transform-origin: top right;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 4px 20px rgba(44, 36, 32, 0.1);
        padding: 8px;
        min-width: 150px;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.2s,
          transform 0.2s;
      }
      .theme-panel.open {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }
      .theme-panel::before {
        content: "";
        position: absolute;
        top: -5px;
        right: 12px;
        transform: rotate(45deg);
        width: 10px;
        height: 10px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        border-left: 1px solid var(--border);
      }
      .theme-panel-title {
        font-size: 0.62rem;
        font-weight: 700;
        color: var(--text3);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        padding: 2px 6px 6px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 4px;
      }
      .theme-btn {
        display: block;
        width: 100%;
        padding: 6px 10px;
        border: none;
        border-radius: var(--radius);
        background: transparent;
        cursor: pointer;
        transition: background 0.15s;
        font-size: 0.82rem;
        color: var(--text);
        text-align: left;
        white-space: nowrap;
      }
      .theme-btn:hover {
        background: var(--surface2);
      }
      .theme-btn.active {
        background: rgba(194, 58, 34, 0.08);
        font-weight: 600;
        color: var(--primary);
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1><a href="/">„Åó„Çä„Å®„Çä</a></h1>
      <p>„Åì„Å®„Å∞„ÇíÁπã„Åê„ÄÅ„Åø„Çì„Å™„ÅßÈÅä„Å∂</p>
    </div>

    <div class="theme-switcher" id="themeSwitcher">
      <button class="theme-toggle" id="themeToggle" aria-label="„ÉÜ„Éº„ÉûÂàáÊõø">
        „ÉÜ„Éº„Éû
      </button>
      <div class="theme-panel" id="themePanel">
        <div class="theme-panel-title">„ÉÜ„Éº„Éû</div>
        <button class="theme-btn" data-theme="default">„Éá„Éï„Ç©„É´„Éà</button>
        <button class="theme-btn" data-theme="wamo">Âíå„É¢„ÉÄ„É≥</button>
        <button class="theme-btn" data-theme="neon">„Éç„Ç™„É≥</button>
        <button class="theme-btn" data-theme="typo">Ê¥ªÁâà</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê -->
    <div id="lobby" class="container fade-in">
      <div class="player-name-section">
        <div class="player-name-desc">
          <p>
            ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„ÄÅ„É´„Éº„É†„Å´ÂèÇÂä†„Åô„Çã„Åã„ÄÅÊñ∞„Åó„ÅÑ„É´„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>
        </div>
        <div class="player-name-field">
          <label for="playerName" class="player-name-label">„É¶„Éº„Ç∂„ÉºÂêç</label>
          <input
            type="text"
            id="playerName"
            placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ"
            maxlength="12"
            autocomplete="off"
          />
        </div>
      </div>

      <div id="lobbyCreateCard" class="card slide-up">
        <h2>„É´„Éº„É†„Çí‰Ωú„Çã</h2>
        <div class="create-room-layout">
          <div id="roomCreateSettings">
            <div class="form-group">
              <label>„É´„Éº„É†Âêç</label>
              <input
                type="text"
                id="roomNameInput"
                placeholder="Ê•Ω„Åó„ÅÑ„Åó„Çä„Å®„Çä"
                maxlength="20"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ÊúÄÂ∞ëÊñáÂ≠óÊï∞</label>
                <input type="number" id="minLen" value="1" min="1" max="20" />
              </div>
              <div class="form-group">
                <label>ÊúÄÂ§ßÊñáÂ≠óÊï∞Ôºà0ÔºùÂà∂Èôê„Å™„ÅóÔºâ</label>
                <input type="number" id="maxLen" value="0" min="0" max="99" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>„Ç∏„É£„É≥„É´ÔºàËá™Áî±ÂÖ•ÂäõÔºâ</label>
                <input
                  type="text"
                  id="genre"
                  placeholder="‰æã: È£ü„ÅπÁâ©„ÄÅÂãïÁâ©„ÄÅÂõΩÂêç..."
                  maxlength="20"
                />
              </div>
              <div class="form-group">
                <label>Âà∂ÈôêÊôÇÈñì</label>
                <select id="timeLimit">
                  <option value="0">„Å™„Åó</option>
                  <option value="10">10Áßí</option>
                  <option value="20">20Áßí</option>
                  <option value="30" selected>30Áßí</option>
                  <option value="60">60Áßí</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>„É©„Ç§„ÉïÊï∞</label>
                <select id="maxLives">
                  <option value="1">‚ù§Ô∏è</option>
                  <option value="2">‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="3" selected>‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="5">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="10">‚ù§Ô∏è√ó10</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            <div class="form-group">
              <label>‰ΩøÁî®ÂèØËÉΩ„Å™Ë°åÔºàÊú™ÈÅ∏ÊäûÔºù„Åô„Åπ„Å¶‰ΩøÁî®ÂèØËÉΩÔºâ</label>
              <div id="kanaRowCheckboxes" class="kana-row-grid"></div>
            </div>
            <div class="form-group">
              <label
                class="kana-row-chip"
                style="display: inline-flex; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="noDakuten"
                  style="display: inline; width: auto; margin-right: 0.3rem"
                />
                ÊøÅÈü≥„ÉªÂçäÊøÅÈü≥Á¶ÅÊ≠¢Ôºà„Åå„Åé„Åê„Åí„Åî„Åñ„Åò„Åö„Åú„Åû„Å†„Å¢„Å•„Åß„Å©„Å∞„Å≥„Å∂„Åπ„Åº„Å±„Å¥„Å∑„Å∫„ÅΩÔºâ
              </label>
            </div>
            <div class="form-group">
              <label
                class="kana-row-chip"
                style="display: inline-flex; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="privateRoom"
                  style="display: inline; width: auto; margin-right: 0.3rem"
                />
                üîí „Éó„É©„Ç§„Éô„Éº„Éà„É´„Éº„É†Ôºà„É≠„Éì„Éº„Å´Ë°®Á§∫„Åó„Å™„ÅÑÔºâ
              </label>
            </div>
            <div class="lobby-btn-wrap" data-lobby-btn style="display: block">
              <button
                class="btn btn-primary btn-block"
                onclick="createRoom()"
                disabled
              >
                „É´„Éº„É†„Çí‰ΩúÊàê
              </button>
              <span class="lobby-btn-tooltip"
                >„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span
              >
            </div>
          </div>
          <div class="rules-panel">
            <table class="rules-table">
              <tbody>
                <tr>
                  <td>„Äå„Çì„Äç„ÅßÁµÇ‰∫Ü</td>
                  <td class="rules-val rules-danger">Â§±Ê†º</td>
                </tr>
                <tr>
                  <td>Âêå„ÅòÂçòË™û</td>
                  <td class="rules-val">‰ΩøÁî®‰∏çÂèØ</td>
                </tr>
                <tr>
                  <td>Âà∂ÈôêÊôÇÈñìË∂ÖÈÅé</td>
                  <td class="rules-val">„É©„Ç§„Éï ‚àí1</td>
                </tr>
                <tr>
                  <td>„É©„Ç§„Éï 0</td>
                  <td class="rules-val rules-danger">ÊïóÂåó</td>
                </tr>
              </tbody>
            </table>
            <p class="rules-desc">
              ÊúÄÂæå„Åæ„ÅßÁîü„ÅçÊÆã„Å£„Åü„Éó„É¨„Ç§„É§„Éº„ÅÆÂãùÂà©„ÄÇË®ÄËëâ„ÅÆÁü•Ë≠ò„Å®ÂèçÂ∞ÑÁ•ûÁµå„ÅåË©¶„Åï„Çå„Çã„ÄÇ
            </p>
          </div>
        </div>
        <!-- /.create-room-layout -->
      </div>

      <div
        id="inviteCard"
        class="card invite-card slide-up hidden"
        style="animation-delay: 0.05s"
      >
        <div class="invite-info">
          <div class="invite-room-title" id="inviteCardTitle">ÊãõÂæÖ„É´„Éº„É†</div>
          <div class="invite-room-rules" id="inviteCardRules"></div>
          <div class="invite-room-host" id="inviteCardHost"></div>
        </div>
        <div class="invite-actions">
          <div class="lobby-btn-wrap" data-lobby-btn>
            <button class="btn btn-primary" onclick="joinInviteRoom()" disabled>
              ÂèÇÂä†„Åô„Çã
            </button>
            <span class="lobby-btn-tooltip">„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
          </div>
          <button class="btn btn-outline" onclick="clearInvite()">ÁÑ°Ë¶ñ</button>
        </div>
      </div>

      <div
        id="lobbyRoomsCard"
        class="card slide-up"
        style="animation-delay: 0.1s"
      >
        <h2>
          „É´„Éº„É†‰∏ÄË¶ß
          <button
            class="btn btn-outline"
            style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem"
            onclick="refreshRooms()"
          >
            Êõ¥Êñ∞
          </button>
        </h2>
        <ul id="roomList" class="room-list"></ul>
        <div id="noRooms" class="no-rooms">
          ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„É´„Éº„É†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GAME ROOM ‚ïê‚ïê‚ïê -->
    <div id="game" class="container hidden">
      <div class="game-header">
        <div class="room-title" id="gameRoomTitle">„É´„Éº„É†</div>
        <div class="game-rules" id="gameRules"></div>
        <div class="game-header-actions">
          <button
            class="share-btn share-btn-x"
            style="padding: 0.3rem 0.6rem; font-size: 0.75rem"
            onclick="shareRoomToX()"
          >
            <span class="share-icon">ùïè</span>
          </button>
          <button
            class="share-btn share-btn-line"
            style="padding: 0.3rem 0.6rem; font-size: 0.75rem"
            onclick="shareRoomToLINE()"
          >
            <span class="share-icon">üí¨</span>
          </button>
          <button
            class="btn btn-outline"
            style="padding: 0.35rem 0.8rem; font-size: 0.8rem"
            onclick="copyRoomLink()"
          >
            üîó „Ç≥„Éî„Éº
          </button>
          <button
            class="btn btn-outline"
            style="padding: 0.35rem 0.8rem; font-size: 0.8rem"
            onclick="leaveRoom()"
          >
            ÈÄÄÂá∫
          </button>
        </div>
      </div>

      <!-- Pre-game / waiting -->
      <div id="preGame" class="card start-area">
        <p class="waiting-text">„Éó„É¨„Ç§„É§„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶</p>
        <div class="waiting-players">
          <h3>üë• ÂèÇÂä†ËÄÖ</h3>
          <ul id="waitingPlayerList" class="waiting-player-list"></ul>
        </div>
        <button
          id="startBtn"
          class="btn btn-accent btn-lg"
          onclick="startGame()"
        >
          üéÆ „Ç≤„Éº„É†ÈñãÂßã
        </button>
        <p id="waitOwnerText" class="waiting-text hidden">
          „É´„Éº„É†‰ΩúÊàêËÄÖ„ÅÆÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶
        </p>
      </div>

      <!-- Active game -->
      <div id="activeGame" class="hidden">
        <div id="turnIndicator" class="turn-indicator">
          <span id="turnText"></span>
        </div>
        <div class="my-lives-display" id="myLivesDisplay">
          <span class="my-lives-label">„É©„Ç§„Éï</span>
          <div class="my-lives-hearts" id="myLivesHearts"></div>
        </div>

        <div class="current-word-area">
          <div class="current-word-label">ÁèæÂú®„ÅÆ„Åì„Å®„Å∞</div>
          <div class="current-word" id="currentWord">„Éº</div>
        </div>

        <div id="timerSection" class="hidden">
          <div class="timer-text" id="timerText">30</div>
          <div class="timer-bar">
            <div class="timer-bar-inner" id="timerBar"></div>
          </div>
        </div>

        <div class="answer-area">
          <input
            type="text"
            id="answerInput"
            placeholder="„Åì„Å®„Å∞„ÇíÂÖ•Âäõ‚Ä¶"
            autocomplete="off"
            lang="ja"
            style="ime-mode: active;"
          />
          <button class="btn btn-primary" onclick="submitAnswer()">ÈÄÅ‰ø°</button>
          <button
            class="btn btn-outline"
            id="challengeBtn"
            onclick="requestChallenge()"
          >
            ‚ö†Ô∏è ÊåáÊëò
          </button>
        </div>

        <div class="game-body">
          <div class="history-panel card">
            <h2>Â±•Ê≠¥</h2>
            <ul class="history-list" id="historyList"></ul>
          </div>
          <div class="sidebar">
            <div class="card">
              <h2>„Éó„É¨„Ç§„É§„Éº</h2>
              <ul class="player-list" id="playerList"></ul>
            </div>
            <div class="card">
              <h2>„É°„ÉÉ„Çª„Éº„Ç∏</h2>
              <ul class="messages" id="messageList"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê VOTE OVERLAY ‚ïê‚ïê‚ïê -->
    <div id="voteOverlay" class="vote-overlay hidden">
      <div class="vote-card">
        <h3 id="voteTitle">üó≥Ô∏è ÊäïÁ•®</h3>
        <p class="vote-question" id="voteQuestion"></p>
        <div class="vote-word" id="voteWord"></div>
        <p class="vote-question" id="voteGenreHint"></p>
        <div id="voteButtonArea" class="vote-buttons">
          <button class="btn btn-accept" onclick="castVote(true)">
            ‚≠ï Â≠òÂú®„Åô„Çã
          </button>
          <button class="btn btn-reject" onclick="castVote(false)">
            ‚ùå Â≠òÂú®„Åó„Å™„ÅÑ
          </button>
        </div>
        <div id="rebuttalArea" class="rebuttal-area hidden">
          <p class="rebuttal-label">üí¨ ÂèçË´ñ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çå„Åæ„ÅôÔºö</p>
          <div class="rebuttal-input-row">
            <input
              type="text"
              id="rebuttalInput"
              class="rebuttal-input"
              placeholder="ÂèçË´ñ„ÇíÂÖ•Âäõ‚Ä¶"
              maxlength="100"
            />
            <button class="btn btn-primary" onclick="sendRebuttal()">
              ÈÄÅ‰ø°
            </button>
          </div>
          <p class="rebuttal-hint">
            ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å´Ë°®Á§∫„Åï„Çå„Åæ„ÅôÔºàÊäïÁ•®„Å´„ÅØÂèÇÂä†„Åß„Åç„Åæ„Åõ„ÇìÔºâ
          </p>
        </div>
        <div id="rebuttalDisplay" class="rebuttal-display hidden"></div>
        <div id="voteWaiting" class="vote-waiting hidden">
          ÊäïÁ•®Ê∏à„Åø„ÄÇ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊäïÁ•®„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶
        </div>
        <div id="withdrawArea" class="withdraw-area hidden">
          <button
            class="btn btn-outline"
            id="withdrawBtn"
            onclick="withdrawChallenge()"
          >
            üîô ÊåáÊëò„ÇíÂèñ„Çä‰∏ã„Åí„Çã
          </button>
        </div>
        <div class="vote-progress">
          <span id="voteProgressText">0 / 0 ÊäïÁ•®Ê∏à„Åø</span>
          <div class="vote-progress-bar">
            <div
              class="vote-progress-bar-inner"
              id="voteProgressBar"
              style="width: 0%"
            ></div>
          </div>
        </div>
        <div class="vote-timer" id="voteTimer">15Áßí„ÅßËá™ÂãïÂà§ÂÆö</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GAME OVER OVERLAY ‚ïê‚ïê‚ïê -->
    <div id="gameOver" class="game-over-overlay hidden">
      <div class="game-over-card">
        <h2>„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
        <p class="game-over-reason" id="gameOverReason"></p>
        <ul class="final-scores" id="finalScores"></ul>
        <div class="game-over-history" id="gameOverHistory">
          <button
            class="game-over-history-toggle"
            onclick="toggleGameOverHistory(this)"
          >
            <span
              >üìú Â±•Ê≠¥„ÇíË¶ã„ÇãÔºà<span id="gameOverHistoryCount">0</span>Ë™ûÔºâ</span
            >
            <span class="toggle-arrow">‚ñº</span>
          </button>
          <div class="game-over-history-body" id="gameOverHistoryBody">
            <div
              class="game-over-history-chain"
              id="gameOverHistoryChain"
            ></div>
            <ul class="game-over-history-list" id="gameOverHistoryList"></ul>
          </div>
        </div>
        <div class="share-section" id="shareSection" style="display: none">
          <p>üì¢ ÁµêÊûú„Çí„Ç∑„Çß„Ç¢</p>
          <div class="share-buttons">
            <button class="share-btn share-btn-x" onclick="shareToX()">
              <span class="share-icon">ùïè</span> „Éù„Çπ„Éà
            </button>
            <button class="share-btn share-btn-line" onclick="shareToLINE()">
              <span class="share-icon">üí¨</span> LINE
            </button>
            <button
              class="share-btn share-btn-copy"
              id="shareCopyBtn"
              onclick="shareLink()"
            >
              <span class="share-icon">üîó</span> „É™„É≥„ÇØ„Ç≥„Éî„Éº
            </button>
          </div>
        </div>
        <div class="game-over-settings" id="gameOverSettings" style="display:none">
          <button class="game-over-settings-toggle" onclick="toggleGameOverSettings(this)">
            <span>‚öôÔ∏è „É´„Éº„É´Â§âÊõ¥ <span class="game-over-settings-changed" id="settingsChangedBadge">‚úèÔ∏è Â§âÊõ¥„ÅÇ„Çä</span></span>
            <span class="toggle-arrow">‚ñº</span>
          </button>
          <div class="game-over-settings-body" id="gameOverSettingsBody">
            <div class="form-row">
              <div class="form-group">
                <label>ÊúÄÂ∞ëÊñáÂ≠óÊï∞</label>
                <input type="number" id="goMinLen" min="1" max="20" />
              </div>
              <div class="form-group">
                <label>ÊúÄÂ§ßÊñáÂ≠óÊï∞Ôºà0ÔºùÂà∂Èôê„Å™„ÅóÔºâ</label>
                <input type="number" id="goMaxLen" min="0" max="99" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>„Ç∏„É£„É≥„É´ÔºàËá™Áî±ÂÖ•ÂäõÔºâ</label>
                <input type="text" id="goGenre" placeholder="‰æã: È£ü„ÅπÁâ©„ÄÅÂãïÁâ©‚Ä¶" maxlength="20" />
              </div>
              <div class="form-group">
                <label>Âà∂ÈôêÊôÇÈñì</label>
                <select id="goTimeLimit">
                  <option value="0">„Å™„Åó</option>
                  <option value="10">10Áßí</option>
                  <option value="20">20Áßí</option>
                  <option value="30">30Áßí</option>
                  <option value="60">60Áßí</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>„É©„Ç§„ÉïÊï∞</label>
                <select id="goMaxLives">
                  <option value="1">‚ù§Ô∏è</option>
                  <option value="2">‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="3">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="5">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</option>
                  <option value="10">‚ù§Ô∏è√ó10</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            <div class="form-group">
              <label>‰ΩøÁî®ÂèØËÉΩ„Å™Ë°åÔºàÊú™ÈÅ∏ÊäûÔºù„Åô„Åπ„Å¶Ôºâ</label>
              <div id="goKanaRowCheckboxes" class="kana-row-grid"></div>
            </div>
            <div class="form-group">
              <label class="kana-row-chip" style="display:inline-flex;cursor:pointer">
                <input type="checkbox" id="goNoDakuten" style="display:inline;width:auto;margin-right:0.3rem" />
                ÊøÅÈü≥„ÉªÂçäÊøÅÈü≥Á¶ÅÊ≠¢
              </label>
            </div>
          </div>
        </div>
        <button
          id="playAgainBtn"
          class="btn btn-primary btn-lg"
          onclick="playAgain()"
          style="margin-right: 0.5rem"
        >
          üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶
        </button>
        <button class="btn btn-outline btn-lg" onclick="backToLobby()">
          üè† „É≠„Éì„Éº„Å∏
        </button>
        <p id="playAgainWait" class="game-over-reason hidden">
          „Éõ„Çπ„Éà„ÅÆÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶
        </p>
      </div>
    </div>

    <script>
      /* ========== STATE ========== */
      let ws = null;
      let myName = "";
      let currentRoomId = "";
      let currentSettings = {};
      let timerInterval = null;
      let timerMax = 0;
      let currentTurn = "";
      let turnOrder = [];
      let roomOwner = "";
      let waitingPlayers = [];
      let voteTimerInterval = null;
      let hasVoted = false;
      let isVoteActive = false;
      let lastWordPlayer = "";
      let wasInRoom = ""; // roomId to rejoin after reconnect
      let wasRoomOwner = false; // was this player the room owner?
      let kanaRowNames = [];
      let currentLives = {};
      let maxLives = 3;
      let inviteRoomId = "";
      let lastShareURL = "";

      const $ = (id) => document.getElementById(id);

      /* ========== WEBSOCKET ========== */
      function connect() {
        if (ws && ws.readyState <= 1) return;
        const proto = location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(`${proto}//${location.host}/ws`);
        ws.onopen = () => {
          console.log("WS connected");
          refreshRooms();
          send({ type: "get_genres" });
          // Attempt to rejoin room after reconnect
          if (wasInRoom && myName) {
            console.log("Attempting to rejoin room", wasInRoom);
            send({ type: "join", name: myName, roomId: wasInRoom });
            wasInRoom = "";
          } else {
            document.body.classList.toggle(
              "invite-lobby",
              !!inviteRoomId && !currentRoomId,
            );
          }
        };
        ws.onclose = () => {
          console.log("WS closed");
          // Remember current room so we can rejoin
          if (currentRoomId) {
            wasInRoom = currentRoomId;
            wasRoomOwner = (roomOwner === myName);
          }
          setTimeout(connect, 2000);
        };
        ws.onerror = (e) => console.error("WS error", e);
        ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
      }

      function getRoomLink(roomId) {
        const url = new URL(window.location.href);
        url.searchParams.set("room", roomId);
        return url.toString();
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();
          try {
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return ok;
          } catch (err) {
            document.body.removeChild(ta);
            return false;
          }
        }
      }

      function setInviteRoom(roomId) {
        if (!roomId) return;
        inviteRoomId = roomId;
        $("inviteCardTitle").textContent = "ÊãõÂæÖ„É´„Éº„É†";
        $("inviteCardRules").innerHTML =
          '<span class="rule-badge">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</span>';
        $("inviteCardHost").textContent = "";
        $("inviteCard").classList.remove("hidden");
        document.body.classList.add("invite-lobby");
      }

      function clearInviteRoomInfo() {
        $("inviteCardTitle").textContent = "ÊãõÂæÖ„É´„Éº„É†";
        $("inviteCardRules").innerHTML =
          '<span class="rule-badge">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</span>';
        $("inviteCardHost").textContent = "";
      }

      function clearInvite() {
        inviteRoomId = "";
        const url = new URL(window.location.href);
        url.searchParams.delete("room");
        window.history.replaceState({}, "", url.toString());
        $("inviteCard").classList.add("hidden");
        clearInviteRoomInfo();
        document.body.classList.remove("invite-lobby");
      }

      function joinInviteRoom() {
        if (!inviteRoomId) return;
        joinRoom(inviteRoomId);
        $("inviteCard").classList.add("hidden");
        document.body.classList.remove("invite-lobby");
      }

      function copyRoomLink() {
        if (!currentRoomId) return;
        const link = getRoomLink(currentRoomId);
        copyText(link).then((ok) => {
          addMessage(
            ok
              ? "„É´„Éº„É†„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"
              : "„É´„Éº„É†„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü",
            ok ? "success" : "error",
          );
        });
      }

      function shareRoomToX() {
        if (!currentRoomId) return;
        const link = getRoomLink(currentRoomId);
        const title = $('gameRoomTitle') ? $('gameRoomTitle').textContent : '„É´„Éº„É†';
        const text = `„Åó„Çä„Å®„Çä„ÅßÈÅä„Åº„ÅÜÔºÅ„Äå${title}„Äç„Å´ÂèÇÂä†„Åó„Å¶„Å≠üéÆ\n`;
        const url = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(link)}`;
        window.open(url, '_blank', 'width=550,height=420');
      }

      function shareRoomToLINE() {
        if (!currentRoomId) return;
        const link = getRoomLink(currentRoomId);
        const title = $('gameRoomTitle') ? $('gameRoomTitle').textContent : '„É´„Éº„É†';
        const text = `„Åó„Çä„Å®„Çä„ÅßÈÅä„Åº„ÅÜÔºÅ„Äå${title}„Äç„Å´ÂèÇÂä†„Åó„Å¶„Å≠üéÆ\n${link}`;
        const url = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
        window.open(url, '_blank', 'width=550,height=420');
      }


      function send(obj) {
        if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj));
      }

      /* ========== MESSAGE HANDLER ========== */
      function handleMessage(msg) {
        switch (msg.type) {
          case "rooms":
            if (!inviteRoomId) renderRoomList(msg.rooms || []);
            break;
          case "genres":
            onGenres(msg);
            break;
          case "room_joined":
            onJoined(msg);
            break;
          case "player_joined":
            onPlayerJoined(msg.player);
            break;
          case "player_left":
            onPlayerLeft(msg.player);
            break;
          case "player_list":
            onPlayerList(msg);
            break;
          case "game_started":
            onGameStarted(msg);
            break;
          case "word_accepted":
            onNewWord(msg);
            break;
          case "answer_rejected":
            onInvalid(msg.message);
            break;
          case "timer":
            onTimer(msg.timeLeft);
            break;
          case "game_over":
            onGameOver(msg);
            break;
          case "vote_request":
            onVoteRequest(msg);
            break;
          case "vote_update":
            onVoteUpdate(msg);
            break;
          case "vote_result":
            onVoteResult(msg);
            break;
          case "rebuttal":
            onRebuttal(msg);
            break;
          case "challenge_withdrawn":
            onChallengeWithdrawn(msg);
            break;
          case "penalty":
            onPenalty(msg);
            break;
          case "turn_update":
            onTurnUpdate(msg);
            break;
          case "room_state":
            onJoined(msg);
            break;
          case "settings_updated":
            onSettingsUpdated(msg);
            break;
          case "error":
            addMessage(msg.message, "error");
            break;
          default:
            console.log("Unknown message", msg);
        }
      }

      /* ========== LOBBY ========== */
      function refreshRooms() {
        if (inviteRoomId && !currentRoomId) return;
        send({ type: "get_rooms" });
      }

      function onGenres(msg) {
        kanaRowNames = msg.kanaRows || [];
        renderKanaRowCheckboxes();
      }

      function renderKanaRowCheckboxes() {
        const container = $("kanaRowCheckboxes");
        if (!container || !kanaRowNames.length) return;
        container.innerHTML = "";
        kanaRowNames.forEach((name) => {
          const label = document.createElement("label");
          label.className = "kana-row-chip";
          label.innerHTML = `<input type="checkbox" value="${esc(name)}"> ${esc(name)}`;
          label.addEventListener("click", () => {
            setTimeout(() => {
              const cb = label.querySelector("input");
              label.classList.toggle("selected", cb.checked);
            }, 0);
          });
          container.appendChild(label);
        });
      }

      function getSelectedKanaRows() {
        const checkboxes = document.querySelectorAll(
          "#kanaRowCheckboxes input[type=checkbox]:checked",
        );
        return Array.from(checkboxes).map((cb) => cb.value);
      }

      function renderRoomList(rooms) {
        const list = $("roomList");
        const noRooms = $("noRooms");
        list.innerHTML = "";
        if (!rooms.length) {
          noRooms.classList.remove("hidden");
          return;
        }
        noRooms.classList.add("hidden");
        rooms.forEach((r) => {
          const li = document.createElement("li");
          li.className = "room-item fade-in";
          const statusLabel =
            r.status === "playing" ? "üéÆ „Éó„É¨„Ç§‰∏≠" : "‚è≥ ÂæÖÊ©ü‰∏≠";
          const genreLabel =
            r.settings && r.settings.genre ? r.settings.genre : "„Å™„Åó";
          const playerCount =
            r.playerCount !== undefined ? r.playerCount : r.players || 0;
          const roomLink = getRoomLink(r.id);
          li.innerHTML = `
      <div class="room-info">
        <a class="room-name" href="${esc(roomLink)}" onclick="event.preventDefault(); showInviteRoomPreview('${esc(r.id)}');">${esc(r.name)}</a>
        <div class="room-meta">
          <span>üë• ${playerCount}‰∫∫</span>
          <span>üè∑Ô∏è ${esc(genreLabel)}</span>
          <span>${statusLabel}</span>
        </div>
      </div>
      <div class="room-actions">
        <div class="lobby-btn-wrap" data-lobby-btn>
          <button class="btn btn-primary" onclick="showInviteRoomPreview('${esc(r.id)}')"
            ${r.status === "playing" ? "data-playing disabled" : !$("playerName").value.trim() ? "disabled" : ""}>ÂèÇÂä†</button>
          <span class="lobby-btn-tooltip">${r.status === "playing" ? "„Éó„É¨„Ç§‰∏≠„Åß„Åô" : "„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"}</span>
        </div>
      </div>`;
          list.appendChild(li);
        });
      }

      function getName() {
        const name = $("playerName").value.trim();
        if (!name) {
          $("playerName").focus();
          $("playerName").style.borderColor = "var(--danger)";
          return null;
        }
        $("playerName").style.borderColor = "";
        return name;
      }

      function createRoom() {
        const name = getName();
        if (!name) return;
        myName = name;
        const allowedRows = getSelectedKanaRows();
        const noDakuten = $("noDakuten").checked;
        const isPrivate = $("privateRoom").checked;
        send({
          type: "create_room",
          name,
          settings: {
            name: $("roomNameInput").value.trim() || "„Åó„Çä„Å®„Çä„É´„Éº„É†",
            minLen: parseInt($("minLen").value) || 1,
            maxLen: parseInt($("maxLen").value) || 0,
            genre: $("genre").value,
            timeLimit: parseInt($("timeLimit").value) || 0,
            maxLives: parseInt($("maxLives").value) || 3,
            allowedRows: allowedRows.length > 0 ? allowedRows : undefined,
            noDakuten: noDakuten || undefined,
            private: isPrivate || undefined,
          },
        });
      }

      function joinRoom(roomId) {
        const name = getName();
        if (!name) return;
        myName = name;
        send({ type: "join", name, roomId });
        const url = new URL(window.location.href);
        url.searchParams.set("room", roomId);
        window.history.replaceState({}, "", url.toString());
        document.body.classList.remove("invite-lobby");
      }

      function buildRoomBadges(room) {
        const s = room.settings || {};
        let badges = [];
        if (s.private) badges.push("üîí „Éó„É©„Ç§„Éô„Éº„Éà");
        if (room.owner) badges.push(`üëë „Éõ„Çπ„Éà: ${esc(room.owner)}`);
        if (s.genre) badges.push(`üè∑Ô∏è ${esc(s.genre)}`);
        if (s.minLen > 1) badges.push(`ÊúÄÂ∞ë${s.minLen}ÊñáÂ≠ó`);
        if (s.maxLen > 0) badges.push(`ÊúÄÂ§ß${s.maxLen}ÊñáÂ≠ó`);
        if (s.timeLimit > 0) badges.push(`‚è±Ô∏è ${s.timeLimit}Áßí`);
        if (s.allowedRows && s.allowedRows.length > 0)
          badges.push(`üéØ ${s.allowedRows.map(esc).join("„Éª")}`);
        if (s.noDakuten) badges.push("üö´ ÊøÅÈü≥„ÉªÂçäÊøÅÈü≥Á¶ÅÊ≠¢");
        if (s.maxLives || s.maxLives === 0)
          badges.push(`‚ù§Ô∏è „É©„Ç§„Éï${s.maxLives || 3}`);
        const meta =
          room.playerCount !== undefined ? `üë• ${room.playerCount}‰∫∫` : "";
        return [meta, ...badges]
          .filter(Boolean)
          .map((b) => `<span class="rule-badge">${b}</span>`)
          .join("");
      }

      function buildInviteBadges(room) {
        const badges = buildRoomBadges(room);
        return badges || '<span class="rule-badge">„É´„Éº„É´„Å™„Åó</span>';
      }

      function renderRoomInfo(room) {
        if (!room) return;
        $("gameRoomTitle").textContent = room.name || "„É´„Éº„É†";
        $("gameRules").innerHTML = buildRoomBadges(room);
      }

      function renderInviteRoomInfo(room) {
        if (!room) return;
        $("inviteCardTitle").textContent = room.name || "ÊãõÂæÖ„É´„Éº„É†";
        $("inviteCardRules").innerHTML = buildInviteBadges(room);
        $("inviteCardHost").textContent = room.owner
          ? `„Éõ„Çπ„Éà: ${room.owner}`
          : "";
      }

      function prepareWaitingRoom(room) {
        currentRoomId = room.id || "";
        currentSettings = room.settings || {};
        roomOwner = room.owner || "";
        showView("game");
        $("historyList").innerHTML = "";
        $("playerList").innerHTML = "";
        $("messageList").innerHTML = "";
        waitingPlayers = room.players || [];
        currentLives = {};
        maxLives = currentSettings.maxLives || 3;
        currentTurn = "";
        turnOrder = [];
        isVoteActive = false;
        showActiveGame(false);
        $("playAgainBtn")?.classList.remove("hidden");
        $("playAgainWait")?.classList.add("hidden");
        $("gameOver").classList.add("hidden");
        renderRoomInfo(room);
        renderInviteRoomInfo(room);
        updateWaitingRoom();
      }

      /* ========== GAME ROOM ========== */
      function onJoined(msg) {
        currentRoomId = msg.roomId;
        currentSettings = msg.settings || {};
        roomOwner = msg.owner || "";
        currentLives = msg.lives || {};
        maxLives = msg.maxLives || currentSettings.maxLives || 3;
        showView("game");
        $("gameRoomTitle").textContent = currentSettings.name || "„É´„Éº„É†";
        renderRules();
        renderPlayers(msg.players || [], msg.scores || {}, currentLives);
        $("historyList").innerHTML = "";
        (msg.history || []).forEach((h) => addHistoryItem(h.word, h.player));
        if (msg.turnOrder) turnOrder = msg.turnOrder;
        if (msg.currentTurn) currentTurn = msg.currentTurn;
        // Extract player names from players array
        waitingPlayers = (msg.players || []).map((p) =>
          typeof p === "object" ? p.name : p,
        );
        updateWaitingRoom();
        isVoteActive = false;
        updateMyLives();
        if (msg.currentWord && msg.status === "playing") {
          showActiveGame(true);
          setCurrentWord(msg.currentWord);
          updateTurnDisplay();
        } else {
          showActiveGame(false);
        }
        $("playAgainBtn")?.classList.remove("hidden");
        $("playAgainWait")?.classList.add("hidden");
        $("gameOver").classList.add("hidden");
        addMessage("„É´„Éº„É†„Å´ÂèÇÂä†„Åó„Åæ„Åó„Åü", "info");

        if (inviteRoomId && inviteRoomId === currentRoomId) {
          clearInvite();
        }
        renderInviteRoomInfo({
          id: currentRoomId,
          name: currentSettings.name || "„É´„Éº„É†",
          owner: roomOwner,
          playerCount: waitingPlayers.length,
          settings: currentSettings,
          players: waitingPlayers,
        });
      }

      function onPlayerList(msg) {
        if (!currentRoomId) return;
        waitingPlayers = msg.players || [];
        updateWaitingRoom();
        renderInviteRoomInfo({
          id: currentRoomId,
          name: currentSettings.name || "„É´„Éº„É†",
          owner: roomOwner,
          playerCount: waitingPlayers.length,
          settings: currentSettings,
          players: waitingPlayers,
        });
      }

      function updateWaitingRoom() {
        const list = $("waitingPlayerList");
        if (!list) return;
        list.innerHTML = "";
        if (!waitingPlayers.length) {
          list.innerHTML = '<li class="waiting-empty">ÂèÇÂä†ËÄÖ„Å™„Åó</li>';
        } else {
          waitingPlayers.forEach((name) => {
            const li = document.createElement("li");
            li.innerHTML =
              esc(name) +
              (name === roomOwner
                ? ' <span class="owner-badge">„Éõ„Çπ„Éà</span>'
                : "") +
              (name === myName ? " üëà" : "");
            list.appendChild(li);
          });
        }
        // Show/hide start button based on ownership
        const isOwner = myName === roomOwner;
        $("startBtn").classList.toggle("hidden", !isOwner);
        $("waitOwnerText").classList.toggle("hidden", isOwner);
      }

      function buildRuleBadges(settings) {
        const s = settings || {};
        let badges = [];
        if (s.private) badges.push("üîí „Éó„É©„Ç§„Éô„Éº„Éà");
        if (s.genre) badges.push(`üè∑Ô∏è ${esc(s.genre)}`);
        if (s.minLen > 1) badges.push(`ÊúÄÂ∞ë${s.minLen}ÊñáÂ≠ó`);
        if (s.maxLen > 0) badges.push(`ÊúÄÂ§ß${s.maxLen}ÊñáÂ≠ó`);
        if (s.timeLimit > 0) badges.push(`‚è±Ô∏è ${s.timeLimit}Áßí`);
        if (s.allowedRows && s.allowedRows.length > 0)
          badges.push(`üéØ ${s.allowedRows.map(esc).join("„Éª")}`);
        if (s.noDakuten) badges.push("üö´ ÊøÅÈü≥„ÉªÂçäÊøÅÈü≥Á¶ÅÊ≠¢");
        if (s.maxLives || s.maxLives === 0)
          badges.push(`‚ù§Ô∏è „É©„Ç§„Éï${s.maxLives || 3}`);
        return badges
          .map((b) => `<span class="rule-badge">${b}</span>`)
          .join("");
      }

      function renderRules() {
        const s = currentSettings;
        $("gameRules").innerHTML = buildRuleBadges(s);
        timerMax = s.timeLimit || 0;
      }

      function onSettingsUpdated(msg) {
        currentSettings = msg.settings || currentSettings;
        renderRules();
        addMessage("‚öôÔ∏è „É´„Éº„É´„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü", "info");
      }

      function showActiveGame(active) {
        $("preGame").classList.toggle("hidden", active);
        $("activeGame").classList.toggle("hidden", !active);
        if (active) $("answerInput").focus();
      }

      function updateTurnDisplay() {
        const el = $("turnIndicator");
        const txt = $("turnText");
        const isMyTurn = currentTurn === myName;
        el.className =
          "turn-indicator " + (isMyTurn ? "my-turn" : "other-turn");
        txt.innerHTML = isMyTurn
          ? "üéØ „ÅÇ„Å™„Åü„ÅÆÁï™„Åß„ÅôÔºÅ"
          : `‚è≥ ${esc(currentTurn)}„Åï„Çì„ÅÆÁï™„Åß„Åô`;
        // Turn order badges
        if (turnOrder.length > 1) {
          const badges = turnOrder
            .map(
              (n) =>
                `<span class="turn-order-item${n === currentTurn ? " active" : ""}">${esc(n)}</span>`,
            )
            .join("");
          txt.innerHTML += `<div class="turn-order-list">${badges}</div>`;
        }
        // Enable/disable input
        const area = document.querySelector(".answer-area");
        if (area) area.classList.toggle("disabled", !isMyTurn);
        const input = $("answerInput");
        if (input) {
          input.value = "";
          input.disabled = !isMyTurn;
          const isFirstWord = $("currentWord").textContent === "‚Äï";
          input.placeholder = isMyTurn
            ? isFirstWord
              ? "ÊúÄÂàù„ÅÆ„Åì„Å®„Å∞„ÇíÂÖ•Âäõ‚Ä¶"
              : "„Åì„Å®„Å∞„ÇíÂÖ•Âäõ‚Ä¶"
            : `${currentTurn}„Åï„Çì„ÅÆÁï™„Åß„Åô‚Ä¶`;
          if (isMyTurn) input.focus();
        }
        const challengeBtn = $("challengeBtn");
        if (challengeBtn) {
          const canChallenge =
            $("currentWord").textContent !== "‚Äï" &&
            !isVoteActive &&
            lastWordPlayer !== myName;
          challengeBtn.disabled = !canChallenge;
        }
      }

      function setCurrentWord(word) {
        const el = $("currentWord");
        el.textContent = word || "‚Äï";
        el.style.animation = "none";
        el.offsetHeight;
        el.style.animation = "";
      }

      function renderPlayers(players, scores, lives) {
        const list = $("playerList");
        list.innerHTML = "";
        let items = [];
        if (
          Array.isArray(players) &&
          players.length > 0 &&
          typeof players[0] === "object"
        ) {
          items = players.map((p) => ({
            name: p.name,
            score: p.score || 0,
            lives: p.lives !== undefined ? p.lives : maxLives,
          }));
        } else {
          const arr = Array.isArray(players) ? players : Object.keys(players);
          items = arr.map((p) => ({
            name: p,
            score: (scores && scores[p]) || 0,
            lives: lives && lives[p] !== undefined ? lives[p] : maxLives,
          }));
        }
        items.sort((a, b) => b.score - a.score);
        items.forEach((p) => {
          const li = document.createElement("li");
          li.className = "player-item";
          if (p.lives <= 0) li.style.opacity = "0.4";
          const heartsStr =
            p.lives > 0 ? "‚ù§Ô∏è".repeat(Math.min(p.lives, 10)) : "üíÄ";
          li.innerHTML = `<span class="player-name-display">${esc(p.name)}${p.name === myName ? " üëà" : ""}</span>
      <span class="player-lives">${heartsStr}</span>
      <span class="player-score">${p.score}ÁÇπ</span>`;
          list.appendChild(li);
        });
      }

      function onPlayerJoined(name) {
        addMessage(`${name}„Åï„Çì„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`, "info");
        // Add to game player list
        const list = $("playerList");
        const exists = [...list.children].some((li) =>
          li.querySelector(".player-name-display").textContent.startsWith(name),
        );
        if (!exists) {
          const li = document.createElement("li");
          li.className = "player-item fade-in";
          li.innerHTML = `<span class="player-name-display">${esc(name)}</span><span class="player-score">0ÁÇπ</span>`;
          list.appendChild(li);
        }
        // Update waiting room
        if (!waitingPlayers.includes(name)) waitingPlayers.push(name);
        updateWaitingRoom();
      }

      function onTurnUpdate(msg) {
        if (msg.turnOrder) turnOrder = msg.turnOrder;
        if (msg.currentTurn) currentTurn = msg.currentTurn;
        if (msg.lives) currentLives = msg.lives;
        if (msg.maxLives) maxLives = msg.maxLives;
        updateTurnDisplay();
        renderPlayers(turnOrder, msg.scores || {}, currentLives);
      }

      function onPlayerLeft(name) {
        addMessage(`${name}„Åï„Çì„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü`, "error");
        const list = $("playerList");
        [...list.children].forEach((li) => {
          if (
            li
              .querySelector(".player-name-display")
              .textContent.startsWith(name)
          )
            li.remove();
        });
        // Update waiting room
        waitingPlayers = waitingPlayers.filter((n) => n !== name);
        updateWaitingRoom();
        if (currentRoomId && waitingPlayers.length === 0) {
          setTimeout(() => {
            if (currentRoomId && waitingPlayers.length === 0) {
              showView("lobby");
              refreshRooms();
            }
          }, 500);
        }
      }

      function startGame() {
        send({ type: "start_game" });
      }

      function onGameStarted(msg) {
        showActiveGame(true);
        $("historyList").innerHTML = "";
        setCurrentWord(msg.currentWord || msg.firstWord || "");
        if (msg.turnOrder) turnOrder = msg.turnOrder;
        if (msg.currentTurn) currentTurn = msg.currentTurn;
        if (msg.lives) currentLives = msg.lives;
        if (msg.maxLives) maxLives = msg.maxLives;
        isVoteActive = false;
        lastWordPlayer = "";
        updateMyLives();
        updateTurnDisplay();
        // Initialize timer display
        if (msg.timeLimit && msg.timeLimit > 0) {
          timerMax = msg.timeLimit;
          onTimer(msg.timeLimit);
        }
        if (msg.currentTurn === myName) {
          addMessage(
            "„Ç≤„Éº„É†„ÅåÂßã„Åæ„Çä„Åæ„Åó„ÅüÔºÅÊúÄÂàù„ÅÆ„Åì„Å®„Å∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
            "success",
          );
        } else {
          addMessage(
            `„Ç≤„Éº„É†„ÅåÂßã„Åæ„Çä„Åæ„Åó„ÅüÔºÅ${esc(msg.currentTurn)}„Åï„Çì„ÅåÊúÄÂàù„ÅÆ„Åì„Å®„Å∞„ÇíÈÅ∏„Å≥„Åæ„Åô`,
            "success",
          );
        }
        $("playAgainBtn")?.classList.remove("hidden");
        $("playAgainWait")?.classList.add("hidden");
        $("gameOver").classList.add("hidden");
      }

      function submitAnswer() {
        const input = $("answerInput");
        const word = input.value.trim();
        if (!word) return;
        send({ type: "answer", word });
        input.value = "";
        input.focus();
      }

      function onNewWord(msg) {
        setCurrentWord(msg.word);
        lastWordPlayer = msg.player;
        addHistoryItem(msg.word, msg.player);
        if (msg.lives) currentLives = msg.lives;
        if (msg.scores || msg.lives)
          updateScoresAndLives(msg.scores, msg.lives);
        if (msg.currentTurn) currentTurn = msg.currentTurn;
        updateMyLives();
        updateTurnDisplay();
        addMessage(`${msg.player}„Åï„Çì„ÅåÊ≠£Ëß£ÔºÅ„Äå${msg.word}„Äç`, "success");
        showScorePopup(msg.player);
      }

      function addHistoryItem(word, player) {
        const list = $("historyList");
        const li = document.createElement("li");
        li.className = "history-item";
        li.innerHTML = `<span class="history-word">${esc(word)}</span>
    <span class="history-player">${esc(player)}</span>`;
        list.prepend(li);
      }

      function updateScores(scores) {
        updateScoresAndLives(scores, null);
      }

      function updateScoresAndLives(scores, lives) {
        if (lives) currentLives = lives;
        const list = $("playerList");
        const playerNames = [...list.children].map((li) =>
          li
            .querySelector(".player-name-display")
            .textContent.replace(" üëà", ""),
        );
        const items = playerNames.map((name) => ({
          name,
          score:
            scores && scores[name] !== undefined
              ? scores[name]
              : parseInt(
                  [...list.children]
                    .find(
                      (li) =>
                        li
                          .querySelector(".player-name-display")
                          .textContent.replace(" üëà", "") === name,
                    )
                    ?.querySelector(".player-score")?.textContent,
                ) || 0,
          lives:
            currentLives && currentLives[name] !== undefined
              ? currentLives[name]
              : maxLives,
        }));
        items.sort((a, b) => b.score - a.score);
        list.innerHTML = "";
        items.forEach((p) => {
          const li = document.createElement("li");
          li.className = "player-item";
          if (p.lives <= 0) li.style.opacity = "0.4";
          const heartsStr =
            p.lives > 0 ? "‚ù§Ô∏è".repeat(Math.min(p.lives, 10)) : "üíÄ";
          li.innerHTML = `<span class="player-name-display">${esc(p.name)}${p.name === myName ? " üëà" : ""}</span>
      <span class="player-lives">${heartsStr}</span>
      <span class="player-score">${p.score}ÁÇπ</span>`;
          list.appendChild(li);
        });
      }

      function onInvalid(reason) {
        addMessage(reason, "error");
        const input = $("answerInput");
        input.style.animation = "shake .4s ease";
        input.style.borderColor = "var(--danger)";
        setTimeout(() => {
          input.style.animation = "";
          input.style.borderColor = "";
        }, 500);
      }

      function onTimer(seconds) {
        const section = $("timerSection");
        section.classList.remove("hidden");
        const text = $("timerText");
        const bar = $("timerBar");
        const pct = timerMax > 0 ? (seconds / timerMax) * 100 : 100;
        text.textContent = seconds + "Áßí";
        bar.style.width = pct + "%";
        text.className = "timer-text";
        bar.className = "timer-bar-inner";
        if (seconds <= 5) {
          text.classList.add("danger");
          bar.classList.add("danger");
        } else if (seconds <= 10) {
          text.classList.add("warning");
          bar.classList.add("warning");
        }
      }

      function onGameOver(msg) {
        const overlay = $("gameOver");
        overlay.classList.remove("hidden");
        let reason = msg.reason || "";
        if (msg.winner) {
          reason =
            `üèÜ ${msg.winner}„Åï„Çì„ÅÆÂãùÂà©ÔºÅ` +
            (msg.loser ? ` (${msg.loser}„Åï„ÇìËÑ±ËêΩ)` : "");
        } else if (msg.loser) {
          reason = `${msg.loser}„Åï„Çì - ${reason}`;
        }
        $("gameOverReason").textContent = reason;
        const list = $("finalScores");
        list.innerHTML = "";
        const scores = msg.scores || {};
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const medals = ["ü•á", "ü•à", "ü•â"];
        sorted.forEach(([name, score], i) => {
          const li = document.createElement("li");
          li.className = "final-score-item";
          li.innerHTML = `<span class="final-rank">${medals[i] || i + 1}</span>
      <span class="final-name">${esc(name)}</span>
      <span class="final-pts">${score}ÁÇπ</span>`;
          list.appendChild(li);
        });
        clearInterval(timerInterval);
        $("timerSection").classList.add("hidden");

        // Render history in game-over card
        const history = msg.history || [];
        $("gameOverHistoryCount").textContent = history.length;
        const hList = $("gameOverHistoryList");
        hList.innerHTML = "";
        history.forEach((h, i) => {
          const li = document.createElement("li");
          li.innerHTML = `<span class="game-over-history-num">${i + 1}.</span>
      <span class="game-over-history-word">${esc(h.word)}</span>
      <span class="game-over-history-player">${esc(h.player)}</span>`;
          hList.appendChild(li);
        });
        // Show word chain summary
        const chain = history.map((h) => h.word).join(" ‚Üí ");
        const chainEl = $("gameOverHistoryChain");
        if (history.length > 0) {
          chainEl.textContent = chain;
          chainEl.style.display = "";
        } else {
          chainEl.style.display = "none";
        }
        // Reset toggle state (collapsed)
        const body = $("gameOverHistoryBody");
        body.classList.remove("open");
        const toggle = body.previousElementSibling;
        toggle.classList.remove("open");

        // Show share section using server-provided result ID
        lastShareURL = "";
        $("shareSection").style.display = "none";
        const shareCopyBtn = $("shareCopyBtn");
        shareCopyBtn.classList.remove("copied");
        shareCopyBtn.innerHTML =
          '<span class="share-icon">\ud83d\udd17</span> \u30ea\u30f3\u30af\u30b3\u30d4\u30fc';

        if (msg.resultId) {
          lastShareURL = location.origin + "/results/" + msg.resultId;
          $("shareSection").style.display = "";
        } else {
          // Fallback: save via API (e.g. if server didn't include resultId)
          saveResultForSharing(msg);
        }

        // Populate settings panel for game-over screen
        populateGameOverSettings();
      }

      async function saveResultForSharing(msg) {
        try {
          const payload = {
            roomName: currentSettings.name || "\u3057\u308a\u3068\u308a",
            genre: currentSettings.genre || "",
            winner: msg.winner || "",
            reason: msg.reason || "",
            scores: msg.scores || {},
            history: msg.history || [],
            lives: msg.lives || {},
          };
          const resp = await fetch("/api/results", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error("save failed");
          const data = await resp.json();
          lastShareURL = location.origin + "/results/" + data.id;
          $("shareSection").style.display = "";
        } catch (e) {
          console.error("Failed to save result:", e);
        }
      }

      function buildShareText(msg) {
        const history = msg || [];
        const words =
          typeof history[0] === "object" ? history.map((h) => h.word) : [];
        // Use the stored game-over history from the DOM
        const hList = $("gameOverHistoryList");
        const wordEls = hList.querySelectorAll(".game-over-history-word");
        const ws = Array.from(wordEls).map((el) => el.textContent);
        const count = ws.length;

        let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
        // Show chain (truncate for tweet)
        const chain = ws.join(" \u2192 ");
        const maxLen = 200;
        if (chain.length > maxLen) {
          text += chain.substring(0, maxLen) + "\u2026\n";
        } else {
          text += chain + "\n";
        }
        return text;
      }

      function shareToX() {
        if (!lastShareURL) return;
        const hList = $("gameOverHistoryList");
        const ws = Array.from(
          hList.querySelectorAll(".game-over-history-word"),
        ).map((el) => el.textContent);
        const count = ws.length;
        const chain = ws.join(" \u2192 ");
        let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
        // Truncate chain to fit in tweet (280 - url - prefix ~ 200 chars for chain)
        if ([...chain].length > 140) {
          text += [...chain].slice(0, 137).join("") + "\u2026\n";
        } else {
          text += chain + "\n";
        }
        const url = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(lastShareURL)}`;
        window.open(url, "_blank", "width=550,height=420");
      }

      function shareToLINE() {
        if (!lastShareURL) return;
        const hList = $("gameOverHistoryList");
        const ws = Array.from(
          hList.querySelectorAll(".game-over-history-word"),
        ).map((el) => el.textContent);
        const count = ws.length;
        const chain = ws.join(" \u2192 ");
        let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
        if ([...chain].length > 200) {
          text += [...chain].slice(0, 197).join("") + "\u2026\n";
        } else {
          text += chain + "\n";
        }
        text += lastShareURL;
        const url = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(lastShareURL)}&text=${encodeURIComponent(text)}`;
        window.open(url, "_blank", "width=550,height=420");
      }

      async function shareLink() {
        if (!lastShareURL) return;
        try {
          await navigator.clipboard.writeText(lastShareURL);
          const btn = $("shareCopyBtn");
          btn.classList.add("copied");
          btn.innerHTML =
            '<span class="share-icon">\u2714</span> \u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f';
          setTimeout(() => {
            btn.classList.remove("copied");
            btn.innerHTML =
              '<span class="share-icon">\ud83d\udd17</span> \u30ea\u30f3\u30af\u30b3\u30d4\u30fc';
          }, 2000);
        } catch {
          prompt("\u30ea\u30f3\u30af\u3092\u30b3\u30d4\u30fc:", lastShareURL);
        }
      }

      function toggleGameOverHistory(btn) {
        btn.classList.toggle("open");
        $("gameOverHistoryBody").classList.toggle("open");
      }

      function toggleGameOverSettings(btn) {
        btn.classList.toggle("open");
        $("gameOverSettingsBody").classList.toggle("open");
      }

      function populateGameOverSettings() {
        const s = currentSettings;
        $("goMinLen").value = s.minLen || 1;
        $("goMaxLen").value = s.maxLen || 0;
        $("goGenre").value = s.genre || "";
        // Set select values
        $("goTimeLimit").value = String(s.timeLimit || 0);
        $("goMaxLives").value = String(s.maxLives || 3);
        $("goNoDakuten").checked = !!s.noDakuten;

        // Render kana row checkboxes for game-over settings
        const container = $("goKanaRowCheckboxes");
        if (container && kanaRowNames.length) {
          container.innerHTML = "";
          const allowed = s.allowedRows || [];
          kanaRowNames.forEach((name) => {
            const label = document.createElement("label");
            label.className = "kana-row-chip";
            const checked = allowed.includes(name);
            label.innerHTML = `<input type="checkbox" value="${esc(name)}"${checked ? " checked" : ""}> ${esc(name)}`;
            if (checked) label.classList.add("selected");
            label.addEventListener("click", () => {
              setTimeout(() => {
                const cb = label.querySelector("input");
                label.classList.toggle("selected", cb.checked);
                checkSettingsChanged();
              }, 0);
            });
            container.appendChild(label);
          });
        }

        // Listen for changes to show badge
        ["goMinLen", "goMaxLen", "goGenre", "goTimeLimit", "goMaxLives", "goNoDakuten"].forEach((id) => {
          const el = $(id);
          if (el) el.addEventListener("input", checkSettingsChanged);
          if (el) el.addEventListener("change", checkSettingsChanged);
        });

        // Show/hide settings panel (only for owner)
        $("gameOverSettings").style.display = (myName === roomOwner) ? "" : "none";
        // Reset changed badge
        $("settingsChangedBadge").classList.remove("visible");
        // Collapse panel
        $("gameOverSettingsBody").classList.remove("open");
        const toggle = $("gameOverSettingsBody").previousElementSibling;
        toggle.classList.remove("open");
      }

      function getGameOverSettings() {
        const goRows = Array.from(
          document.querySelectorAll("#goKanaRowCheckboxes input[type=checkbox]:checked")
        ).map((cb) => cb.value);
        return {
          name: currentSettings.name || "„Åó„Çä„Å®„Çä„É´„Éº„É†",
          minLen: parseInt($("goMinLen").value) || 1,
          maxLen: parseInt($("goMaxLen").value) || 0,
          genre: $("goGenre").value,
          timeLimit: parseInt($("goTimeLimit").value) || 0,
          maxLives: parseInt($("goMaxLives").value) || 3,
          allowedRows: goRows.length > 0 ? goRows : undefined,
          noDakuten: $("goNoDakuten").checked || undefined,
          private: currentSettings.private || undefined,
        };
      }

      function checkSettingsChanged() {
        const newS = getGameOverSettings();
        const s = currentSettings;
        const changed =
          newS.minLen !== (s.minLen || 1) ||
          newS.maxLen !== (s.maxLen || 0) ||
          newS.genre !== (s.genre || "") ||
          newS.timeLimit !== (s.timeLimit || 0) ||
          newS.maxLives !== (s.maxLives || 3) ||
          !!newS.noDakuten !== !!s.noDakuten ||
          JSON.stringify(newS.allowedRows || []) !== JSON.stringify(s.allowedRows || []);
        $("settingsChangedBadge").classList.toggle("visible", changed);
        // Update button text
        $("playAgainBtn").textContent = changed ? "üîÑ „É´„Éº„É´Â§âÊõ¥„Åó„Å¶ÈñãÂßã" : "üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶";
      }

      function playAgain() {
        if (myName !== roomOwner) {
          $("playAgainBtn")?.classList.add("hidden");
          $("playAgainWait")?.classList.remove("hidden");
          addMessage("„Éõ„Çπ„Éà„ÅÆÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶", "info");
          return;
        }
        // Check if settings were changed
        const newS = getGameOverSettings();
        const s = currentSettings;
        const changed =
          newS.minLen !== (s.minLen || 1) ||
          newS.maxLen !== (s.maxLen || 0) ||
          newS.genre !== (s.genre || "") ||
          newS.timeLimit !== (s.timeLimit || 0) ||
          newS.maxLives !== (s.maxLives || 3) ||
          !!newS.noDakuten !== !!s.noDakuten ||
          JSON.stringify(newS.allowedRows || []) !== JSON.stringify(s.allowedRows || []);
        if (changed) {
          send({ type: "start_game", settings: newS });
        } else {
          send({ type: "start_game" });
        }
      }

      function backToLobby() {
        $("gameOver").classList.add("hidden");
        leaveRoom();
      }

      function leaveRoom() {
        send({ type: "leave_room" });
        currentRoomId = "";
        showView("lobby");
        refreshRooms();
        document.body.classList.toggle("invite-lobby", !!inviteRoomId);
      }

      function handleInviteFromURL() {
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get("room");
        if (roomId) {
          setInviteRoom(roomId);
          loadInviteRoomInfo(roomId, true);
        } else {
          $("inviteCard").classList.add("hidden");
          clearInviteRoomInfo();
          document.body.classList.remove("invite-lobby");
        }
      }

      function loadInviteRoomInfo(roomId, showPreviewOnly) {
        if (!roomId) return;
        fetch(`/room/${encodeURIComponent(roomId)}`)
          .then((res) => (res.ok ? res.json() : null))
          .then((data) => {
            if (!data) return;
            if (showPreviewOnly) {
              renderInviteRoomInfo(data);
              return;
            }
            prepareWaitingRoom(data);
            renderInviteRoomInfo(data);
          })
          .catch(() => {});
      }

      function showInviteRoomPreview(roomId) {
        setInviteRoom(roomId);
        const url = new URL(window.location.href);
        url.searchParams.set("room", roomId);
        window.history.replaceState({}, "", url.toString());
        loadInviteRoomInfo(roomId, true);
      }

      /* ========== MESSAGES ========== */
      function addMessage(text, type) {
        const list = $("messageList");
        if (!list) return;
        const li = document.createElement("li");
        li.className = "msg-item" + (type ? ` msg-${type}` : "");
        const now = new Date();
        const ts = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
        li.textContent = `[${ts}] ${text}`;
        list.appendChild(li);
        list.scrollTop = list.scrollHeight;
      }

      /* ========== UI HELPERS ========== */
      function showView(view) {
        $("lobby").classList.toggle("hidden", view !== "lobby");
        $("game").classList.toggle("hidden", view !== "game");
        document.body.classList.toggle(
          "invite-view",
          view === "game" && !myName,
        );
        document.body.classList.toggle(
          "invite-lobby",
          view === "lobby" && !!inviteRoomId,
        );
      }

      function showScorePopup(player) {
        const el = document.createElement("div");
        el.className = "score-popup";
        el.textContent = "+1";
        el.style.left = Math.random() * 60 + 20 + "%";
        el.style.top = "40%";
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
      }

      /* ========== VOTE ========== */
      let currentVotePlayerName = ""; // the challenged player in challenge votes

      function onVoteRequest(msg) {
        const isGenre = msg.voteType === "genre";
        const isChallenge = msg.voteType === "challenge";
        currentVotePlayerName = isChallenge ? msg.player : "";

        // Determine if this user is the challenged player
        const isChallengedPlayer = isChallenge && msg.player === myName;
        if (isChallenge) {
          hasVoted = msg.challenger === myName; // challenger auto-voted reject
        } else {
          hasVoted = msg.player === myName; // submitter auto-voted accept
        }
        $("voteTitle").textContent = isChallenge
          ? "üó≥Ô∏è ÂçòË™ûÊåáÊëò„ÅÆÊäïÁ•®"
          : "üó≥Ô∏è „Ç∏„É£„É≥„É´ÊäïÁ•®";
        $("voteWord").textContent = msg.word;
        if (isChallenge) {
          $("voteQuestion").textContent =
            `${msg.challenger}„Åï„Çì„Åå„Äå${msg.word}„Äç„ÇíÊåáÊëò„Åó„Åæ„Åó„Åü`;
          $("voteGenreHint").textContent =
            msg.reason || "„Åì„ÅÆÂçòË™û„ÇíË™ç„ÇÅ„Åæ„Åô„ÅãÔºü";
        } else {
          $("voteQuestion").textContent =
            `${msg.player}„Åï„Çì„Åå„Äå${msg.word}„Äç„ÇíÂÖ•Âäõ„Åó„Åæ„Åó„Åü`;
          $("voteGenreHint").textContent =
            `„Ç∏„É£„É≥„É´„Äå${msg.genre}„Äç„ÅÆ„É™„Çπ„Éà„Å´„Å™„ÅÑÂçòË™û„Åß„Åô„ÄÇË™ç„ÇÅ„Åæ„Åô„ÅãÔºü`;
        }
        updateVoteProgress(msg.voteCount || 0, msg.totalPlayers || 0);
        isVoteActive = true;
        $("voteOverlay").classList.remove("hidden");
        updateTurnDisplay();

        // Reset rebuttal display
        $("rebuttalDisplay").classList.add("hidden");
        $("rebuttalDisplay").innerHTML = "";

        // Determine if this user is the challenger
        const isChallenger = isChallenge && msg.challenger === myName;

        if (isChallengedPlayer) {
          // Challenged player: show rebuttal input instead of vote buttons
          $("voteButtonArea").classList.add("hidden");
          $("voteWaiting").classList.add("hidden");
          $("withdrawArea").classList.add("hidden");
          $("rebuttalArea").classList.remove("hidden");
          $("rebuttalInput").value = "";
          setTimeout(() => $("rebuttalInput").focus(), 100);
        } else if (hasVoted) {
          $("voteButtonArea").classList.add("hidden");
          $("rebuttalArea").classList.add("hidden");
          $("voteWaiting").classList.remove("hidden");
          // Show withdraw button for the challenger
          if (isChallenger) {
            $("withdrawArea").classList.remove("hidden");
          } else {
            $("withdrawArea").classList.add("hidden");
          }
        } else {
          $("voteButtonArea").classList.remove("hidden");
          $("rebuttalArea").classList.add("hidden");
          $("withdrawArea").classList.add("hidden");
          $("voteWaiting").classList.add("hidden");
        }

        // Vote countdown timer
        let voteTimeLeft = 15;
        $("voteTimer").textContent = `${voteTimeLeft}Áßí„ÅßËá™ÂãïÂà§ÂÆö`;
        clearInterval(voteTimerInterval);
        voteTimerInterval = setInterval(() => {
          voteTimeLeft--;
          if (voteTimeLeft <= 0) {
            clearInterval(voteTimerInterval);
            $("voteTimer").textContent = "Âà§ÂÆö‰∏≠‚Ä¶";
          } else {
            $("voteTimer").textContent = `${voteTimeLeft}Áßí„ÅßËá™ÂãïÂà§ÂÆö`;
          }
        }, 1000);
      }

      function onVoteUpdate(msg) {
        updateVoteProgress(msg.voteCount || 0, msg.totalPlayers || 0);
      }

      function updateVoteProgress(count, total) {
        $("voteProgressText").textContent = `${count} / ${total} ÊäïÁ•®Ê∏à„Åø`;
        const pct = total > 0 ? (count / total) * 100 : 0;
        $("voteProgressBar").style.width = pct + "%";
      }

      function onVoteResult(msg) {
        clearInterval(voteTimerInterval);
        isVoteActive = false;
        currentVotePlayerName = "";
        $("voteOverlay").classList.add("hidden");
        $("rebuttalArea").classList.add("hidden");
        $("rebuttalDisplay").classList.add("hidden");
        $("withdrawArea").classList.add("hidden");
        // Reset rebuttal input state
        const rebInput = $("rebuttalInput");
        rebInput.disabled = false;
        rebInput.placeholder = "ÂèçË´ñ„ÇíÂÖ•Âäõ‚Ä¶";
        const rebBtn = rebInput.parentElement.querySelector(".btn");
        if (rebBtn) rebBtn.disabled = false;
        if (msg.accepted) {
          addMessage(
            msg.message || `ÊäïÁ•®„Å´„Çà„Çä„Äå${msg.word}„Äç„ÅåÊâøË™ç„Åï„Çå„Åæ„Åó„Åü`,
            "success",
          );
        } else {
          addMessage(
            msg.message || `ÊäïÁ•®„Å´„Çà„Çä„Äå${msg.word}„Äç„ÅØÂç¥‰∏ã„Åï„Çå„Åæ„Åó„Åü`,
            "error",
          );
          if (msg.reverted) {
            if (msg.currentWord !== undefined)
              setCurrentWord(msg.currentWord || "");
            if (msg.history) {
              $("historyList").innerHTML = "";
              (msg.history || []).forEach((h) =>
                addHistoryItem(h.word, h.player),
              );
            }
            if (msg.scores || msg.lives)
              updateScoresAndLives(msg.scores, msg.lives);
            if (msg.currentTurn) currentTurn = msg.currentTurn;
            // Show penalty info for challenge rejection
            if (msg.penaltyPlayer) {
              if (msg.lives) currentLives = msg.lives;
              if (msg.eliminated) {
                addMessage(`üíÄ ${msg.penaltyPlayer}„Åï„Çì„ÅåËÑ±ËêΩÔºÅ`, "error");
                if (msg.penaltyPlayer === myName) {
                  addMessage("üíÄ „ÅÇ„Å™„Åü„ÅØËÑ±ËêΩ„Åó„Åæ„Åó„Åü‚Ä¶", "error");
                }
              } else {
                addMessage(
                  `üíî ${msg.penaltyPlayer}„Åï„Çì„Åå„É©„Ç§„Éï-1ÔºÅÊÆã„Çä${msg.penaltyLives}`,
                  "error",
                );
                if (msg.penaltyPlayer === myName) {
                  document.body.style.animation = "shake .4s ease";
                  setTimeout(() => (document.body.style.animation = ""), 500);
                }
              }
            }
            updateMyLives();
            updateTurnDisplay();
          }
        }
        updateTurnDisplay();
      }

      function castVote(accept) {
        if (hasVoted) return;
        hasVoted = true;
        send({ type: "vote", accept });
        $("voteButtonArea").classList.add("hidden");
        $("voteWaiting").classList.remove("hidden");
      }

      function withdrawChallenge() {
        send({ type: "withdraw_challenge" });
      }

      function onChallengeWithdrawn(msg) {
        clearInterval(voteTimerInterval);
        isVoteActive = false;
        currentVotePlayerName = "";
        $("voteOverlay").classList.add("hidden");
        $("rebuttalArea").classList.add("hidden");
        $("rebuttalDisplay").classList.add("hidden");
        $("withdrawArea").classList.add("hidden");
        // Reset rebuttal input state
        const rebInput = $("rebuttalInput");
        rebInput.disabled = false;
        rebInput.placeholder = "ÂèçË´ñ„ÇíÂÖ•Âäõ‚Ä¶";
        const rebBtn = rebInput.parentElement.querySelector(".btn");
        if (rebBtn) rebBtn.disabled = false;
        addMessage(msg.message || "ÊåáÊëò„ÅåÂèñ„Çä‰∏ã„Åí„Çâ„Çå„Åæ„Åó„Åü", "info");
        updateTurnDisplay();
      }

      function sendRebuttal() {
        const input = $("rebuttalInput");
        const text = (input.value || "").trim();
        if (!text) return;
        send({ type: "rebuttal", rebuttal: text });
        input.value = "";
        input.placeholder = "ÈÄÅ‰ø°Ê∏à„Åø ‚úì";
        input.disabled = true;
        input.parentElement.querySelector(".btn").disabled = true;
      }

      function onRebuttal(msg) {
        const display = $("rebuttalDisplay");
        const div = document.createElement("div");
        div.style.marginBottom = ".3rem";
        div.innerHTML = `<span class="rebuttal-sender">${esc(msg.player)}:</span> ${esc(msg.rebuttal)}`;
        display.appendChild(div);
        display.classList.remove("hidden");
        addMessage(`üí¨ ${msg.player}„ÅÆÂèçË´ñ: ${msg.rebuttal}`, "info");
      }

      function onPenalty(msg) {
        if (msg.allLives) currentLives = msg.allLives;
        updateScoresAndLives(null, msg.allLives);
        updateMyLives(msg.player === myName);

        const livesLeft = msg.lives !== undefined ? msg.lives : "?";
        if (msg.eliminated) {
          addMessage(`üíÄ ${msg.player}„Åï„Çì„ÅåËÑ±ËêΩÔºÅ„Äå${msg.reason}„Äç`, "error");
          if (msg.player === myName) {
            addMessage("üíÄ „ÅÇ„Å™„Åü„ÅØËÑ±ËêΩ„Åó„Åæ„Åó„Åü‚Ä¶", "error");
          }
        } else {
          addMessage(
            `üíî ${msg.player}„Åï„Çì„Åå„É©„Ç§„Éï-1ÔºÅÊÆã„Çä${livesLeft} „Äå${msg.reason}„Äç`,
            "error",
          );
          if (msg.player === myName) {
            document.body.style.animation = "shake .4s ease";
            setTimeout(() => (document.body.style.animation = ""), 500);
          }
        }
      }

      /* ========== MY LIVES DISPLAY ========== */
      function updateMyLives(animate) {
        const container = $("myLivesHearts");
        if (!container) return;
        const myLivesCount =
          currentLives && currentLives[myName] !== undefined
            ? currentLives[myName]
            : maxLives;
        container.innerHTML = "";
        for (let i = 0; i < maxLives; i++) {
          const span = document.createElement("span");
          span.className = "heart";
          if (i < myLivesCount) {
            span.textContent = "‚ù§Ô∏è";
          } else {
            span.textContent = "ü§ç";
            span.classList.add("lost");
            // Animate the most recently lost heart
            if (animate && i === myLivesCount) {
              span.classList.add("breaking");
            }
          }
          container.appendChild(span);
        }
      }

      function esc(str) {
        const d = document.createElement("div");
        d.textContent = str;
        return d.innerHTML;
      }

      function requestChallenge() {
        if (isVoteActive) return;
        if (lastWordPlayer === myName) {
          addMessage("Ëá™ÂàÜ„ÅÆÂçòË™û„Å´„ÅØÊåáÊëò„Åß„Åç„Åæ„Åõ„Çì", "error");
          return;
        }
        send({ type: "challenge" });
      }

      /* ========== KEYBOARD ========== */
      $("answerInput")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitAnswer();
        }
      });
      $("rebuttalInput")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendRebuttal();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !$("lobby").classList.contains("hidden")) {
          return;
        }
      });

      /* ========== HIRAGANA-ONLY INPUT FILTER ========== */
      (function () {
        // Convert katakana to hiragana
        function katakanaToHiragana(str) {
          return str.replace(/[\u30A1-\u30F6]/g, function (ch) {
            return String.fromCharCode(ch.charCodeAt(0) - 0x60);
          });
        }
        // Check if a character is allowed: hiragana, katakana, or long vowel mark
        function isAllowedChar(ch) {
          var code = ch.charCodeAt(0);
          // Hiragana: U+3040-U+309F
          if (code >= 0x3040 && code <= 0x309f) return true;
          // Katakana: U+30A0-U+30FF
          if (code >= 0x30a0 && code <= 0x30ff) return true;
          // Long vowel mark
          if (ch === "\u30FC") return true;
          return false;
        }
        // Filter and convert input value
        function filterInput(input) {
          var pos = input.selectionStart;
          var original = input.value;
          // Keep only allowed characters
          var filtered = "";
          for (var i = 0; i < original.length; i++) {
            if (isAllowedChar(original[i])) filtered += original[i];
          }
          // Convert katakana to hiragana
          var converted = katakanaToHiragana(filtered);
          if (converted !== original) {
            var diff = original.length - converted.length;
            input.value = converted;
            // Adjust cursor position
            var newPos = Math.max(0, pos - diff);
            input.setSelectionRange(newPos, newPos);
          }
        }

        var answerInput = $("answerInput");
        if (answerInput) {
          var isComposing = false;
          answerInput.addEventListener("compositionstart", function () {
            isComposing = true;
          });
          answerInput.addEventListener("compositionend", function () {
            isComposing = false;
            filterInput(answerInput);
          });
          answerInput.addEventListener("input", function () {
            if (!isComposing) {
              filterInput(answerInput);
            }
          });
        }
      })();

      /* ========== INIT ========== */
      connect();
      handleInviteFromURL();
      window.addEventListener("popstate", handleInviteFromURL);
      // Refresh rooms periodically
      setInterval(() => {
        if (!$("lobby").classList.contains("hidden")) refreshRooms();
      }, 5000);

      // Toggle lobby buttons based on playerName input
      function updateLobbyButtons() {
        const hasName = $("playerName").value.trim().length > 0;
        document.querySelectorAll("[data-lobby-btn] .btn").forEach((btn) => {
          // Don't touch buttons disabled for other reasons (e.g. playing rooms)
          if (btn.hasAttribute("data-playing")) return;
          if (hasName) {
            btn.removeAttribute("disabled");
          } else {
            btn.setAttribute("disabled", "");
          }
        });
      }
      $("playerName").addEventListener("input", updateLobbyButtons);
      updateLobbyButtons();

      // ‚îÄ‚îÄ Theme Switcher ‚îÄ‚îÄ
      (function initThemeSwitcher() {
        var current = localStorage.getItem("shiritori-theme") || "default";
        var btns = document.querySelectorAll(".theme-btn");
        var cssLink = document.getElementById("themeCSS");
        var toggle = document.getElementById("themeToggle");
        var panel = document.getElementById("themePanel");

        function applyTheme(name) {
          document.documentElement.setAttribute("data-theme", name);
          localStorage.setItem("shiritori-theme", name);
          if (name === "default") {
            cssLink.href = "";
          } else {
            cssLink.href = "/static/themes/" + name + ".css";
          }
          btns.forEach(function (b) {
            b.classList.toggle("active", b.getAttribute("data-theme") === name);
          });
        }

        // Init active state
        btns.forEach(function (b) {
          if (b.getAttribute("data-theme") === current)
            b.classList.add("active");
          b.addEventListener("click", function () {
            applyTheme(this.getAttribute("data-theme"));
            panel.classList.remove("open");
          });
        });

        // Toggle panel
        toggle.addEventListener("click", function (e) {
          e.stopPropagation();
          panel.classList.toggle("open");
        });

        // Close on outside click
        document.addEventListener("click", function (e) {
          if (!panel.contains(e.target) && e.target !== toggle) {
            panel.classList.remove("open");
          }
        });
      })();
    </script>
  </body>
</html>
