<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã—ã‚Šã¨ã‚Š - ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Antique&family=Shippori+Mincho:wght@400;700&family=Zen+Maru+Gothic:wght@400;500;700&family=DotGothic16&family=RocknRoll+One&family=Kosugi+Maru&family=Shippori+Mincho+B1:wght@400;700&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
<link id="themeCSS" rel="stylesheet" href="">
<script>
(function(){
  var t=localStorage.getItem('shiritori-theme')||'default';
  document.documentElement.setAttribute('data-theme',t);
  if(t!=='default'){
    document.getElementById('themeCSS').href='/static/themes/'+t+'.css';
  }
})();
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#c23a22;--primary-light:#d4604c;--primary-dark:#a12e18;
  --accent:#3d6b5e;--accent-light:#5a8f7e;
  --danger:#b83a2a;--success:#3d6b5e;
  --bg:#f5f0e8;--surface:#faf7f0;--surface2:#ede8dc;
  --text:#2c2420;--text2:#8a7e72;--text3:#c4b8a8;
  --radius:4px;--shadow:0 1px 4px rgba(44,36,32,.08);
  --border:#d8d0c4;
  --font-body:'Zen Maru Gothic','Hiragino Maru Gothic Pro',sans-serif;
  --font-head:'Shippori Mincho',serif;
  --font-display:'Zen Antique',serif;
}
html{font-size:16px}
body{
  font-family:var(--font-body);
  background:var(--bg);
  background-image:
    radial-gradient(ellipse at 20% 50%, rgba(194,58,34,.018) 0%, transparent 70%),
    radial-gradient(ellipse at 80% 20%, rgba(61,107,94,.018) 0%, transparent 70%);
  color:var(--text);
  min-height:100dvh;line-height:1.7;
  position:relative;
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.025'/%3E%3C/svg%3E");
}
body::after{
  content:'\8A00  \8449  \7E4B  \98A8  \82B1  \6708  \96EA  \9CE5  \5922  \9053  \5FC3  \5149';
  position:fixed;bottom:-20%;left:8%;pointer-events:none;z-index:0;
  font-family:'Shippori Mincho',serif;font-size:2.2rem;letter-spacing:1.8rem;
  white-space:nowrap;color:var(--text);opacity:0;
  animation:driftKanji 60s linear infinite;
}
button{font-family:inherit;cursor:pointer;border:none;font-size:.95rem}
input,select{font-family:inherit;font-size:1rem}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{0%{transform:scale(.92);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-4px)}40%,80%{transform:translateX(4px)}}
@keyframes ripple{to{transform:scale(2.5);opacity:0}}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
@keyframes timerPulse{0%,100%{box-shadow:0 0 0 0 rgba(184,58,42,.3)}50%{box-shadow:0 0 0 8px rgba(184,58,42,0)}}
@keyframes wordAppear{0%{opacity:0;transform:scale(.88)}100%{opacity:1;transform:scale(1)}}
@keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes driftKanji{
  0%{transform:translateY(100vh) rotate(0deg);opacity:0}
  10%{opacity:.04}
  90%{opacity:.04}
  100%{transform:translateY(-100vh) rotate(15deg);opacity:0}
}

.fade-in{animation:fadeIn .4s ease both}
.slide-up{animation:slideUp .45s ease both}
.pop-in{animation:popIn .35s ease both}

/* â”€â”€ Layout â”€â”€ */
.container{max-width:860px;margin:0 auto;padding:1rem;position:relative;z-index:1}
.hidden{display:none!important}

/* â”€â”€ Header â”€â”€ */
.header{
  text-align:center;padding:2.5rem 1rem 2rem;
  background:var(--bg);color:var(--text);
  position:relative;overflow:visible;
  border-bottom:1px solid var(--border);
}
.header::after{
  content:'';position:absolute;bottom:-1px;left:5%;right:5%;height:3px;
  background:
    linear-gradient(90deg,
      transparent 0%, rgba(44,36,32,.12) 4%,
      rgba(44,36,32,.25) 12%, rgba(44,36,32,.3) 20%,
      rgba(44,36,32,.15) 32%, rgba(44,36,32,.3) 38%,
      rgba(44,36,32,.28) 55%, transparent 57%,
      rgba(44,36,32,.3) 60%, rgba(44,36,32,.25) 78%,
      rgba(44,36,32,.1) 92%, transparent 100%);
  border-radius:2px;
}
.header h1{
  font-family:var(--font-head);font-size:2.8rem;font-weight:700;
  letter-spacing:.15em;color:var(--text);
}
.header a{color:inherit;text-decoration:none}
.header a:hover{opacity:.8}
.header p{font-size:.85rem;color:var(--text2);margin-top:.4rem;letter-spacing:.08em}

/* â”€â”€ Cards â”€â”€ */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);box-shadow:var(--shadow);
  padding:1.5rem;margin-bottom:1rem;
}
.card h2{
  font-family:var(--font-head);font-size:1.05rem;font-weight:700;
  margin-bottom:1rem;color:var(--text);
  display:flex;align-items:center;gap:.5rem;
  padding-bottom:.6rem;border-bottom:1px solid var(--border);
}
.card h2::before{content:'';width:6px;height:6px;background:var(--primary);border-radius:50%;flex-shrink:0}

/* â”€â”€ Forms â”€â”€ */
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.8rem;font-weight:500;color:var(--text2);margin-bottom:.35rem;letter-spacing:.03em}
.form-group input,.form-group select{
  width:100%;padding:.6rem .2rem;border:none;border-bottom:1.5px solid var(--border);
  border-radius:0;background:transparent;color:var(--text);
  transition:border-color .25s;
}
.form-group input:focus,.form-group select:focus{
  outline:none;border-bottom-color:var(--primary);
}
.form-group select{padding:.6rem 0;cursor:pointer;-webkit-appearance:auto}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
  padding:.6rem 1.4rem;border-radius:var(--radius);font-weight:600;
  transition:all .2s;position:relative;overflow:hidden;letter-spacing:.03em;
}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:hover{background:#2f5548}
.btn-outline{background:transparent;color:var(--primary);border:1.5px solid var(--primary)}
.btn-outline:hover{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#9a2e1e}
.btn-lg{padding:.8rem 2rem;font-size:1.05rem}
.btn-block{width:100%}
.btn:active{transform:scale(.98)}

/* â”€â”€ Lobby â”€â”€ */
#lobby .player-name-section{
  text-align:center;padding:1.5rem 0;
}
#lobby .player-name-section input{
  font-family:var(--font-head);font-size:1.4rem;text-align:center;
  padding:.7rem 0;border:none;border-bottom:2px solid var(--border);
  border-radius:0;background:transparent;max-width:320px;width:100%;
  color:var(--text);letter-spacing:.08em;
}
#lobby .player-name-section input::placeholder{color:var(--text3)}
#lobby .player-name-section input:focus{
  border-bottom-color:var(--primary);outline:none;
}
.invite-card{
  display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap;
  background:var(--surface);border-left:3px solid var(--primary);
}
.invite-card .invite-info{font-weight:600;color:var(--text)}
.invite-card .invite-id{font-size:.9rem;color:var(--text2)}
.invite-card .invite-actions{display:flex;gap:.5rem;flex-wrap:wrap}
.invite-card .invite-room-title{
  font-family:var(--font-head);font-weight:700;font-size:1.05rem;
  margin-bottom:.35rem;color:var(--text);
}
.room-list{list-style:none}
.room-item{
  display:flex;align-items:center;justify-content:space-between;gap:.75rem;
  padding:.9rem;border-bottom:1px dotted var(--border);
  margin-bottom:0;transition:all .2s;
}
.room-item:last-child{border-bottom:none}
.room-item:hover{background:var(--surface2)}
.room-info{flex:1}
.room-name{font-family:var(--font-head);font-weight:700;font-size:1rem;color:var(--text);text-decoration:none}
.room-name:hover{color:var(--primary)}
.room-meta{font-size:.78rem;color:var(--text2);margin-top:.2rem}
.room-meta span{margin-right:.75rem}
.room-actions{display:flex;gap:.5rem;flex-wrap:wrap}
.no-rooms{text-align:center;color:var(--text2);padding:2rem;font-size:.9rem}
.invite-room-title{font-family:var(--font-head);font-weight:700;font-size:1.05rem;margin-bottom:.4rem;color:var(--text)}
.invite-room-rules{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.5rem}
.invite-room-host{font-size:.85rem;color:var(--text2);margin-bottom:.5rem}

/* â”€â”€ Game Room â”€â”€ */
#game{position:relative}
.game-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:.6rem 0;margin-bottom:.5rem;flex-wrap:wrap;gap:.5rem;
  border-bottom:1px solid var(--border);
}
.room-title{font-family:var(--font-head);font-weight:700;font-size:1rem;color:var(--text)}
.game-header-actions{display:flex;gap:.5rem;flex-wrap:wrap}
.game-rules{display:flex;gap:.4rem;flex-wrap:wrap}
.rule-badge{
  font-size:.72rem;padding:.2rem .55rem;border-radius:var(--radius);
  background:var(--surface2);color:var(--text2);font-weight:500;
  border:1px solid var(--border);
}
/* Invite view overrides */
.invite-view #preGame{padding:1.5rem}
.invite-view #preGame .waiting-text{display:none}
.invite-view #preGame .waiting-players{margin-top:0}
.invite-view #preGame #startBtn,
.invite-view #preGame #waitOwnerText{display:none!important}
.invite-view #activeGame{display:none!important}
.invite-view .game-header-actions{display:none!important}
.invite-view .game-body,.invite-view .answer-area,.invite-view .current-word-area,
.invite-view .my-lives-display,.invite-view #turnIndicator,.invite-view #timerSection{display:none!important}
.invite-view .waiting-player-list{min-height:2.5rem}
.invite-view .waiting-empty{color:var(--text2);font-size:.85rem}
.invite-lobby #lobbyCreateCard,.invite-lobby #lobbyRoomsCard{display:none!important}

/* â”€â”€ Current word area â”€â”€ */
.current-word-area{
  text-align:center;padding:2.5rem 1rem;
  background:
    repeating-linear-gradient(90deg, transparent, transparent 2.4rem, var(--border) 2.4rem, var(--border) calc(2.4rem + 1px));
  background-color:var(--surface);
  border:1px solid var(--border);border-radius:var(--radius);
  margin-bottom:1rem;position:relative;
}
.current-word-label{font-size:.8rem;color:var(--text2);margin-bottom:.5rem;letter-spacing:.1em}
.current-word{
  font-family:var(--font-display);font-size:4rem;font-weight:400;
  color:var(--text);animation:wordAppear .4s ease both;
  letter-spacing:.15em;line-height:1.3;
}

/* â”€â”€ Timer â”€â”€ */
.timer-bar{height:3px;background:var(--surface2);border-radius:1px;margin-bottom:.75rem;overflow:hidden}
.timer-bar-inner{height:100%;background:var(--primary);border-radius:1px;transition:width .3s linear}
.timer-bar-inner.warning{background:var(--accent)}
.timer-bar-inner.danger{background:var(--danger);animation:timerPulse 1s infinite}
.timer-text{text-align:center;font-family:var(--font-head);font-size:1.4rem;font-weight:700;margin-bottom:.4rem;color:var(--text)}
.timer-text.warning{color:var(--accent)}
.timer-text.danger{color:var(--danger)}

/* â”€â”€ Answer input â”€â”€ */
.answer-area{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
.answer-area input{
  flex:1;padding:.7rem .5rem;border:none;border-bottom:2px solid var(--border);
  border-radius:0;font-family:var(--font-display);font-size:1.3rem;
  background:transparent;color:var(--text);transition:all .25s;
}
.answer-area input::placeholder{color:var(--text3)}
.answer-area input:focus{border-bottom-color:var(--primary);outline:none}
.answer-area .btn{padding:.7rem 1.3rem;font-size:1rem;min-width:72px}
#challengeBtn{white-space:nowrap}

/* â”€â”€ Game layout â”€â”€ */
.game-body{display:grid;grid-template-columns:1fr 240px;gap:1rem}
@media(max-width:700px){.game-body{grid-template-columns:1fr}}

/* â”€â”€ History â”€â”€ */
.history-panel{}
.history-list{max-height:300px;overflow-y:auto;list-style:none}
.history-list::-webkit-scrollbar{width:3px}
.history-list::-webkit-scrollbar-thumb{background:var(--text3);border-radius:1px}
.history-item{
  display:flex;align-items:center;gap:.75rem;
  padding:.55rem .5rem;border-bottom:1px dotted var(--border);
  animation:slideUp .3s ease both;
}
.history-item:last-child{border-bottom:none}
.history-word{font-family:var(--font-head);font-weight:700;font-size:1.05rem;color:var(--text)}
.history-player{font-size:.78rem;color:var(--text2)}
.history-connector{font-size:.7rem;color:var(--text3);width:20px;text-align:center;flex-shrink:0}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{}
.player-list{list-style:none}
.player-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:.5rem .6rem;margin-bottom:.2rem;transition:background .2s;
  border-radius:var(--radius);
}
.player-item.current-turn{background:var(--surface2)}
.player-item.current-turn .player-name-display::before{content:'\25CF ';color:var(--primary);font-size:.6em}
.player-name-display{font-weight:500;font-size:.88rem}
.player-score{
  font-family:var(--font-head);font-weight:700;color:var(--primary);
  background:var(--surface2);padding:.1rem .45rem;border-radius:var(--radius);font-size:.82rem;
}
.player-lives{font-size:.72rem;margin:0 .25rem}

/* â”€â”€ Messages â”€â”€ */
.messages{max-height:150px;overflow-y:auto;list-style:none;margin-top:.5rem}
.messages::-webkit-scrollbar{width:3px}
.messages::-webkit-scrollbar-thumb{background:var(--text3);border-radius:1px}
.msg-item{font-size:.78rem;color:var(--text2);padding:.25rem 0;border-bottom:1px dotted var(--border)}
.msg-item:last-child{border-bottom:none}
.msg-item.msg-success{color:var(--success)}
.msg-item.msg-error{color:var(--danger)}
.msg-item.msg-info{color:var(--primary)}

/* â”€â”€ Game Over â”€â”€ */
.game-over-overlay{
  position:fixed;inset:0;background:rgba(245,240,232,.8);backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;z-index:100;
  animation:fadeIn .3s ease;
}
.game-over-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:2.5rem;
  text-align:center;max-width:480px;width:90%;animation:popIn .4s ease both;
  box-shadow:0 8px 40px rgba(44,36,32,.1);max-height:90vh;overflow-y:auto;
}
.game-over-card h2{font-family:var(--font-head);font-size:1.6rem;margin-bottom:.5rem;color:var(--text);border-bottom:none;justify-content:center}
.game-over-card h2::before{display:none}
.game-over-reason{color:var(--text2);margin-bottom:1.5rem;font-size:.9rem}
.final-scores{list-style:none;margin-bottom:1.5rem}
.final-score-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:.55rem .9rem;border-bottom:1px dotted var(--border);margin-bottom:0;
}
.final-score-item:first-child{background:linear-gradient(90deg,rgba(194,58,34,.06),transparent);border-left:3px solid var(--primary)}
.final-score-item:last-child{border-bottom:none}
.final-rank{width:2rem;text-align:center;font-weight:700;color:var(--primary)}
.final-name{flex:1;text-align:left;margin-left:.5rem;font-family:var(--font-head)}
.final-pts{font-weight:700;color:var(--primary);font-family:var(--font-head)}

/* â”€â”€ Game Over History â”€â”€ */
.game-over-history{text-align:left;margin-bottom:1.5rem}
.game-over-history-toggle{
  background:none;border:1px solid var(--border);border-radius:var(--radius);
  padding:.5rem 1rem;cursor:pointer;width:100%;text-align:left;
  font-size:.88rem;color:var(--text);display:flex;align-items:center;
  justify-content:space-between;transition:background .2s;
}
.game-over-history-toggle:hover{background:var(--surface2)}
.game-over-history-toggle .toggle-arrow{transition:transform .3s}
.game-over-history-toggle.open .toggle-arrow{transform:rotate(180deg)}
.game-over-history-body{max-height:0;overflow:hidden;transition:max-height .3s ease}
.game-over-history-body.open{max-height:300px;overflow-y:auto}
.game-over-history-body::-webkit-scrollbar{width:3px}
.game-over-history-body::-webkit-scrollbar-thumb{background:var(--text3);border-radius:1px}
.game-over-history-list{list-style:none;padding:0;margin:.5rem 0 0}
.game-over-history-list li{
  display:flex;align-items:center;gap:.5rem;
  padding:.3rem .5rem;border-bottom:1px dotted var(--border);font-size:.82rem;
}
.game-over-history-list li:last-child{border-bottom:none}
.game-over-history-num{color:var(--text2);min-width:1.5rem;text-align:right;font-size:.72rem}
.game-over-history-word{font-family:var(--font-head);font-weight:600;color:var(--text)}
.game-over-history-player{color:var(--text2);font-size:.72rem;margin-left:auto}
.game-over-history-chain{
  font-size:.78rem;color:var(--text2);margin-top:.75rem;
  padding:.4rem .5rem;background:var(--surface2);border-radius:var(--radius);
  border:1px solid var(--border);
}

/* â”€â”€ Share Buttons â”€â”€ */
.share-section{margin-bottom:1.2rem}
.share-section p{font-size:.8rem;color:var(--text2);margin-bottom:.5rem}
.share-buttons{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
.share-btn{
  display:inline-flex;align-items:center;gap:.3rem;
  padding:.4rem .9rem;border-radius:var(--radius);font-size:.82rem;font-weight:600;
  color:#fff;transition:opacity .2s,transform .1s;
}
.share-btn:hover{opacity:.85;transform:scale(1.02)}
.share-btn:active{transform:scale(.97)}
.share-btn-x{background:#2c2420}
.share-btn-line{background:#06c755}
.share-btn-copy{background:var(--primary)}
.share-btn-copy.copied{background:var(--success)}
.share-btn .share-icon{font-size:1rem}

/* â”€â”€ My lives display â”€â”€ */
.my-lives-display{
  display:flex;align-items:center;justify-content:center;
  gap:.5rem;padding:.5rem .8rem;
  margin-bottom:.75rem;border-radius:var(--radius);
  background:var(--surface);border:1px solid var(--border);
}
.my-lives-label{font-size:.8rem;font-weight:600;color:var(--text2)}
.my-lives-hearts{display:flex;gap:.2rem;font-size:1.3rem;transition:all .3s}
.my-lives-hearts .heart{display:inline-block;transition:all .3s}
.my-lives-hearts .heart.lost{filter:grayscale(1);opacity:.25;transform:scale(.8)}
.my-lives-hearts .heart.shake{animation:shake .4s ease}
@keyframes heartBreak{
  0%{transform:scale(1);opacity:1}
  30%{transform:scale(1.2)}
  60%{transform:scale(.5);opacity:.4}
  100%{transform:scale(.8);opacity:.25;filter:grayscale(1)}
}
.my-lives-hearts .heart.breaking{animation:heartBreak .5s ease forwards}

/* â”€â”€ Start button area â”€â”€ */
.start-area{text-align:center;padding:2rem}
.waiting-text{color:var(--text2);font-size:.9rem;margin-bottom:1rem}

/* â”€â”€ Floating score popup â”€â”€ */
.score-popup{
  position:fixed;pointer-events:none;font-family:var(--font-head);
  font-size:1.4rem;font-weight:700;color:var(--success);
  animation:floatUp 1s ease both;z-index:50;
}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:500px){
  .header h1{font-size:2rem}
  .current-word{font-size:2.5rem}
  .form-row{grid-template-columns:1fr}
  .card{padding:1rem}
}

/* â”€â”€ Turn indicator â”€â”€ */
.turn-indicator{
  text-align:center;padding:.55rem .8rem;margin-bottom:.5rem;
  border-radius:var(--radius);font-size:1rem;font-weight:700;
  animation:pulse 2s infinite;
}
.turn-indicator.my-turn{
  background:rgba(194,58,34,.07);color:var(--primary);
  border:1.5px solid var(--primary);
}
.turn-indicator.other-turn{
  background:var(--surface2);color:var(--text2);
  border:1.5px solid var(--border);animation:none;
}
.turn-order-list{
  display:flex;justify-content:center;gap:.4rem;
  margin-top:.3rem;font-size:.78rem;font-weight:400;
}
.turn-order-item{
  padding:.12rem .45rem;border-radius:var(--radius);
  background:var(--surface2);color:var(--text2);border:1px solid var(--border);
}
.turn-order-item.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* â”€â”€ Waiting players â”€â”€ */
.waiting-players{margin-bottom:1.2rem}
.waiting-players h3{font-family:var(--font-head);font-size:.9rem;color:var(--text);margin-bottom:.5rem}
.waiting-player-list{
  list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center;
}
.waiting-player-list li{
  background:var(--surface2);color:var(--text);padding:.25rem .7rem;
  border-radius:var(--radius);font-size:.88rem;font-weight:500;
  display:flex;align-items:center;gap:.3rem;border:1px solid var(--border);
}
.waiting-player-list li .owner-badge{
  font-size:.68rem;background:var(--primary);color:#fff;
  padding:.08rem .35rem;border-radius:var(--radius);
}
.answer-area.disabled input{opacity:.4;pointer-events:none}
.answer-area.disabled button{opacity:.4;pointer-events:none}

/* â”€â”€ Vote UI â”€â”€ */
.vote-overlay{
  position:fixed;inset:0;
  background:rgba(245,240,232,.75);backdrop-filter:blur(5px);
  display:flex;align-items:center;justify-content:center;
  z-index:90;animation:fadeIn .3s ease;
}
.vote-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:2rem;
  text-align:center;max-width:400px;width:90%;
  animation:popIn .35s ease both;
  box-shadow:0 8px 40px rgba(44,36,32,.1);
}
.vote-card h3{font-family:var(--font-head);font-size:1.15rem;color:var(--text);margin-bottom:.5rem}
.vote-card h3::before{display:none}
.vote-word{
  font-family:var(--font-display);font-size:2.2rem;font-weight:400;
  color:var(--text);margin:.75rem 0;letter-spacing:.08em;
}
.vote-question{color:var(--text2);font-size:.88rem;margin-bottom:.8rem}
.vote-buttons{display:flex;gap:.6rem;justify-content:center;margin-bottom:1rem}
.vote-buttons .btn{min-width:110px;font-size:1rem;padding:.65rem 1.2rem}
.btn-accept{background:var(--success);color:#fff}
.btn-accept:hover{background:#2f5548}
.btn-reject{background:var(--danger);color:#fff}
.btn-reject:hover{background:#9a2e1e}
.vote-progress{font-size:.82rem;color:var(--text2)}
.vote-progress-bar{height:3px;background:var(--surface2);border-radius:1px;margin-top:.5rem;overflow:hidden}
.vote-progress-bar-inner{height:100%;background:var(--primary);border-radius:1px;transition:width .3s}
.vote-timer{font-size:.78rem;color:var(--text2);margin-top:.5rem}

/* â”€â”€ Kana Row Checkboxes â”€â”€ */
.kana-row-grid{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.3rem}
.kana-row-chip{
  display:inline-flex;align-items:center;gap:.3rem;
  padding:.3rem .6rem;border-radius:var(--radius);
  background:var(--surface);border:1.5px solid var(--border);
  cursor:pointer;transition:all .2s;font-size:.88rem;
  user-select:none;font-weight:500;
}
.kana-row-chip:hover{border-color:var(--primary);color:var(--primary)}
.kana-row-chip.selected{
  background:var(--primary);color:#fff;border-color:var(--primary-dark);
}
.kana-row-chip input{display:none}
.kana-row-select-all{font-size:.78rem;color:var(--primary);cursor:pointer;text-decoration:underline;margin-left:.5rem}

/* â”€â”€ Vote waiting & rebuttal â”€â”€ */
.vote-waiting{color:var(--text2);font-size:.9rem;padding:.5rem 0}
.rebuttal-area{margin-bottom:1rem}
.rebuttal-label{font-size:.9rem;color:var(--primary);font-weight:600;margin-bottom:.4rem}
.rebuttal-input-row{display:flex;gap:.5rem;align-items:center}
.rebuttal-input{
  flex:1;padding:.5rem .5rem;border-radius:var(--radius);border:1.5px solid var(--border);
  font-size:1rem;background:var(--surface);color:var(--text);
}
.rebuttal-input:focus{border-color:var(--primary);outline:none}
.rebuttal-hint{font-size:.78rem;color:var(--text2);margin-top:.3rem}
.rebuttal-display{
  background:var(--surface);border-left:3px solid var(--primary);
  padding:.5rem .7rem;margin:.6rem 0;border-radius:var(--radius);
  font-size:.9rem;color:var(--text);text-align:left;
}
.rebuttal-display .rebuttal-sender{font-weight:700;color:var(--primary);margin-right:.3rem}

/* â”€â”€ Withdraw â”€â”€ */
.withdraw-area{margin-top:.8rem;text-align:center}
.withdraw-area .btn{font-size:.9rem}

/* â”€â”€ Lobby button tooltip â”€â”€ */
.lobby-btn-wrap{position:relative;display:inline-block}
.lobby-btn-wrap .btn:disabled{opacity:.4;cursor:not-allowed}
.lobby-btn-tooltip{
  display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:var(--text);color:var(--bg);font-size:.72rem;
  padding:.25rem .5rem;border-radius:var(--radius);white-space:nowrap;pointer-events:none;z-index:10;
}
.lobby-btn-tooltip::after{
  content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
  border:4px solid transparent;border-top-color:var(--text);
}
.lobby-btn-wrap:hover .lobby-btn-tooltip{display:block}
.lobby-btn-wrap:not(:has(.btn:disabled)) .lobby-btn-tooltip{display:none!important}

/* â”€â”€ Theme Switcher â”€â”€ */
.theme-switcher{position:fixed;top:12px;right:12px;z-index:200}
.theme-toggle{
  height:30px;border-radius:var(--radius);
  border:1.5px solid var(--border);background:var(--surface);
  font-size:11px;cursor:pointer;transition:all .25s;
  display:flex;align-items:center;justify-content:center;
  padding:0 10px;line-height:1;color:var(--text2);white-space:nowrap;
}
.theme-toggle:hover{border-color:var(--primary);color:var(--primary);transform:scale(1.05)}
.theme-panel{
  position:absolute;top:calc(100% + 8px);right:0;
  transform:scale(.95);transform-origin:top right;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);box-shadow:0 4px 20px rgba(44,36,32,.1);
  padding:8px;min-width:150px;
  opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;
}
.theme-panel.open{opacity:1;pointer-events:auto;transform:scale(1)}
.theme-panel::before{
  content:'';position:absolute;top:-5px;right:12px;transform:rotate(45deg);
  width:10px;height:10px;background:var(--surface);border-top:1px solid var(--border);border-left:1px solid var(--border);
}
.theme-panel-title{
  font-size:.62rem;font-weight:700;color:var(--text3);text-transform:uppercase;
  letter-spacing:.12em;padding:2px 6px 6px;border-bottom:1px solid var(--border);margin-bottom:4px;
}
.theme-btn{
  display:block;width:100%;padding:6px 10px;border:none;
  border-radius:var(--radius);background:transparent;cursor:pointer;
  transition:background .15s;font-size:.82rem;color:var(--text);
  text-align:left;white-space:nowrap;
}
.theme-btn:hover{background:var(--surface2)}
.theme-btn.active{background:rgba(194,58,34,.08);font-weight:600;color:var(--primary)}
</style>
</head>
<body>

<div class="header">
  <h1><a href="/">ã—ã‚Šã¨ã‚Š</a></h1>
  <p>ã“ã¨ã°ã‚’ç¹‹ãã€ã¿ã‚“ãªã§éŠã¶</p>
</div>

<div class="theme-switcher" id="themeSwitcher">
  <button class="theme-toggle" id="themeToggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ãƒ†ãƒ¼ãƒ</button>
  <div class="theme-panel" id="themePanel">
    <div class="theme-panel-title">ãƒ†ãƒ¼ãƒ</div>
    <button class="theme-btn" data-theme="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>
    <button class="theme-btn" data-theme="wamo">å’Œãƒ¢ãƒ€ãƒ³</button>
    <button class="theme-btn" data-theme="neon">ãƒã‚ªãƒ³</button>
    <button class="theme-btn" data-theme="typo">æ´»ç‰ˆ</button>
  </div>
</div>

<!-- â•â•â• LOBBY â•â•â• -->
<div id="lobby" class="container fade-in">
  <div class="player-name-section">
    <div class="player-name-desc">
      <p>åå‰ã‚’å…¥åŠ›ã—ã¦ã€ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    <div class="player-name-field">
      <label for="playerName" class="player-name-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
      <input type="text" id="playerName" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="12" autocomplete="off">
    </div>
  </div>

  <div id="lobbyCreateCard" class="card slide-up">
    <h2>ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</h2>
    <div id="roomCreateSettings">
      <div class="form-group">
        <label>ãƒ«ãƒ¼ãƒ å</label>
        <input type="text" id="roomNameInput" placeholder="æ¥½ã—ã„ã—ã‚Šã¨ã‚Š" maxlength="20">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>æœ€å°‘æ–‡å­—æ•°</label>
          <input type="number" id="minLen" value="1" min="1" max="20">
        </div>
        <div class="form-group">
          <label>æœ€å¤§æ–‡å­—æ•°ï¼ˆ0ï¼åˆ¶é™ãªã—ï¼‰</label>
          <input type="number" id="maxLen" value="0" min="0" max="99">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</label>
          <input type="text" id="genre" placeholder="ä¾‹: é£Ÿã¹ç‰©ã€å‹•ç‰©ã€å›½å..." maxlength="20">
        </div>
        <div class="form-group">
          <label>åˆ¶é™æ™‚é–“</label>
          <select id="timeLimit">
            <option value="0">ãªã—</option>
            <option value="10">10ç§’</option>
            <option value="20">20ç§’</option>
            <option value="30" selected>30ç§’</option>
            <option value="60">60ç§’</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ãƒ©ã‚¤ãƒ•æ•°</label>
          <select id="maxLives">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="form-group"></div>
      </div>
      <div class="form-group">
        <label>ä½¿ç”¨å¯èƒ½ãªè¡Œï¼ˆæœªé¸æŠï¼ã™ã¹ã¦ä½¿ç”¨å¯èƒ½ï¼‰</label>
        <div id="kanaRowCheckboxes" class="kana-row-grid"></div>
      </div>
      <div class="form-group">
        <label class="kana-row-chip" style="display:inline-flex;cursor:pointer">
          <input type="checkbox" id="noDakuten" style="display:inline;width:auto;margin-right:.3rem">
          æ¿éŸ³ãƒ»åŠæ¿éŸ³ç¦æ­¢ï¼ˆãŒããã’ã”ã–ã˜ãšãœãã ã¢ã¥ã§ã©ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ï¼‰
        </label>
      </div>
      <div class="form-group">
        <label class="kana-row-chip" style="display:inline-flex;cursor:pointer">
          <input type="checkbox" id="privateRoom" style="display:inline;width:auto;margin-right:.3rem">
          ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆãƒ­ãƒ“ãƒ¼ã«è¡¨ç¤ºã—ãªã„ï¼‰
        </label>
      </div>
      <div class="lobby-btn-wrap" data-lobby-btn style="display:block">
        <button class="btn btn-primary btn-block" onclick="createRoom()" disabled>ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <span class="lobby-btn-tooltip">ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
      </div>
    </div>
  </div>

  <div id="inviteCard" class="card invite-card slide-up hidden" style="animation-delay:.05s">
    <div class="invite-info">
      <div class="invite-room-title" id="inviteCardTitle">æ‹›å¾…ãƒ«ãƒ¼ãƒ </div>
      <div class="invite-room-rules" id="inviteCardRules"></div>
      <div class="invite-room-host" id="inviteCardHost"></div>
    </div>
    <div class="invite-actions">
      <div class="lobby-btn-wrap" data-lobby-btn>
        <button class="btn btn-primary" onclick="joinInviteRoom()" disabled>å‚åŠ ã™ã‚‹</button>
        <span class="lobby-btn-tooltip">ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
      </div>
      <button class="btn btn-outline" onclick="clearInvite()">ç„¡è¦–</button>
    </div>
  </div>


  <div id="lobbyRoomsCard" class="card slide-up" style="animation-delay:.1s">
    <h2>ãƒ«ãƒ¼ãƒ ä¸€è¦§ <button class="btn btn-outline" style="margin-left:auto;padding:.3rem .8rem;font-size:.8rem" onclick="refreshRooms()">æ›´æ–°</button></h2>
    <ul id="roomList" class="room-list"></ul>
    <div id="noRooms" class="no-rooms">ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </div>
</div>

<!-- â•â•â• GAME ROOM â•â•â• -->
<div id="game" class="container hidden">
  <div class="game-header">
    <div class="room-title" id="gameRoomTitle">ãƒ«ãƒ¼ãƒ </div>
    <div class="game-rules" id="gameRules"></div>
    <div class="game-header-actions">
      <button class="btn btn-outline" style="padding:.35rem .8rem;font-size:.8rem" onclick="copyRoomLink()">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-outline" style="padding:.35rem .8rem;font-size:.8rem" onclick="leaveRoom()">é€€å‡º</button>
    </div>
  </div>

  <!-- Private room invite banner -->
  <div id="privateRoomBanner" class="card hidden" style="background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;text-align:center;padding:1rem 1.2rem;margin-bottom:.7rem">
    <div style="font-size:1.1rem;font-weight:700;margin-bottom:.4rem">ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ </div>
    <div style="font-size:.85rem;margin-bottom:.6rem;opacity:.9">ã“ã®ãƒ«ãƒ¼ãƒ ã¯ãƒ­ãƒ“ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã—ã¦å‹é”ã‚’æ‹›å¾…ã—ã¾ã—ã‚‡ã†ï¼</div>
    <button class="btn" style="background:#fff;color:var(--primary);font-weight:700;padding:.4rem 1.2rem" onclick="copyRoomLink()">ğŸ“ æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>

  <!-- Pre-game / waiting -->
  <div id="preGame" class="card start-area">
    <p class="waiting-text">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>
    <div class="waiting-players">
      <h3>ğŸ‘¥ å‚åŠ è€…</h3>
      <ul id="waitingPlayerList" class="waiting-player-list"></ul>
    </div>
    <button id="startBtn" class="btn btn-accent btn-lg" onclick="startGame()">ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    <p id="waitOwnerText" class="waiting-text hidden">ãƒ«ãƒ¼ãƒ ä½œæˆè€…ã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- Active game -->
  <div id="activeGame" class="hidden">
    <div id="turnIndicator" class="turn-indicator">
      <span id="turnText"></span>
    </div>
    <div class="my-lives-display" id="myLivesDisplay">
      <span class="my-lives-label">ãƒ©ã‚¤ãƒ•</span>
      <div class="my-lives-hearts" id="myLivesHearts"></div>
    </div>

    <div class="current-word-area">
      <div class="current-word-label">ç¾åœ¨ã®ã“ã¨ã°</div>
      <div class="current-word" id="currentWord">ãƒ¼</div>
    </div>

    <div id="timerSection" class="hidden">
      <div class="timer-text" id="timerText">30</div>
      <div class="timer-bar"><div class="timer-bar-inner" id="timerBar"></div></div>
    </div>

    <div class="answer-area">
      <input type="text" id="answerInput" placeholder="ã“ã¨ã°ã‚’å…¥åŠ›â€¦" autocomplete="off">
      <button class="btn btn-primary" onclick="submitAnswer()">é€ä¿¡</button>
      <button class="btn btn-outline" id="challengeBtn" onclick="requestChallenge()">âš ï¸ æŒ‡æ‘˜</button>
    </div>

    <div class="game-body">
      <div class="history-panel card">
        <h2>å±¥æ­´</h2>
        <ul class="history-list" id="historyList"></ul>
      </div>
      <div class="sidebar">
        <div class="card">
          <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
          <ul class="player-list" id="playerList"></ul>
        </div>
        <div class="card">
          <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
          <ul class="messages" id="messageList"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• VOTE OVERLAY â•â•â• -->
<div id="voteOverlay" class="vote-overlay hidden">
  <div class="vote-card">
    <h3 id="voteTitle">ğŸ—³ï¸ æŠ•ç¥¨</h3>
    <p class="vote-question" id="voteQuestion"></p>
    <div class="vote-word" id="voteWord"></div>
    <p class="vote-question" id="voteGenreHint"></p>
    <div id="voteButtonArea" class="vote-buttons">
      <button class="btn btn-accept" onclick="castVote(true)">â­• å­˜åœ¨ã™ã‚‹</button>
      <button class="btn btn-reject" onclick="castVote(false)">âŒ å­˜åœ¨ã—ãªã„</button>
    </div>
    <div id="rebuttalArea" class="rebuttal-area hidden">
      <p class="rebuttal-label">ğŸ’¬ åè«–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã¾ã™ï¼š</p>
      <div class="rebuttal-input-row">
        <input type="text" id="rebuttalInput" class="rebuttal-input" placeholder="åè«–ã‚’å…¥åŠ›â€¦" maxlength="100">
        <button class="btn btn-primary" onclick="sendRebuttal()">é€ä¿¡</button>
      </div>
      <p class="rebuttal-hint">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæŠ•ç¥¨ã«ã¯å‚åŠ ã§ãã¾ã›ã‚“ï¼‰</p>
    </div>
    <div id="rebuttalDisplay" class="rebuttal-display hidden"></div>
    <div id="voteWaiting" class="vote-waiting hidden">æŠ•ç¥¨æ¸ˆã¿ã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•ç¥¨ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</div>
    <div id="withdrawArea" class="withdraw-area hidden">
      <button class="btn btn-outline" id="withdrawBtn" onclick="withdrawChallenge()">ğŸ”™ æŒ‡æ‘˜ã‚’å–ã‚Šä¸‹ã’ã‚‹</button>
    </div>
    <div class="vote-progress">
      <span id="voteProgressText">0 / 0 æŠ•ç¥¨æ¸ˆã¿</span>
      <div class="vote-progress-bar"><div class="vote-progress-bar-inner" id="voteProgressBar" style="width:0%"></div></div>
    </div>
    <div class="vote-timer" id="voteTimer">15ç§’ã§è‡ªå‹•åˆ¤å®š</div>
  </div>
</div>

<!-- â•â•â• GAME OVER OVERLAY â•â•â• -->
<div id="gameOver" class="game-over-overlay hidden">
  <div class="game-over-card">
    <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
    <p class="game-over-reason" id="gameOverReason"></p>
    <ul class="final-scores" id="finalScores"></ul>
    <div class="game-over-history" id="gameOverHistory">
      <button class="game-over-history-toggle" onclick="toggleGameOverHistory(this)">
        <span>ğŸ“œ å±¥æ­´ã‚’è¦‹ã‚‹ï¼ˆ<span id="gameOverHistoryCount">0</span>èªï¼‰</span>
        <span class="toggle-arrow">â–¼</span>
      </button>
      <div class="game-over-history-body" id="gameOverHistoryBody">
        <div class="game-over-history-chain" id="gameOverHistoryChain"></div>
        <ul class="game-over-history-list" id="gameOverHistoryList"></ul>
      </div>
    </div>
    <div class="share-section" id="shareSection" style="display:none">
      <p>ğŸ“¢ çµæœã‚’ã‚·ã‚§ã‚¢</p>
      <div class="share-buttons">
        <button class="share-btn share-btn-x" onclick="shareToX()"><span class="share-icon">ğ•</span> ãƒã‚¹ãƒˆ</button>
        <button class="share-btn share-btn-line" onclick="shareToLINE()"><span class="share-icon">ğŸ’¬</span> LINE</button>
        <button class="share-btn share-btn-copy" id="shareCopyBtn" onclick="shareLink()"><span class="share-icon">ğŸ”—</span> ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <button id="playAgainBtn" class="btn btn-primary btn-lg" onclick="playAgain()" style="margin-right:.5rem">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
    <button class="btn btn-outline btn-lg" onclick="backToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
    <p id="playAgainWait" class="game-over-reason hidden">ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>
  </div>
</div>

<script>
/* ========== STATE ========== */
let ws = null;
let myName = '';
let currentRoomId = '';
let currentSettings = {};
let timerInterval = null;
let timerMax = 0;
let currentTurn = '';
let turnOrder = [];
let roomOwner = '';
let waitingPlayers = [];
let voteTimerInterval = null;
let hasVoted = false;
let isVoteActive = false;
let lastWordPlayer = '';
let kanaRowNames = [];
let currentLives = {};
let maxLives = 3;
let inviteRoomId = '';
let lastShareURL = '';

const $ = id => document.getElementById(id);

/* ========== WEBSOCKET ========== */
function connect() {
  if (ws && ws.readyState <= 1) return;
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    console.log('WS connected');
    refreshRooms();
    send({ type: 'get_genres' });
    document.body.classList.toggle('invite-lobby', !!inviteRoomId && !currentRoomId);
  };
  ws.onclose = () => { console.log('WS closed'); setTimeout(connect, 2000); };
  ws.onerror = e => console.error('WS error', e);
  ws.onmessage = e => handleMessage(JSON.parse(e.data));
}

function getRoomLink(roomId) {
  const url = new URL(window.location.href);
  url.searchParams.set('room', roomId);
  return url.toString();
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (e) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    try {
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    } catch (err) {
      document.body.removeChild(ta);
      return false;
    }
  }
}

function setInviteRoom(roomId) {
  if (!roomId) return;
  inviteRoomId = roomId;
  $('inviteCardTitle').textContent = 'æ‹›å¾…ãƒ«ãƒ¼ãƒ ';
  $('inviteCardRules').innerHTML = '<span class="rule-badge">èª­ã¿è¾¼ã¿ä¸­â€¦</span>';
  $('inviteCardHost').textContent = '';
  $('inviteCard').classList.remove('hidden');
  document.body.classList.add('invite-lobby');
}

function clearInviteRoomInfo() {
  $('inviteCardTitle').textContent = 'æ‹›å¾…ãƒ«ãƒ¼ãƒ ';
  $('inviteCardRules').innerHTML = '<span class="rule-badge">èª­ã¿è¾¼ã¿ä¸­â€¦</span>';
  $('inviteCardHost').textContent = '';
}

function clearInvite() {
  inviteRoomId = '';
  const url = new URL(window.location.href);
  url.searchParams.delete('room');
  window.history.replaceState({}, '', url.toString());
  $('inviteCard').classList.add('hidden');
  clearInviteRoomInfo();
  document.body.classList.remove('invite-lobby');
}

function joinInviteRoom() {
  if (!inviteRoomId) return;
  joinRoom(inviteRoomId);
  $('inviteCard').classList.add('hidden');
  document.body.classList.remove('invite-lobby');
}

function copyRoomLink() {
  if (!currentRoomId) return;
  const link = getRoomLink(currentRoomId);
  copyText(link).then(ok => {
    addMessage(ok ? 'ãƒ«ãƒ¼ãƒ ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ' : 'ãƒ«ãƒ¼ãƒ ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ', ok ? 'success' : 'error');
  });
}

function showPrivateRoomBanner() {
  const banner = $('privateRoomBanner');
  if (banner) banner.classList.remove('hidden');
}

function hidePrivateRoomBanner() {
  const banner = $('privateRoomBanner');
  if (banner) banner.classList.add('hidden');
}

function send(obj) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj));
}

/* ========== MESSAGE HANDLER ========== */
function handleMessage(msg) {
  switch (msg.type) {
    case 'rooms':
      if (!inviteRoomId) renderRoomList(msg.rooms || []);
      break;
    case 'genres': onGenres(msg); break;
    case 'room_joined': onJoined(msg); break;
    case 'player_joined': onPlayerJoined(msg.player); break;
    case 'player_left': onPlayerLeft(msg.player); break;
    case 'player_list': onPlayerList(msg); break;
    case 'game_started': onGameStarted(msg); break;
    case 'word_accepted': onNewWord(msg); break;
    case 'answer_rejected': onInvalid(msg.message); break;
    case 'timer': onTimer(msg.timeLeft); break;
    case 'game_over': onGameOver(msg); break;
    case 'vote_request': onVoteRequest(msg); break;
    case 'vote_update': onVoteUpdate(msg); break;
    case 'vote_result': onVoteResult(msg); break;
    case 'rebuttal': onRebuttal(msg); break;
    case 'challenge_withdrawn': onChallengeWithdrawn(msg); break;
    case 'penalty': onPenalty(msg); break;
    case 'turn_update': onTurnUpdate(msg); break;
    case 'room_state': onJoined(msg); break;
    case 'error': addMessage(msg.message, 'error'); break;
    default: console.log('Unknown message', msg);
  }
}

/* ========== LOBBY ========== */
function refreshRooms() {
  if (inviteRoomId && !currentRoomId) return;
  send({ type: 'get_rooms' });
}

function onGenres(msg) {
  kanaRowNames = msg.kanaRows || [];
  renderKanaRowCheckboxes();
}

function renderKanaRowCheckboxes() {
  const container = $('kanaRowCheckboxes');
  if (!container || !kanaRowNames.length) return;
  container.innerHTML = '';
  kanaRowNames.forEach(name => {
    const label = document.createElement('label');
    label.className = 'kana-row-chip';
    label.innerHTML = `<input type="checkbox" value="${esc(name)}"> ${esc(name)}`;
    label.addEventListener('click', () => {
      setTimeout(() => {
        const cb = label.querySelector('input');
        label.classList.toggle('selected', cb.checked);
      }, 0);
    });
    container.appendChild(label);
  });
}


function getSelectedKanaRows() {
  const checkboxes = document.querySelectorAll('#kanaRowCheckboxes input[type=checkbox]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function renderRoomList(rooms) {
  const list = $('roomList');
  const noRooms = $('noRooms');
  list.innerHTML = '';
  if (!rooms.length) {
    noRooms.classList.remove('hidden');
    return;
  }
  noRooms.classList.add('hidden');
  rooms.forEach(r => {
    const li = document.createElement('li');
    li.className = 'room-item fade-in';
    const statusLabel = r.status === 'playing' ? 'ğŸ® ãƒ—ãƒ¬ã‚¤ä¸­' : 'â³ å¾…æ©Ÿä¸­';
    const genreLabel = r.settings && r.settings.genre ? r.settings.genre : 'ãªã—';
    const playerCount = r.playerCount !== undefined ? r.playerCount : (r.players || 0);
    const roomLink = getRoomLink(r.id);
    li.innerHTML = `
      <div class="room-info">
        <a class="room-name" href="${esc(roomLink)}" onclick="event.preventDefault(); showInviteRoomPreview('${esc(r.id)}');">${esc(r.name)}</a>
        <div class="room-meta">
          <span>ğŸ‘¥ ${playerCount}äºº</span>
          <span>ğŸ·ï¸ ${esc(genreLabel)}</span>
          <span>${statusLabel}</span>
        </div>
      </div>
      <div class="room-actions">
        <div class="lobby-btn-wrap" data-lobby-btn>
          <button class="btn btn-primary" onclick="showInviteRoomPreview('${esc(r.id)}')"
            ${r.status === 'playing' ? 'data-playing disabled' : (!$('playerName').value.trim() ? 'disabled' : '')}>å‚åŠ </button>
          <span class="lobby-btn-tooltip">${r.status === 'playing' ? 'ãƒ—ãƒ¬ã‚¤ä¸­ã§ã™' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'}</span>
        </div>
      </div>`;
    list.appendChild(li);
  });
}

function getName() {
  const name = $('playerName').value.trim();
  if (!name) { $('playerName').focus(); $('playerName').style.borderColor = 'var(--danger)'; return null; }
  $('playerName').style.borderColor = '';
  return name;
}


function createRoom() {
  const name = getName(); if (!name) return;
  myName = name;
  const allowedRows = getSelectedKanaRows();
  const noDakuten = $('noDakuten').checked;
  const isPrivate = $('privateRoom').checked;
  send({
    type: 'create_room', name,
    settings: {
      name: $('roomNameInput').value.trim() || 'ã—ã‚Šã¨ã‚Šãƒ«ãƒ¼ãƒ ',
      minLen: parseInt($('minLen').value) || 1,
      maxLen: parseInt($('maxLen').value) || 0,
      genre: $('genre').value,
      timeLimit: parseInt($('timeLimit').value) || 0,
      maxLives: parseInt($('maxLives').value) || 3,
      allowedRows: allowedRows.length > 0 ? allowedRows : undefined,
      noDakuten: noDakuten || undefined,
      private: isPrivate || undefined
    }
  });
}

function joinRoom(roomId) {
  const name = getName(); if (!name) return;
  myName = name;
  send({ type: 'join', name, roomId });
  const url = new URL(window.location.href);
  url.searchParams.set('room', roomId);
  window.history.replaceState({}, '', url.toString());
  document.body.classList.remove('invite-lobby');
}

function buildRoomBadges(room) {
  const s = room.settings || {};
  let badges = [];
  if (s.private) badges.push('ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ');
  if (room.owner) badges.push(`ğŸ‘‘ ãƒ›ã‚¹ãƒˆ: ${esc(room.owner)}`);
  if (s.genre) badges.push(`ğŸ·ï¸ ${esc(s.genre)}`);
  if (s.minLen > 1) badges.push(`æœ€å°‘${s.minLen}æ–‡å­—`);
  if (s.maxLen > 0) badges.push(`æœ€å¤§${s.maxLen}æ–‡å­—`);
  if (s.timeLimit > 0) badges.push(`â±ï¸ ${s.timeLimit}ç§’`);
  if (s.allowedRows && s.allowedRows.length > 0) badges.push(`ğŸ¯ ${s.allowedRows.map(esc).join('ãƒ»')}`);
  if (s.noDakuten) badges.push('ğŸš« æ¿éŸ³ãƒ»åŠæ¿éŸ³ç¦æ­¢');
  if (s.maxLives || s.maxLives === 0) badges.push(`â¤ï¸ ãƒ©ã‚¤ãƒ•${s.maxLives || 3}`);
  const meta = room.playerCount !== undefined ? `ğŸ‘¥ ${room.playerCount}äºº` : '';
  return [meta, ...badges].filter(Boolean).map(b => `<span class="rule-badge">${b}</span>`).join('');
}

function buildInviteBadges(room) {
  const badges = buildRoomBadges(room);
  return badges || '<span class="rule-badge">ãƒ«ãƒ¼ãƒ«ãªã—</span>';
}

function renderRoomInfo(room) {
  if (!room) return;
  $('gameRoomTitle').textContent = room.name || 'ãƒ«ãƒ¼ãƒ ';
  $('gameRules').innerHTML = buildRoomBadges(room);
}

function renderInviteRoomInfo(room) {
  if (!room) return;
  $('inviteCardTitle').textContent = room.name || 'æ‹›å¾…ãƒ«ãƒ¼ãƒ ';
  $('inviteCardRules').innerHTML = buildInviteBadges(room);
  $('inviteCardHost').textContent = room.owner ? `ãƒ›ã‚¹ãƒˆ: ${room.owner}` : '';
}

function prepareWaitingRoom(room) {
  currentRoomId = room.id || '';
  currentSettings = room.settings || {};
  roomOwner = room.owner || '';
  showView('game');
  $('historyList').innerHTML = '';
  $('playerList').innerHTML = '';
  $('messageList').innerHTML = '';
  waitingPlayers = room.players || [];
  currentLives = {};
  maxLives = currentSettings.maxLives || 3;
  currentTurn = '';
  turnOrder = [];
  isVoteActive = false;
  showActiveGame(false);
  $('playAgainBtn')?.classList.remove('hidden');
  $('playAgainWait')?.classList.add('hidden');
  $('gameOver').classList.add('hidden');
  renderRoomInfo(room);
  renderInviteRoomInfo(room);
  updateWaitingRoom();
}


/* ========== GAME ROOM ========== */
function onJoined(msg) {
  currentRoomId = msg.roomId;
  currentSettings = msg.settings || {};
  roomOwner = msg.owner || '';
  currentLives = msg.lives || {};
  maxLives = msg.maxLives || currentSettings.maxLives || 3;
  showView('game');
  $('gameRoomTitle').textContent = currentSettings.name || 'ãƒ«ãƒ¼ãƒ ';
  renderRules();
  renderPlayers(msg.players || [], msg.scores || {}, currentLives);
  $('historyList').innerHTML = '';
  (msg.history || []).forEach(h => addHistoryItem(h.word, h.player));
  if (msg.turnOrder) turnOrder = msg.turnOrder;
  if (msg.currentTurn) currentTurn = msg.currentTurn;
  // Extract player names from players array
  waitingPlayers = (msg.players || []).map(p => typeof p === 'object' ? p.name : p);
  updateWaitingRoom();
  isVoteActive = false;
  updateMyLives();
  if (msg.currentWord && msg.status === 'playing') {
    showActiveGame(true);
    setCurrentWord(msg.currentWord);
    updateTurnDisplay();
  } else {
    showActiveGame(false);
  }
  $('playAgainBtn')?.classList.remove('hidden');
  $('playAgainWait')?.classList.add('hidden');
  $('gameOver').classList.add('hidden');
  addMessage('ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸ', 'info');
  // Show prominent invite link for private rooms
  if (currentSettings.private) {
    showPrivateRoomBanner();
  } else {
    hidePrivateRoomBanner();
  }
  if (inviteRoomId && inviteRoomId === currentRoomId) {
    clearInvite();
  }
  renderInviteRoomInfo({
    id: currentRoomId,
    name: currentSettings.name || 'ãƒ«ãƒ¼ãƒ ',
    owner: roomOwner,
    playerCount: waitingPlayers.length,
    settings: currentSettings,
    players: waitingPlayers
  });
}

function onPlayerList(msg) {
  if (!currentRoomId) return;
  waitingPlayers = msg.players || [];
  updateWaitingRoom();
  renderInviteRoomInfo({
    id: currentRoomId,
    name: currentSettings.name || 'ãƒ«ãƒ¼ãƒ ',
    owner: roomOwner,
    playerCount: waitingPlayers.length,
    settings: currentSettings,
    players: waitingPlayers
  });
}

function updateWaitingRoom() {
  const list = $('waitingPlayerList');
  if (!list) return;
  list.innerHTML = '';
  if (!waitingPlayers.length) {
    list.innerHTML = '<li class="waiting-empty">å‚åŠ è€…ãªã—</li>';
  } else {
    waitingPlayers.forEach(name => {
      const li = document.createElement('li');
      li.innerHTML = esc(name)
        + (name === roomOwner ? ' <span class="owner-badge">ãƒ›ã‚¹ãƒˆ</span>' : '')
        + (name === myName ? ' ğŸ‘ˆ' : '');
      list.appendChild(li);
    });
  }
  // Show/hide start button based on ownership
  const isOwner = myName === roomOwner;
  $('startBtn').classList.toggle('hidden', !isOwner);
  $('waitOwnerText').classList.toggle('hidden', isOwner);
}

function buildRuleBadges(settings) {
  const s = settings || {};
  let badges = [];
  if (s.private) badges.push('ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ');
  if (s.genre) badges.push(`ğŸ·ï¸ ${esc(s.genre)}`);
  if (s.minLen > 1) badges.push(`æœ€å°‘${s.minLen}æ–‡å­—`);
  if (s.maxLen > 0) badges.push(`æœ€å¤§${s.maxLen}æ–‡å­—`);
  if (s.timeLimit > 0) badges.push(`â±ï¸ ${s.timeLimit}ç§’`);
  if (s.allowedRows && s.allowedRows.length > 0) badges.push(`ğŸ¯ ${s.allowedRows.map(esc).join('ãƒ»')}`);
  if (s.noDakuten) badges.push('ğŸš« æ¿éŸ³ãƒ»åŠæ¿éŸ³ç¦æ­¢');
  if (s.maxLives || s.maxLives === 0) badges.push(`â¤ï¸ ãƒ©ã‚¤ãƒ•${s.maxLives || 3}`);
  return badges.map(b => `<span class="rule-badge">${b}</span>`).join('');
}

function renderRules() {
  const s = currentSettings;
  $('gameRules').innerHTML = buildRuleBadges(s);
  timerMax = s.timeLimit || 0;
}

function showActiveGame(active) {
  $('preGame').classList.toggle('hidden', active);
  $('activeGame').classList.toggle('hidden', !active);
  if (active) $('answerInput').focus();
}

function updateTurnDisplay() {
  const el = $('turnIndicator');
  const txt = $('turnText');
  const isMyTurn = currentTurn === myName;
  el.className = 'turn-indicator ' + (isMyTurn ? 'my-turn' : 'other-turn');
  txt.innerHTML = isMyTurn
    ? 'ğŸ¯ ã‚ãªãŸã®ç•ªã§ã™ï¼'
    : `â³ ${esc(currentTurn)}ã•ã‚“ã®ç•ªã§ã™`;
  // Turn order badges
  if (turnOrder.length > 1) {
    const badges = turnOrder.map(n =>
      `<span class="turn-order-item${n === currentTurn ? ' active' : ''}">${esc(n)}</span>`
    ).join('');
    txt.innerHTML += `<div class="turn-order-list">${badges}</div>`;
  }
  // Enable/disable input
  const area = document.querySelector('.answer-area');
  if (area) area.classList.toggle('disabled', !isMyTurn);
  const input = $('answerInput');
  if (input) {
    input.disabled = !isMyTurn;
    const isFirstWord = $('currentWord').textContent === 'â€•';
    input.placeholder = isMyTurn
      ? (isFirstWord ? 'æœ€åˆã®ã“ã¨ã°ã‚’å…¥åŠ›â€¦' : 'ã“ã¨ã°ã‚’å…¥åŠ›â€¦')
      : `${currentTurn}ã•ã‚“ã®ç•ªã§ã™â€¦`;
    if (isMyTurn) input.focus();
  }
  const challengeBtn = $('challengeBtn');
  if (challengeBtn) {
    const canChallenge = $('currentWord').textContent !== 'â€•' && !isVoteActive && lastWordPlayer !== myName;
    challengeBtn.disabled = !canChallenge;
  }
}

function setCurrentWord(word) {
  const el = $('currentWord');
  el.textContent = word || 'â€•';
  el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
}

function renderPlayers(players, scores, lives) {
  const list = $('playerList');
  list.innerHTML = '';
  let items = [];
  if (Array.isArray(players) && players.length > 0 && typeof players[0] === 'object') {
    items = players.map(p => ({ name: p.name, score: p.score || 0, lives: p.lives !== undefined ? p.lives : maxLives }));
  } else {
    const arr = Array.isArray(players) ? players : Object.keys(players);
    items = arr.map(p => ({ name: p, score: (scores && scores[p]) || 0, lives: (lives && lives[p] !== undefined) ? lives[p] : maxLives }));
  }
  items.sort((a, b) => b.score - a.score);
  items.forEach(p => {
    const li = document.createElement('li');
    li.className = 'player-item';
    if (p.lives <= 0) li.style.opacity = '0.4';
    const heartsStr = p.lives > 0 ? 'â¤ï¸'.repeat(Math.min(p.lives, 10)) : 'ğŸ’€';
    li.innerHTML = `<span class="player-name-display">${esc(p.name)}${p.name === myName ? ' ğŸ‘ˆ' : ''}</span>
      <span class="player-lives">${heartsStr}</span>
      <span class="player-score">${p.score}ç‚¹</span>`;
    list.appendChild(li);
  });
}

function onPlayerJoined(name) {
  addMessage(`${name}ã•ã‚“ãŒå‚åŠ ã—ã¾ã—ãŸ`, 'info');
  // Add to game player list
  const list = $('playerList');
  const exists = [...list.children].some(li => li.querySelector('.player-name-display').textContent.startsWith(name));
  if (!exists) {
    const li = document.createElement('li');
    li.className = 'player-item fade-in';
    li.innerHTML = `<span class="player-name-display">${esc(name)}</span><span class="player-score">0ç‚¹</span>`;
    list.appendChild(li);
  }
  // Update waiting room
  if (!waitingPlayers.includes(name)) waitingPlayers.push(name);
  updateWaitingRoom();
}

function onTurnUpdate(msg) {
  if (msg.turnOrder) turnOrder = msg.turnOrder;
  if (msg.currentTurn) currentTurn = msg.currentTurn;
  if (msg.lives) currentLives = msg.lives;
  if (msg.maxLives) maxLives = msg.maxLives;
  updateTurnDisplay();
  renderPlayers(turnOrder, msg.scores || {}, currentLives);
}

function onPlayerLeft(name) {
  addMessage(`${name}ã•ã‚“ãŒé€€å‡ºã—ã¾ã—ãŸ`, 'error');
  const list = $('playerList');
  [...list.children].forEach(li => {
    if (li.querySelector('.player-name-display').textContent.startsWith(name)) li.remove();
  });
  // Update waiting room
  waitingPlayers = waitingPlayers.filter(n => n !== name);
  updateWaitingRoom();
  if (currentRoomId && waitingPlayers.length === 0) {
    setTimeout(() => {
      if (currentRoomId && waitingPlayers.length === 0) {
        showView('lobby');
        refreshRooms();
      }
    }, 500);
  }
}

function startGame() { send({ type: 'start_game' }); }

function onGameStarted(msg) {
  showActiveGame(true);
  $('historyList').innerHTML = '';
  setCurrentWord(msg.currentWord || msg.firstWord || '');
  if (msg.turnOrder) turnOrder = msg.turnOrder;
  if (msg.currentTurn) currentTurn = msg.currentTurn;
  if (msg.lives) currentLives = msg.lives;
  if (msg.maxLives) maxLives = msg.maxLives;
  isVoteActive = false;
  lastWordPlayer = '';
  updateMyLives();
  updateTurnDisplay();
  // Initialize timer display
  if (msg.timeLimit && msg.timeLimit > 0) {
    timerMax = msg.timeLimit;
    onTimer(msg.timeLimit);
  }
  if (msg.currentTurn === myName) {
    addMessage('ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼æœ€åˆã®ã“ã¨ã°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', 'success');
  } else {
    addMessage(`ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼${esc(msg.currentTurn)}ã•ã‚“ãŒæœ€åˆã®ã“ã¨ã°ã‚’é¸ã³ã¾ã™`, 'success');
  }
  $('playAgainBtn')?.classList.remove('hidden');
  $('playAgainWait')?.classList.add('hidden');
  $('gameOver').classList.add('hidden');
}

function submitAnswer() {
  const input = $('answerInput');
  const word = input.value.trim();
  if (!word) return;
  send({ type: 'answer', word });
  input.value = '';
  input.focus();
}

function onNewWord(msg) {
  setCurrentWord(msg.word);
  lastWordPlayer = msg.player;
  addHistoryItem(msg.word, msg.player);
  if (msg.lives) currentLives = msg.lives;
  if (msg.scores || msg.lives) updateScoresAndLives(msg.scores, msg.lives);
  if (msg.currentTurn) currentTurn = msg.currentTurn;
  updateMyLives();
  updateTurnDisplay();
  addMessage(`${msg.player}ã•ã‚“ãŒæ­£è§£ï¼ã€Œ${msg.word}ã€`, 'success');
  showScorePopup(msg.player);
}

function addHistoryItem(word, player) {
  const list = $('historyList');
  const li = document.createElement('li');
  li.className = 'history-item';
  li.innerHTML = `<span class="history-word">${esc(word)}</span>
    <span class="history-player">${esc(player)}</span>`;
  list.prepend(li);
}

function updateScores(scores) {
  updateScoresAndLives(scores, null);
}

function updateScoresAndLives(scores, lives) {
  if (lives) currentLives = lives;
  const list = $('playerList');
  const playerNames = [...list.children].map(li => li.querySelector('.player-name-display').textContent.replace(' ğŸ‘ˆ', ''));
  const items = playerNames.map(name => ({
    name,
    score: (scores && scores[name] !== undefined) ? scores[name] : (parseInt([...list.children].find(li => li.querySelector('.player-name-display').textContent.replace(' ğŸ‘ˆ', '') === name)?.querySelector('.player-score')?.textContent) || 0),
    lives: (currentLives && currentLives[name] !== undefined) ? currentLives[name] : maxLives
  }));
  items.sort((a, b) => b.score - a.score);
  list.innerHTML = '';
  items.forEach(p => {
    const li = document.createElement('li');
    li.className = 'player-item';
    if (p.lives <= 0) li.style.opacity = '0.4';
    const heartsStr = p.lives > 0 ? 'â¤ï¸'.repeat(Math.min(p.lives, 10)) : 'ğŸ’€';
    li.innerHTML = `<span class="player-name-display">${esc(p.name)}${p.name === myName ? ' ğŸ‘ˆ' : ''}</span>
      <span class="player-lives">${heartsStr}</span>
      <span class="player-score">${p.score}ç‚¹</span>`;
    list.appendChild(li);
  });
}

function onInvalid(reason) {
  addMessage(reason, 'error');
  const input = $('answerInput');
  input.style.animation = 'shake .4s ease';
  input.style.borderColor = 'var(--danger)';
  setTimeout(() => { input.style.animation = ''; input.style.borderColor = ''; }, 500);
}

function onTimer(seconds) {
  const section = $('timerSection');
  section.classList.remove('hidden');
  const text = $('timerText');
  const bar = $('timerBar');
  const pct = timerMax > 0 ? (seconds / timerMax * 100) : 100;
  text.textContent = seconds + 'ç§’';
  bar.style.width = pct + '%';
  text.className = 'timer-text';
  bar.className = 'timer-bar-inner';
  if (seconds <= 5) { text.classList.add('danger'); bar.classList.add('danger'); }
  else if (seconds <= 10) { text.classList.add('warning'); bar.classList.add('warning'); }
}

function onGameOver(msg) {
  const overlay = $('gameOver');
  overlay.classList.remove('hidden');
  let reason = msg.reason || '';
  if (msg.winner) {
    reason = `ğŸ† ${msg.winner}ã•ã‚“ã®å‹åˆ©ï¼` + (msg.loser ? ` (${msg.loser}ã•ã‚“è„±è½)` : '');
  } else if (msg.loser) {
    reason = `${msg.loser}ã•ã‚“ - ${reason}`;
  }
  $('gameOverReason').textContent = reason;
  const list = $('finalScores');
  list.innerHTML = '';
  const scores = msg.scores || {};
  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
  sorted.forEach(([name, score], i) => {
    const li = document.createElement('li');
    li.className = 'final-score-item';
    li.innerHTML = `<span class="final-rank">${medals[i] || (i + 1)}</span>
      <span class="final-name">${esc(name)}</span>
      <span class="final-pts">${score}ç‚¹</span>`;
    list.appendChild(li);
  });
  clearInterval(timerInterval);
  $('timerSection').classList.add('hidden');

  // Render history in game-over card
  const history = msg.history || [];
  $('gameOverHistoryCount').textContent = history.length;
  const hList = $('gameOverHistoryList');
  hList.innerHTML = '';
  history.forEach((h, i) => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="game-over-history-num">${i + 1}.</span>
      <span class="game-over-history-word">${esc(h.word)}</span>
      <span class="game-over-history-player">${esc(h.player)}</span>`;
    hList.appendChild(li);
  });
  // Show word chain summary
  const chain = history.map(h => h.word).join(' â†’ ');
  const chainEl = $('gameOverHistoryChain');
  if (history.length > 0) {
    chainEl.textContent = chain;
    chainEl.style.display = '';
  } else {
    chainEl.style.display = 'none';
  }
  // Reset toggle state (collapsed)
  const body = $('gameOverHistoryBody');
  body.classList.remove('open');
  const toggle = body.previousElementSibling;
  toggle.classList.remove('open');

  // Show share section using server-provided result ID
  lastShareURL = '';
  $('shareSection').style.display = 'none';
  const shareCopyBtn = $('shareCopyBtn');
  shareCopyBtn.classList.remove('copied');
  shareCopyBtn.innerHTML = '<span class="share-icon">\ud83d\udd17</span> \u30ea\u30f3\u30af\u30b3\u30d4\u30fc';

  if (msg.resultId) {
    lastShareURL = location.origin + '/results/' + msg.resultId;
    $('shareSection').style.display = '';
  } else {
    // Fallback: save via API (e.g. if server didn't include resultId)
    saveResultForSharing(msg);
  }
}

async function saveResultForSharing(msg) {
  try {
    const payload = {
      roomName: currentSettings.name || '\u3057\u308a\u3068\u308a',
      genre: currentSettings.genre || '',
      winner: msg.winner || '',
      reason: msg.reason || '',
      scores: msg.scores || {},
      history: msg.history || [],
      lives: msg.lives || {},
    };
    const resp = await fetch('/api/results', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) throw new Error('save failed');
    const data = await resp.json();
    lastShareURL = location.origin + '/results/' + data.id;
    $('shareSection').style.display = '';
  } catch (e) {
    console.error('Failed to save result:', e);
  }
}

function buildShareText(msg) {
  const history = msg || [];
  const words = (typeof history[0] === 'object') ? history.map(h => h.word) : [];
  // Use the stored game-over history from the DOM
  const hList = $('gameOverHistoryList');
  const wordEls = hList.querySelectorAll('.game-over-history-word');
  const ws = Array.from(wordEls).map(el => el.textContent);
  const count = ws.length;

  let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
  // Show chain (truncate for tweet)
  const chain = ws.join(' \u2192 ');
  const maxLen = 200;
  if (chain.length > maxLen) {
    text += chain.substring(0, maxLen) + '\u2026\n';
  } else {
    text += chain + '\n';
  }
  return text;
}

function shareToX() {
  if (!lastShareURL) return;
  const hList = $('gameOverHistoryList');
  const ws = Array.from(hList.querySelectorAll('.game-over-history-word')).map(el => el.textContent);
  const count = ws.length;
  const chain = ws.join(' \u2192 ');
  let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
  // Truncate chain to fit in tweet (280 - url - prefix ~ 200 chars for chain)
  if ([...chain].length > 140) {
    text += [...chain].slice(0, 137).join('') + '\u2026\n';
  } else {
    text += chain + '\n';
  }
  const url = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(lastShareURL)}`;
  window.open(url, '_blank', 'width=550,height=420');
}

function shareToLINE() {
  if (!lastShareURL) return;
  const hList = $('gameOverHistoryList');
  const ws = Array.from(hList.querySelectorAll('.game-over-history-word')).map(el => el.textContent);
  const count = ws.length;
  const chain = ws.join(' \u2192 ');
  let text = `\u3057\u308a\u3068\u308a\u3067${count}\u8a9e\u3064\u306a\u304e\u307e\u3057\u305f\uff01\n`;
  if ([...chain].length > 200) {
    text += [...chain].slice(0, 197).join('') + '\u2026\n';
  } else {
    text += chain + '\n';
  }
  text += lastShareURL;
  const url = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(lastShareURL)}&text=${encodeURIComponent(text)}`;
  window.open(url, '_blank', 'width=550,height=420');
}

async function shareLink() {
  if (!lastShareURL) return;
  try {
    await navigator.clipboard.writeText(lastShareURL);
    const btn = $('shareCopyBtn');
    btn.classList.add('copied');
    btn.innerHTML = '<span class="share-icon">\u2714</span> \u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = '<span class="share-icon">\ud83d\udd17</span> \u30ea\u30f3\u30af\u30b3\u30d4\u30fc';
    }, 2000);
  } catch {
    prompt('\u30ea\u30f3\u30af\u3092\u30b3\u30d4\u30fc:', lastShareURL);
  }
}

function toggleGameOverHistory(btn) {
  btn.classList.toggle('open');
  $('gameOverHistoryBody').classList.toggle('open');
}

function playAgain() {
  if (myName !== roomOwner) {
    $('playAgainBtn')?.classList.add('hidden');
    $('playAgainWait')?.classList.remove('hidden');
    addMessage('ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦', 'info');
    return;
  }
  startGame();
}

function backToLobby() {
  $('gameOver').classList.add('hidden');
  leaveRoom();
}

function leaveRoom() {
  send({ type: 'leave_room' });
  currentRoomId = '';
  hidePrivateRoomBanner();
  showView('lobby');
  refreshRooms();
  document.body.classList.toggle('invite-lobby', !!inviteRoomId);
}

function handleInviteFromURL() {
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room');
  if (roomId) {
    setInviteRoom(roomId);
    loadInviteRoomInfo(roomId, true);
  } else {
    $('inviteCard').classList.add('hidden');
    clearInviteRoomInfo();
    document.body.classList.remove('invite-lobby');
  }
}

function loadInviteRoomInfo(roomId, showPreviewOnly) {
  if (!roomId) return;
  fetch(`/room/${encodeURIComponent(roomId)}`)
    .then(res => res.ok ? res.json() : null)
    .then(data => {
      if (!data) return;
      if (showPreviewOnly) {
        renderInviteRoomInfo(data);
        return;
      }
      prepareWaitingRoom(data);
      renderInviteRoomInfo(data);
    })
    .catch(() => {});
}

function showInviteRoomPreview(roomId) {
  setInviteRoom(roomId);
  const url = new URL(window.location.href);
  url.searchParams.set('room', roomId);
  window.history.replaceState({}, '', url.toString());
  loadInviteRoomInfo(roomId, true);
}

/* ========== MESSAGES ========== */
function addMessage(text, type) {
  const list = $('messageList');
  if (!list) return;
  const li = document.createElement('li');
  li.className = 'msg-item' + (type ? ` msg-${type}` : '');
  const now = new Date();
  const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  li.textContent = `[${ts}] ${text}`;
  list.appendChild(li);
  list.scrollTop = list.scrollHeight;
}

/* ========== UI HELPERS ========== */
function showView(view) {
  $('lobby').classList.toggle('hidden', view !== 'lobby');
  $('game').classList.toggle('hidden', view !== 'game');
  document.body.classList.toggle('invite-view', view === 'game' && !myName);
  document.body.classList.toggle('invite-lobby', view === 'lobby' && !!inviteRoomId);
}

function showScorePopup(player) {
  const el = document.createElement('div');
  el.className = 'score-popup';
  el.textContent = '+1';
  el.style.left = (Math.random() * 60 + 20) + '%';
  el.style.top = '40%';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

/* ========== VOTE ========== */
let currentVotePlayerName = ''; // the challenged player in challenge votes

function onVoteRequest(msg) {
  const isGenre = msg.voteType === 'genre';
  const isChallenge = msg.voteType === 'challenge';
  currentVotePlayerName = isChallenge ? msg.player : '';

  // Determine if this user is the challenged player
  const isChallengedPlayer = isChallenge && msg.player === myName;
  if (isChallenge) {
    hasVoted = (msg.challenger === myName); // challenger auto-voted reject
  } else {
    hasVoted = (msg.player === myName); // submitter auto-voted accept
  }
  $('voteTitle').textContent = isChallenge ? 'ğŸ—³ï¸ å˜èªæŒ‡æ‘˜ã®æŠ•ç¥¨' : 'ğŸ—³ï¸ ã‚¸ãƒ£ãƒ³ãƒ«æŠ•ç¥¨';
  $('voteWord').textContent = msg.word;
  if (isChallenge) {
    $('voteQuestion').textContent = `${msg.challenger}ã•ã‚“ãŒã€Œ${msg.word}ã€ã‚’æŒ‡æ‘˜ã—ã¾ã—ãŸ`;
    $('voteGenreHint').textContent = msg.reason || 'ã“ã®å˜èªã‚’èªã‚ã¾ã™ã‹ï¼Ÿ';
  } else {
    $('voteQuestion').textContent = `${msg.player}ã•ã‚“ãŒã€Œ${msg.word}ã€ã‚’å…¥åŠ›ã—ã¾ã—ãŸ`;
    $('voteGenreHint').textContent = `ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${msg.genre}ã€ã®ãƒªã‚¹ãƒˆã«ãªã„å˜èªã§ã™ã€‚èªã‚ã¾ã™ã‹ï¼Ÿ`;
  }
  updateVoteProgress(msg.voteCount || 0, msg.totalPlayers || 0);
  isVoteActive = true;
  $('voteOverlay').classList.remove('hidden');
  updateTurnDisplay();

  // Reset rebuttal display
  $('rebuttalDisplay').classList.add('hidden');
  $('rebuttalDisplay').innerHTML = '';

  // Determine if this user is the challenger
  const isChallenger = isChallenge && msg.challenger === myName;

  if (isChallengedPlayer) {
    // Challenged player: show rebuttal input instead of vote buttons
    $('voteButtonArea').classList.add('hidden');
    $('voteWaiting').classList.add('hidden');
    $('withdrawArea').classList.add('hidden');
    $('rebuttalArea').classList.remove('hidden');
    $('rebuttalInput').value = '';
    setTimeout(() => $('rebuttalInput').focus(), 100);
  } else if (hasVoted) {
    $('voteButtonArea').classList.add('hidden');
    $('rebuttalArea').classList.add('hidden');
    $('voteWaiting').classList.remove('hidden');
    // Show withdraw button for the challenger
    if (isChallenger) {
      $('withdrawArea').classList.remove('hidden');
    } else {
      $('withdrawArea').classList.add('hidden');
    }
  } else {
    $('voteButtonArea').classList.remove('hidden');
    $('rebuttalArea').classList.add('hidden');
    $('withdrawArea').classList.add('hidden');
    $('voteWaiting').classList.add('hidden');
  }

  // Vote countdown timer
  let voteTimeLeft = 15;
  $('voteTimer').textContent = `${voteTimeLeft}ç§’ã§è‡ªå‹•åˆ¤å®š`;
  clearInterval(voteTimerInterval);
  voteTimerInterval = setInterval(() => {
    voteTimeLeft--;
    if (voteTimeLeft <= 0) {
      clearInterval(voteTimerInterval);
      $('voteTimer').textContent = 'åˆ¤å®šä¸­â€¦';
    } else {
      $('voteTimer').textContent = `${voteTimeLeft}ç§’ã§è‡ªå‹•åˆ¤å®š`;
    }
  }, 1000);
}

function onVoteUpdate(msg) {
  updateVoteProgress(msg.voteCount || 0, msg.totalPlayers || 0);
}

function updateVoteProgress(count, total) {
  $('voteProgressText').textContent = `${count} / ${total} æŠ•ç¥¨æ¸ˆã¿`;
  const pct = total > 0 ? (count / total * 100) : 0;
  $('voteProgressBar').style.width = pct + '%';
}

function onVoteResult(msg) {
  clearInterval(voteTimerInterval);
  isVoteActive = false;
  currentVotePlayerName = '';
  $('voteOverlay').classList.add('hidden');
  $('rebuttalArea').classList.add('hidden');
  $('rebuttalDisplay').classList.add('hidden');
  $('withdrawArea').classList.add('hidden');
  // Reset rebuttal input state
  const rebInput = $('rebuttalInput');
  rebInput.disabled = false;
  rebInput.placeholder = 'åè«–ã‚’å…¥åŠ›â€¦';
  const rebBtn = rebInput.parentElement.querySelector('.btn');
  if (rebBtn) rebBtn.disabled = false;
  if (msg.accepted) {
    addMessage(msg.message || `æŠ•ç¥¨ã«ã‚ˆã‚Šã€Œ${msg.word}ã€ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ`, 'success');
  } else {
    addMessage(msg.message || `æŠ•ç¥¨ã«ã‚ˆã‚Šã€Œ${msg.word}ã€ã¯å´ä¸‹ã•ã‚Œã¾ã—ãŸ`, 'error');
    if (msg.reverted) {
      if (msg.currentWord !== undefined) setCurrentWord(msg.currentWord || '');
      if (msg.history) {
        $('historyList').innerHTML = '';
        (msg.history || []).forEach(h => addHistoryItem(h.word, h.player));
      }
      if (msg.scores || msg.lives) updateScoresAndLives(msg.scores, msg.lives);
      if (msg.currentTurn) currentTurn = msg.currentTurn;
      // Show penalty info for challenge rejection
      if (msg.penaltyPlayer) {
        if (msg.lives) currentLives = msg.lives;
        if (msg.eliminated) {
          addMessage(`ğŸ’€ ${msg.penaltyPlayer}ã•ã‚“ãŒè„±è½ï¼`, 'error');
          if (msg.penaltyPlayer === myName) {
            addMessage('ğŸ’€ ã‚ãªãŸã¯è„±è½ã—ã¾ã—ãŸâ€¦', 'error');
          }
        } else {
          addMessage(`ğŸ’” ${msg.penaltyPlayer}ã•ã‚“ãŒãƒ©ã‚¤ãƒ•-1ï¼æ®‹ã‚Š${msg.penaltyLives}`, 'error');
          if (msg.penaltyPlayer === myName) {
            document.body.style.animation = 'shake .4s ease';
            setTimeout(() => document.body.style.animation = '', 500);
          }
        }
      }
      updateMyLives();
      updateTurnDisplay();
    }
  }
  updateTurnDisplay();
}

function castVote(accept) {
  if (hasVoted) return;
  hasVoted = true;
  send({ type: 'vote', accept });
  $('voteButtonArea').classList.add('hidden');
  $('voteWaiting').classList.remove('hidden');
}

function withdrawChallenge() {
  send({ type: 'withdraw_challenge' });
}

function onChallengeWithdrawn(msg) {
  clearInterval(voteTimerInterval);
  isVoteActive = false;
  currentVotePlayerName = '';
  $('voteOverlay').classList.add('hidden');
  $('rebuttalArea').classList.add('hidden');
  $('rebuttalDisplay').classList.add('hidden');
  $('withdrawArea').classList.add('hidden');
  // Reset rebuttal input state
  const rebInput = $('rebuttalInput');
  rebInput.disabled = false;
  rebInput.placeholder = 'åè«–ã‚’å…¥åŠ›â€¦';
  const rebBtn = rebInput.parentElement.querySelector('.btn');
  if (rebBtn) rebBtn.disabled = false;
  addMessage(msg.message || 'æŒ‡æ‘˜ãŒå–ã‚Šä¸‹ã’ã‚‰ã‚Œã¾ã—ãŸ', 'info');
  updateTurnDisplay();
}

function sendRebuttal() {
  const input = $('rebuttalInput');
  const text = (input.value || '').trim();
  if (!text) return;
  send({ type: 'rebuttal', rebuttal: text });
  input.value = '';
  input.placeholder = 'é€ä¿¡æ¸ˆã¿ âœ“';
  input.disabled = true;
  input.parentElement.querySelector('.btn').disabled = true;
}

function onRebuttal(msg) {
  const display = $('rebuttalDisplay');
  const div = document.createElement('div');
  div.style.marginBottom = '.3rem';
  div.innerHTML = `<span class="rebuttal-sender">${esc(msg.player)}:</span> ${esc(msg.rebuttal)}`;
  display.appendChild(div);
  display.classList.remove('hidden');
  addMessage(`ğŸ’¬ ${msg.player}ã®åè«–: ${msg.rebuttal}`, 'info');
}

function onPenalty(msg) {
  if (msg.allLives) currentLives = msg.allLives;
  updateScoresAndLives(null, msg.allLives);
  updateMyLives(msg.player === myName);
  
  const livesLeft = msg.lives !== undefined ? msg.lives : '?';
  if (msg.eliminated) {
    addMessage(`ğŸ’€ ${msg.player}ã•ã‚“ãŒè„±è½ï¼ã€Œ${msg.reason}ã€`, 'error');
    if (msg.player === myName) {
      addMessage('ğŸ’€ ã‚ãªãŸã¯è„±è½ã—ã¾ã—ãŸâ€¦', 'error');
    }
  } else {
    addMessage(`ğŸ’” ${msg.player}ã•ã‚“ãŒãƒ©ã‚¤ãƒ•-1ï¼æ®‹ã‚Š${livesLeft} ã€Œ${msg.reason}ã€`, 'error');
    if (msg.player === myName) {
      document.body.style.animation = 'shake .4s ease';
      setTimeout(() => document.body.style.animation = '', 500);
    }
  }
}

/* ========== MY LIVES DISPLAY ========== */
function updateMyLives(animate) {
  const container = $('myLivesHearts');
  if (!container) return;
  const myLivesCount = (currentLives && currentLives[myName] !== undefined) ? currentLives[myName] : maxLives;
  container.innerHTML = '';
  for (let i = 0; i < maxLives; i++) {
    const span = document.createElement('span');
    span.className = 'heart';
    if (i < myLivesCount) {
      span.textContent = 'â¤ï¸';
    } else {
      span.textContent = 'ğŸ¤';
      span.classList.add('lost');
      // Animate the most recently lost heart
      if (animate && i === myLivesCount) {
        span.classList.add('breaking');
      }
    }
    container.appendChild(span);
  }
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function requestChallenge() {
  if (isVoteActive) return;
  if (lastWordPlayer === myName) {
    addMessage('è‡ªåˆ†ã®å˜èªã«ã¯æŒ‡æ‘˜ã§ãã¾ã›ã‚“', 'error');
    return;
  }
  send({ type: 'challenge' });
}

/* ========== KEYBOARD ========== */
$('answerInput')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); submitAnswer(); }
});
$('rebuttalInput')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); sendRebuttal(); }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !$('lobby').classList.contains('hidden')) {
    return;
  }
});

/* ========== INIT ========== */
connect();
handleInviteFromURL();
window.addEventListener('popstate', handleInviteFromURL);
// Refresh rooms periodically
setInterval(() => {
  if (!$('lobby').classList.contains('hidden')) refreshRooms();
}, 5000);

// Toggle lobby buttons based on playerName input
function updateLobbyButtons() {
  const hasName = $('playerName').value.trim().length > 0;
  document.querySelectorAll('[data-lobby-btn] .btn').forEach(btn => {
    // Don't touch buttons disabled for other reasons (e.g. playing rooms)
    if (btn.hasAttribute('data-playing')) return;
    if (hasName) {
      btn.removeAttribute('disabled');
    } else {
      btn.setAttribute('disabled', '');
    }
  });
}
$('playerName').addEventListener('input', updateLobbyButtons);
updateLobbyButtons();

// â”€â”€ Theme Switcher â”€â”€
(function initThemeSwitcher() {
  var current = localStorage.getItem('shiritori-theme') || 'default';
  var btns = document.querySelectorAll('.theme-btn');
  var cssLink = document.getElementById('themeCSS');
  var toggle = document.getElementById('themeToggle');
  var panel = document.getElementById('themePanel');

  function applyTheme(name) {
    document.documentElement.setAttribute('data-theme', name);
    localStorage.setItem('shiritori-theme', name);
    if (name === 'default') {
      cssLink.href = '';
    } else {
      cssLink.href = '/static/themes/' + name + '.css';
    }
    btns.forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-theme') === name);
    });
  }

  // Init active state
  btns.forEach(function(b) {
    if (b.getAttribute('data-theme') === current) b.classList.add('active');
    b.addEventListener('click', function() {
      applyTheme(this.getAttribute('data-theme'));
      panel.classList.remove('open');
    });
  });

  // Toggle panel
  toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    panel.classList.toggle('open');
  });

  // Close on outside click
  document.addEventListener('click', function(e) {
    if (!panel.contains(e.target) && e.target !== toggle) {
      panel.classList.remove('open');
    }
  });
})();

</script>
</body>
</html>
