<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>しりとり - マルチプレイヤー</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Antique&family=Shippori+Mincho:wght@400;700&family=Zen+Maru+Gothic:wght@400;500;700&family=DotGothic16&family=RocknRoll+One&family=Kosugi+Maru&family=Shippori+Mincho+B1:wght@400;700&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link id="themeCSS" rel="stylesheet" href="" />
    <script>
      (function () {
        var t = localStorage.getItem("shiritori-theme") || "default";
        document.documentElement.setAttribute("data-theme", t);
        if (t !== "default") {
          document.getElementById("themeCSS").href =
            "/static/themes/" + t + ".css";
        }
      })();
    </script>
    <link rel="stylesheet" href="/static/game.css" />
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="header">
      <h1><a href="/">しりとり</a></h1>
      <p>ことばを繋ぐ、みんなで遊ぶ</p>
    </div>

    <div class="theme-switcher" id="themeSwitcher">
      <button class="theme-toggle" id="themeToggle" aria-label="テーマ切替">
        テーマ
      </button>
      <div class="theme-panel" id="themePanel">
        <div class="theme-panel-title">テーマ</div>
        <button class="theme-btn" data-theme="default">デフォルト</button>
        <button class="theme-btn" data-theme="wamo">和モダン</button>
        <button class="theme-btn" data-theme="neon">ネオン</button>
        <button class="theme-btn" data-theme="typo">活版</button>
      </div>
    </div>

    <!-- ═══ LOBBY ═══ -->
    <div id="lobby" class="container fade-in">
      <div class="player-name-section">
        <div class="player-name-desc">
          <p>
            名前を入力して、ルームに参加するか、新しいルームを作成してください。
          </p>
        </div>
        <div class="player-name-field">
          <label for="playerName" class="player-name-label">ユーザー名</label>
          <input
            type="text"
            id="playerName"
            placeholder="名前を入力"
            maxlength="12"
            autocomplete="off"
          />
        </div>
      </div>

      <div id="lobbyCreateCard" class="card slide-up">
        <h2>ルームを作る</h2>
        <div class="create-room-layout">
          <div id="roomCreateSettings">
            <div class="form-group">
              <label>ルーム名</label>
              <input
                type="text"
                id="roomNameInput"
                placeholder="楽しいしりとり"
                maxlength="20"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>最少文字数</label>
                <input type="number" id="minLen" value="1" min="1" max="20" />
              </div>
              <div class="form-group">
                <label>最大文字数（0＝制限なし）</label>
                <input type="number" id="maxLen" value="0" min="0" max="99" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ジャンル（自由入力）</label>
                <input
                  type="text"
                  id="genre"
                  placeholder="例: 食べ物、動物、国名..."
                  maxlength="20"
                />
              </div>
              <div class="form-group">
                <label>制限時間</label>
                <select id="timeLimit">
                  <option value="0">なし</option>
                  <option value="10">10秒</option>
                  <option value="20">20秒</option>
                  <option value="30" selected>30秒</option>
                  <option value="60">60秒</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ライフ数</label>
                <select id="maxLives">
                  <option value="1">❤️</option>
                  <option value="2">❤️❤️</option>
                  <option value="3" selected>❤️❤️❤️</option>
                  <option value="5">❤️❤️❤️❤️❤️</option>
                  <option value="10">❤️×10</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            <div class="form-group">
              <label>使用可能な行（未選択＝すべて使用可能）</label>
              <div id="kanaRowCheckboxes" class="kana-row-grid"></div>
            </div>
            <div class="form-group">
              <label
                class="kana-row-chip"
                style="display: inline-flex; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="noDakuten"
                  style="display: inline; width: auto; margin-right: 0.3rem"
                />
                濁音・半濁音禁止（がぎぐげござじずぜぞだぢづでどばびぶべぼぱぴぷぺぽ）
              </label>
            </div>
            <div class="form-group">
              <label
                class="kana-row-chip"
                style="display: inline-flex; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="privateRoom"
                  style="display: inline; width: auto; margin-right: 0.3rem"
                />
                🔒 プライベートルーム（ロビーに表示しない）
              </label>
            </div>
            <div class="lobby-btn-wrap" data-lobby-btn style="display: block">
              <button
                class="btn btn-primary btn-block"
                onclick="createRoom()"
                disabled
              >
                ルームを作成
              </button>
              <span class="lobby-btn-tooltip"
                >ユーザー名を入力してください</span
              >
            </div>
          </div>
          <div class="rules-panel">
            <table class="rules-table">
              <tbody>
                <tr>
                  <td>「ん」で終了</td>
                  <td class="rules-val">ライフ −1</td>
                </tr>
                <tr>
                  <td>同じ単語</td>
                  <td class="rules-val">ライフ −1</td>
                </tr>
                <tr>
                  <td>制限時間超過</td>
                  <td class="rules-val">ライフ −1</td>
                </tr>
                <tr>
                  <td>ライフ 0</td>
                  <td class="rules-val rules-danger">敗北</td>
                </tr>
              </tbody>
            </table>
            <p class="rules-desc">
              最後まで生き残ったプレイヤーの勝利。言葉の知識と反射神経が試される。
            </p>
          </div>
        </div>
        <!-- /.create-room-layout -->
      </div>

      <div
        id="inviteCard"
        class="card invite-card slide-up hidden"
        style="animation-delay: 0.05s"
      >
        <div class="invite-info">
          <div class="invite-room-title" id="inviteCardTitle">招待ルーム</div>
          <div class="invite-room-rules" id="inviteCardRules"></div>
          <div class="invite-room-host" id="inviteCardHost"></div>
        </div>
        <div class="invite-actions">
          <div class="lobby-btn-wrap" data-lobby-btn>
            <button class="btn btn-primary" onclick="joinInviteRoom()" disabled>
              参加する
            </button>
            <span class="lobby-btn-tooltip">ユーザー名を入力してください</span>
          </div>
          <button class="btn btn-outline" onclick="clearInvite()">無視</button>
        </div>
      </div>

      <div
        id="lobbyRoomsCard"
        class="card slide-up"
        style="animation-delay: 0.1s"
      >
        <h2>
          ルーム一覧
          <button
            class="btn btn-outline"
            style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem"
            onclick="refreshRooms()"
          >
            更新
          </button>
        </h2>
        <ul id="roomList" class="room-list"></ul>
        <div id="noRooms" class="no-rooms">
          現在アクティブなルームはありません
        </div>
      </div>
    </div>

    <!-- ═══ GAME ROOM ═══ -->
    <div id="game" class="container hidden">
      <div class="game-header">
        <div class="room-title" id="gameRoomTitle">ルーム</div>
        <div class="game-rules" id="gameRules"></div>
        <div class="game-header-actions">
          <button
            class="share-btn share-btn-x"
            style="padding: 0.3rem 0.6rem; font-size: 0.75rem"
            onclick="shareRoomToX()"
          >
            <span class="share-icon">𝕏</span>
          </button>
          <button
            class="share-btn share-btn-line"
            style="padding: 0.3rem 0.6rem; font-size: 0.75rem"
            onclick="shareRoomToLINE()"
          >
            <span class="share-icon">💬</span>
          </button>
          <button
            class="btn btn-outline"
            style="padding: 0.35rem 0.8rem; font-size: 0.8rem"
            onclick="copyRoomLink()"
          >
            🔗 コピー
          </button>
          <button
            class="btn btn-outline"
            style="padding: 0.35rem 0.8rem; font-size: 0.8rem"
            onclick="leaveRoom()"
          >
            退出
          </button>
        </div>
      </div>

      <!-- Pre-game / waiting -->
      <div id="preGame" class="card start-area">
        <p class="waiting-text">プレイヤーを待っています…</p>
        <div class="waiting-players">
          <h3>👥 参加者</h3>
          <ul id="waitingPlayerList" class="waiting-player-list"></ul>
        </div>
        <button
          id="startBtn"
          class="btn btn-accent btn-lg"
          onclick="startGame()"
        >
          🎮 ゲーム開始
        </button>
        <p id="waitOwnerText" class="waiting-text hidden">
          ルーム作成者の開始を待っています…
        </p>
      </div>

      <!-- Active game -->
      <div id="activeGame" class="hidden">
        <div id="turnIndicator" class="turn-indicator">
          <span id="turnText"></span>
        </div>
        <div class="my-lives-display" id="myLivesDisplay">
          <span class="my-lives-label">ライフ</span>
          <div class="my-lives-hearts" id="myLivesHearts"></div>
        </div>

        <div class="current-word-area">
          <div class="current-word-label">現在のことば</div>
          <div class="current-word" id="currentWord">ー</div>
        </div>

        <div id="timerSection" class="hidden">
          <div class="timer-text" id="timerText">30</div>
          <div class="timer-bar">
            <div class="timer-bar-inner" id="timerBar"></div>
          </div>
        </div>

        <div class="answer-area">
          <input
            type="text"
            id="answerInput"
            placeholder="ことばを入力…"
            autocomplete="off"
            lang="ja"
            style="ime-mode: active;"
          />
          <button class="btn btn-primary" onclick="submitAnswer()">送信</button>
          <button
            class="btn btn-outline"
            id="challengeBtn"
            onclick="requestChallenge()"
          >
            ⚠️ 指摘
          </button>
        </div>

        <div class="game-body">
          <div class="history-panel card">
            <h2>履歴</h2>
            <ul class="history-list" id="historyList"></ul>
          </div>
          <div class="sidebar">
            <div class="card">
              <h2>プレイヤー</h2>
              <ul class="player-list" id="playerList"></ul>
            </div>
            <div class="card">
              <h2>メッセージ</h2>
              <ul class="messages" id="messageList"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ VOTE OVERLAY ═══ -->
    <div id="voteOverlay" class="vote-overlay hidden">
      <div class="vote-card">
        <h3 id="voteTitle">🗳️ 投票</h3>
        <p class="vote-question" id="voteQuestion"></p>
        <div class="vote-word" id="voteWord"></div>
        <p class="vote-question" id="voteGenreHint"></p>
        <div id="voteButtonArea" class="vote-buttons">
          <button class="btn btn-accept" onclick="castVote(true)">
            ⭕ 存在する
          </button>
          <button class="btn btn-reject" onclick="castVote(false)">
            ❌ 存在しない
          </button>
        </div>
        <div id="rebuttalArea" class="rebuttal-area hidden">
          <p class="rebuttal-label">💬 反論メッセージを送れます：</p>
          <div class="rebuttal-input-row">
            <input
              type="text"
              id="rebuttalInput"
              class="rebuttal-input"
              placeholder="反論を入力…"
              maxlength="100"
            />
            <button class="btn btn-primary" onclick="sendRebuttal()">
              送信
            </button>
          </div>
          <p class="rebuttal-hint">
            他のプレイヤーに表示されます（投票には参加できません）
          </p>
        </div>
        <div id="rebuttalDisplay" class="rebuttal-display hidden"></div>
        <div id="voteWaiting" class="vote-waiting hidden">
          投票済み。他のプレイヤーの投票を待っています…
        </div>
        <div id="withdrawArea" class="withdraw-area hidden">
          <button
            class="btn btn-outline"
            id="withdrawBtn"
            onclick="withdrawChallenge()"
          >
            🔙 指摘を取り下げる
          </button>
        </div>
        <div class="vote-progress">
          <span id="voteProgressText">0 / 0 投票済み</span>
          <div class="vote-progress-bar">
            <div
              class="vote-progress-bar-inner"
              id="voteProgressBar"
              style="width: 0%"
            ></div>
          </div>
        </div>
        <div class="vote-timer" id="voteTimer">15秒で自動判定</div>
      </div>
    </div>

    <!-- ═══ GAME OVER OVERLAY ═══ -->
    <div id="gameOver" class="game-over-overlay hidden">
      <div class="game-over-card">
        <h2>ゲーム終了！</h2>
        <p class="game-over-reason" id="gameOverReason"></p>
        <ul class="final-scores" id="finalScores"></ul>
        <div class="game-over-history" id="gameOverHistory">
          <button
            class="game-over-history-toggle"
            onclick="toggleGameOverHistory(this)"
          >
            <span
              >📜 履歴を見る（<span id="gameOverHistoryCount">0</span>語）</span
            >
            <span class="toggle-arrow">▼</span>
          </button>
          <div class="game-over-history-body" id="gameOverHistoryBody">
            <div
              class="game-over-history-chain"
              id="gameOverHistoryChain"
            ></div>
            <ul class="game-over-history-list" id="gameOverHistoryList"></ul>
          </div>
        </div>
        <div class="share-section" id="shareSection" style="display: none">
          <p>📢 結果をシェア</p>
          <div class="share-buttons">
            <button class="share-btn share-btn-x" onclick="shareToX()">
              <span class="share-icon">𝕏</span> ポスト
            </button>
            <button class="share-btn share-btn-line" onclick="shareToLINE()">
              <span class="share-icon">💬</span> LINE
            </button>
            <button
              class="share-btn share-btn-copy"
              id="shareCopyBtn"
              onclick="shareLink()"
            >
              <span class="share-icon">🔗</span> リンクコピー
            </button>
          </div>
        </div>
        <div class="game-over-settings" id="gameOverSettings" style="display:none">
          <button class="game-over-settings-toggle" onclick="toggleGameOverSettings(this)">
            <span>⚙️ ルール変更 <span class="game-over-settings-changed" id="settingsChangedBadge">✏️ 変更あり</span></span>
            <span class="toggle-arrow">▼</span>
          </button>
          <div class="game-over-settings-body" id="gameOverSettingsBody">
            <div class="form-row">
              <div class="form-group">
                <label>最少文字数</label>
                <input type="number" id="goMinLen" min="1" max="20" />
              </div>
              <div class="form-group">
                <label>最大文字数（0＝制限なし）</label>
                <input type="number" id="goMaxLen" min="0" max="99" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ジャンル（自由入力）</label>
                <input type="text" id="goGenre" placeholder="例: 食べ物、動物…" maxlength="20" />
              </div>
              <div class="form-group">
                <label>制限時間</label>
                <select id="goTimeLimit">
                  <option value="0">なし</option>
                  <option value="10">10秒</option>
                  <option value="20">20秒</option>
                  <option value="30">30秒</option>
                  <option value="60">60秒</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ライフ数</label>
                <select id="goMaxLives">
                  <option value="1">❤️</option>
                  <option value="2">❤️❤️</option>
                  <option value="3">❤️❤️❤️</option>
                  <option value="5">❤️❤️❤️❤️❤️</option>
                  <option value="10">❤️×10</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            <div class="form-group">
              <label>使用可能な行（未選択＝すべて）</label>
              <div id="goKanaRowCheckboxes" class="kana-row-grid"></div>
            </div>
            <div class="form-group">
              <label class="kana-row-chip" style="display:inline-flex;cursor:pointer">
                <input type="checkbox" id="goNoDakuten" style="display:inline;width:auto;margin-right:0.3rem" />
                濁音・半濁音禁止
              </label>
            </div>
          </div>
        </div>
        <button
          id="playAgainBtn"
          class="btn btn-primary btn-lg"
          onclick="playAgain()"
          style="margin-right: 0.5rem"
        >
          🔄 もう一度
        </button>
        <button class="btn btn-outline btn-lg" onclick="backToLobby()">
          🏠 ロビーへ
        </button>
        <p id="playAgainWait" class="game-over-reason hidden">
          ホストの開始を待っています…
        </p>
      </div>
    </div>


    <script src="/static/game.js"></script>
  </body>
</html>
